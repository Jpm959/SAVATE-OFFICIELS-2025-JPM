<!DOCTYPE html>
Action: file_editor view /app/SAVATE-PART-01
Observation: /app/SAVATE-PART-01:
1|            margin-top: 40px;
2|        }
3|
4|        .feature-card {
5|            background: linear-gradient(135deg, rgba(0,85,164,0.05) 0%, rgba(255,255,255,1) 100%);
6|            padding: 30px;
7|            border-radius: 20px;
8|            border: 2px solid rgba(0,85,164,0.15);
9|            transition: all 0.3s ease;
10|        }
11|
12|        .feature-card:hover {
13|            transform: translateY(-8px);
14|            box-shadow: 0 15px 40px rgba(0,85,164,0.2);
15|            border-color: #0055A4;
16|        }
17|
18|        .feature-card h4 {
19|            color: #0055A4;
20|            font-size: 20px;
21|            margin-bottom: 15px;
22|            font-weight: 700;
23|        }
24|
25|        .feature-list {
26|            list-style: none;
27|            color: #555;
28|            line-height: 2;
29|            font-size: 15px;
30|            text-align: left;
31|        }
32|
33|        .feature-list li::before {
34|            content: '‚úì ';
35|            color: #27ae60;
36|            font-weight: bold;
37|            margin-right: 8px;
38|        }
39|
40|        .fighters-section {
41|            display: flex;
42|            justify-content: space-between;
43|            margin-bottom: 20px;
44|            gap: 20px;
45|        }
46|        
47|        .fighter-info {
48|            flex: 1;
49|            padding: 15px;
50|            border-radius: 5px;
51|        }
52|        
53|        .fighter-info.red {
54|            background-color: #ffcdd2;
55|            border: 2px solid #d32f2f;
56|        }
57|        
58|        .fighter-info.blue {
59|            background-color: #bbdefb;
60|            border: 2px solid #1976d2;
61|        }
62|        
63|        .fighter-info h3 {
64|            margin: 0 0 10px 0;
65|            text-align: center;
66|            font-size: 14px;
67|        }
68|        
69|        .fighter-info input {
70|            width: 100%;
71|            padding: 8px;
72|            border: 1px solid #ddd;
73|            border-radius: 3px;
74|            box-sizing: border-box;
75|        }
76|
77|        .judge-info {
78|            margin-bottom: 20px;
79|            padding: 15px;
80|            background-color: #f8f9fa;
81|            border-radius: 5px;
82|        }
83|        
84|        .judge-info label {
85|            display: inline-block;
86|            width: 100px;
87|            font-weight: bold;
88|        }
89|        
90|        .judge-info input {
91|            width: 300px;
92|            padding: 5px;
93|            border: 1px solid #ddd;
94|            border-radius: 3px;
95|        }
96|
97|        .export-section {
98|            background: linear-gradient(135deg, rgba(33,150,243,0.1) 0%, rgba(21,101,192,0.1) 100%);
99|            border-radius: 15px;
100|            padding: 30px;
101|            margin: 20px 0;
102|        }
103|        
104|        .export-options {
105|            display: grid;
106|            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
107|            gap: 20px;
108|            margin-top: 20px;
109|        }
110|        
111|        .export-card {
112|            background: white;
113|            border-radius: 10px;
114|            padding: 20px;
115|            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
116|            text-align: center;
117|            transition: transform 0.3s ease;
118|        }
119|        
120|        .export-card:hover {
121|            transform: translateY(-5px);
122|        }
123|
124|        .reset-modal {
125|            position: fixed;
126|            top: 0;
127|            left: 0;
128|            right: 0;
129|            bottom: 0;
130|            background: rgba(0, 0, 0, 0.7);
131|            display: flex;
132|            justify-content: center;
133|            align-items: center;
134|            z-index: 1001;
135|            backdrop-filter: blur(5px);
136|        }
137|
138|        .reset-modal-content {
139|            background: white;
140|            border-radius: 20px;
141|            padding: 40px;
142|            max-width: 600px;
143|            width: 90%;
144|            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
145|            text-align: center;
146|            position: relative;
147|            animation: modalFadeIn 0.3s ease-out;
148|        }
149|
150|        .reset-option {
151|            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
152|            border: 3px solid #ddd;
153|            border-radius: 15px;
154|            padding: 25px;
155|            margin: 15px 0;
156|            cursor: pointer;
157|            transition: all 0.3s ease;
158|            text-align: left;
159|        }
160|
161|        .reset-option:hover {
162|            border-color: #667eea;
163|            transform: translateY(-2px);
164|            box-shadow: 0 8px 25px rgba(102,126,234,0.3);
165|        }
166|
167|        .modal-close {
168|            position: absolute;
169|            top: 15px;
170|            right: 20px;
171|            background: none;
172|            border: none;
173|            font-size: 30px;
174|            cursor: pointer;
175|            color: #999;
176|            padding: 0;
177|            width: 40px;
178|            height: 40px;
179|        }
180|
181|        .hidden {
182|            display: none !important;
183|        }
184|        
185|        /* Responsive am√©lior√© */
186|        @media (max-width: 768px) {
187|            body {
188|                padding: 10px;
189|            }
190|            
191|            .app-container {
192|                padding: 20px;
193|            }
194|            
195|            .app-header {
196|                padding: 30px 20px;
197|            }
198|            
199|            .app-title {
200|                font-size: 28px;
201|            }
202|            
203|            .role-buttons {
204|                flex-direction: column;
205|                align-items: center;
206|            }
207|            
208|            .role-button {
209|                min-width: 250px;
210|            }
211|            
212|            .savate-logo {
213|                width: 250px;
214|                height: 180px;
215|            }
216|
217|            .fighters-section {
218|                flex-direction: column;
219|            }
220|        }
221|        
222|        /* Animations */
223|        @keyframes pulse {
224|            0%, 100% { transform: scale(1); opacity: 1; }
225|            50% { transform: scale(1.05); opacity: 0.9; }
226|        }
227|
228|        @keyframes blink {
229|            0% { opacity: 1; }
230|            50% { opacity: 0.6; }
231|            100% { opacity: 1; }
232|        }
233|        
234|        @keyframes updateFlash {
235|            0% { background-color: rgba(243,156,18,0.1); }
236|            50% { background-color: rgba(243,156,18,0.3); }
237|            100% { background-color: rgba(243,156,18,0.1); }
238|        }
239|        
240|        @keyframes fadeIn {
241|            from { opacity: 0; transform: translateY(20px); }
242|            to { opacity: 1; transform: translateY(0); }
243|        }
244|        
245|        .fade-in {
246|            animation: fadeIn 0.5s ease-out;
247|        }
248|
249|        @keyframes modalFadeIn {
250|            from {
251|                opacity: 0;
252|                transform: scale(0.8) translateY(-50px);
253|            }
254|            to {
255|                opacity: 1;
256|                transform: scale(1) translateY(0);
257|            }
258|        }
259|    
260|    </style>
261|</head>
262|<body>
263|
264|    <!-- Enhanced Sync Indicator -->
265|    <div class="sync-indicator hidden" id="syncIndicator">
266|        <span id="syncIcon">‚ö°</span>
267|        <span id="syncStatus">Initialisation...</span>
268|        <span class="sync-devices-count" id="devicesCount">0 appareils</span>
269|    </div>
270|
271|    <div class="app-container">
272|        <div class="app-header">
273|            <h1>ü•ä SAVATE OFFICIALS - Interface CPTE Compl√®te</h1>
274|            <p>Syst√®me Professionnel avec Interface CPTE Avanc√©e - WebRTC P2P + Monitoring</p>
275|            <small>Synchronisation Temps R√©el ‚Ä¢ Interface CPTE Conforme ‚Ä¢ Export & Sauvegarde</small>
276|        </div>
277|        
278|        <!-- Role Selection -->
279|        <div class="role-selector fade-in" id="roleSelector">
280|            <h2>üé≠ S√©lectionnez votre r√¥le</h2>
281|            
282|            <!-- Logo SAVATE OFFICIALS -->
283|            <div class="savate-logo">
284|                <!-- Quadrillage rouge horizontal -->
285|                <div class="grid-line-red"></div>
286|                <div class="grid-line-red"></div>
287|                <div class="grid-line-red"></div>
288|                <div class="grid-line-red"></div>
289|                <div class="grid-line-red"></div>
290|                <div class="grid-line-red"></div>
291|                <div class="grid-line-red"></div>
292|                
293|                <!-- Quadrillage bleu vertical -->
294|                <div class="grid-line-blue"></div>
295|                <div class="grid-line-blue"></div>
296|                <div class="grid-line-blue"></div>
297|                <div class="grid-line-blue"></div>
298|                <div class="grid-line-blue"></div>
299|                <div class="grid-line-blue"></div>
300|                <div class="grid-line-blue"></div>
301|                <div class="grid-line-blue"></div>
302|                
303|                <!-- Logo FFSavate en haut -->
304|                <div class="ffsavate-logo">FFSavate</div>
305|                
306|                <!-- Texte principal centr√© -->
307|                <div class="savate-text">
308|                    <div class="savate-main">SAVATE</div>
309|                    <div class="officials-text">OFFICIALS</div>
310|                </div>
311|                
312|                <!-- Coins d√©coratifs dor√©s -->
313|                <div class="logo-corner top-left"></div>
314|                <div class="logo-corner top-right"></div>
315|                <div class="logo-corner bottom-left"></div>
316|                <div class="logo-corner bottom-right"></div>
317|                
318|                <!-- Signature JPM -->
319|                <div class="jpm-signature">JPM</div>
320|            </div>
321|            
322|            <div class="role-buttons">
323|                <button class="role-button delegate" onclick="selectRole('delegate')">
324|                    üëë D√©l√©gu√© Officiel<br>
325|                    <small style="font-weight: normal; font-size: 14px; margin-top: 8px; display: block;">
326|                        Configuration ‚Ä¢ Supervision ‚Ä¢ Monitoring CPTE ‚Ä¢ Export R√©sultats
327|                    </small>
328|                </button>
329|                <button class="role-button judge" onclick="selectRole('judge')">
330|                    üë®‚Äç‚öñÔ∏è Juge<br>
331|                    <small style="font-weight: normal; font-size: 14px; margin-top: 8px; display: block;">
332|                        Interface CPTE Compl√®te ‚Ä¢ Synchronisation ‚Ä¢ Validation Automatique
333|                    </small>
334|                </button>
335|            </div>
336|        </div>
337|        
338|        <!-- Judge Access Section -->
339|        <div class="access-key-input hidden fade-in" id="judgeAccessSection">
340|            <h3>üîë Connexion Juge WebRTC</h3>
341|            <p>Entrez le code √† 4 chiffres fourni par le d√©l√©gu√©</p>
342|            
343|            <div style="margin: 30px 0;">
344|                <label style="display: block; margin: 15px 0 5px 0; font-weight: bold; font-size: 18px;">Nom du juge:</label>
345|                <input type="text" id="judgeNameInput" placeholder="Votre nom complet" 
346|                       style="padding: 15px; border: 3px solid #ddd; border-radius: 10px; font-size: 18px; width: 100%; max-width: 400px; margin: 0 auto; display: block;"
347|                       required>
348|            </div>
349|            
350|            <div style="margin: 30px 0;">
351|                <label style="display: block; margin: 15px 0 5px 0; font-weight: bold; font-size: 18px;">Num√©ro du juge:</label>
352|                <input type="text" id="judgeNumberInput" placeholder="Votre num√©ro officiel" 
353|                       style="padding: 15px; border: 3px solid #ddd; border-radius: 10px; font-size: 18px; width: 100%; max-width: 400px; margin: 0 auto; display: block;"
354|                       required>
355|            </div>
356|            
357|            <div style="margin: 30px 0;">
358|                <label style="display: block; margin: 15px 0 5px 0; font-weight: bold; font-size: 18px;">Code de session:</label>
359|                <input type="text" id="accessKeyInput" placeholder="0000" maxlength="4" pattern="[0-9]{4}"
360|                       style="padding: 20px; border: 3px solid #667eea; border-radius: 15px; font-size: 32px; text-align: center; width: 200px; font-family: 'Courier New', monospace; font-weight: bold; letter-spacing: 8px;"
361|                       required>
362|            </div>
363|            
364|            <div>
365|                <button class="button-primary" onclick="accessJudgeSheet()" style="font-size: 18px; padding: 15px 30px;" id="connectButton">
366|                    üö™ Se connecter WebRTC
367|                </button>
368|                <button class="button-primary" onclick="goBack()">‚¨ÖÔ∏è Retour</button>
369|            </div>
370|        </div>
371|        
372|        <!-- Delegate Interface -->
373|        <div class="hidden fade-in" id="delegateInterface">
374|            <div class="config-section" id="configSection">
375|                <div class="config-group">
376|                    <h3>ü•ä Type de rencontre</h3>
377|                    <input type="radio" name="fightType" value="assaut" id="assaut" checked>
378|                    <label for="assaut">‚ö° Assaut (3 reprises)</label>
379|                    <input type="radio" name="fightType" value="combat2espoirs" id="combat2espoirs">
380|                    <label for="combat2espoirs">ü•ä Combat 2√®me S√©rie Espoirs (3 reprises)</label>
381|                    <input type="radio" name="fightType" value="combat2seniors" id="combat2seniors">
382|                    <label for="combat2seniors">ü•ä Combat 2√®me S√©rie Seniors (4 reprises)</label>
383|                    <input type="radio" name="fightType" value="combat1juniors" id="combat1juniors">
384|                    <label for="combat1juniors">ü•ä Combat 1√®re S√©rie Juniors (4 reprises)</label>
385|                    <input type="radio" name="fightType" value="combat1seniors" id="combat1seniors">
386|                    <label for="combat1seniors">ü•ä Combat 1√®re S√©rie Seniors (5 reprises)</label>
387|                </div>
388|                
389|                <div class="config-group">
390|                    <h3>üë®‚Äç‚öñÔ∏è Nombre de juges</h3>
391|                    <input type="radio" name="judgeCount" value="3" id="judges3" checked>
392|                    <label for="judges3">üë• 3 juges</label>
393|                    <input type="radio" name="judgeCount" value="5" id="judges5">
394|                    <label for="judges5">üë• 5 juges</label>
395|                </div>
396|                
397|                <div class="config-group">
398|                    <h3>‚öôÔ∏è Actions</h3>
399|                    <button class="button-primary" onclick="createSession()" style="font-size: 18px; padding: 15px 30px;" id="createSessionButton">
400|                        üöÄ Cr√©er Session WebRTC
401|                    </button>
402|                    <button class="button-warning" onclick="showResetOptions()">üîÑ R√©initialisation</button>
403|                    <button class="undo-button" id="delegateUndoButton" onclick="undoDelegateLastAction()" disabled>‚Ü∂ ANNULER DERNI√àRE ACTION</button>
404|                </div>
405|            </div>
406|
407|            <!-- Delegate Dashboard -->
408|            <div class="hidden" id="delegateDashboard">
409|                <!-- Fighter Names Section -->
410|                <div class="fighters-section">
411|                    <div class="fighter-info red">
412|                        <h3>üî¥ Tireur Rouge</h3>
413|                        <input type="text" id="fighterRedName" placeholder="Nom du tireur rouge" onchange="updateFighterNames()">
414|                    </div>
415|                    <div class="fighter-info blue">
416|                        <h3>üîµ Tireur Bleu</h3>
417|                        <input type="text" id="fighterBlueName" placeholder="Nom du tireur bleu" onchange="updateFighterNames()">
418|                    </div>
419|                </div>
420|
421|                <!-- Session Info -->
422|                <div class="message info" id="sessionInfo">
423|                    <h3>üìã Informations de Session</h3>
424|                    <div id="sessionDetails">
425|                        <strong>Code de session:</strong> <span id="sessionCodeDisplay"></span><br>
426|                        <strong>Type de combat:</strong> <span id="fightTypeDisplay"></span><br>
427|                        <strong>Nombre de juges:</strong> <span id="judgeCountDisplay"></span><br>
428|                        <strong>Nombre de reprises:</strong> <span id="roundsDisplay"></span>
429|                    </div>
430|                </div>
431|
432|                <!-- Tabs Container -->
433|                <div class="tabs-container">
434|                    <div class="tabs-header">
435|                        <button class="tab-button active" onclick="showTab('monitoring')">
436|                            üìä Monitoring Juges
437|                        </button>
438|                        <button class="tab-button" onclick="showTab('recap')">
439|                            üìã Tableau R√©capitulatif
440|                        </button>
441|                        <button class="tab-button" onclick="showTab('result')">
442|                            üèÜ R√©sultat Final
443|                        </button>
444|                        <button class="tab-button" onclick="showTab('export')">
445|                            üì§ Export Complet
446|                        </button>
447|                    </div>
448|                    
449|                    <div class="tabs-content">
450|                        <!-- Monitoring Tab -->
451|                        <div class="tab-panel active" id="monitoringTab">
452|                            <div id="judgeMonitoring"></div>
453|                        </div>
454|                        
455|                        <!-- Recap Tab -->
456|                        <div class="tab-panel" id="recapTab">
457|                            <h3>üìã Tableau R√©capitulatif Complet</h3>
458|                            <p>Toutes les notations des juges par reprise avec totaux et r√©sultats individuels</p>
459|                            
460|                            <div id="recapTableContainer">
461|                                <div class="message info" style="margin: 20px 0;">
462|                                    <p>En attente des donn√©es des juges connect√©s...</p>
463|                                </div>
464|                            </div>
465|                        </div>
466|                        
467|                        <!-- Final Result Tab -->
468|                        <div class="tab-panel" id="resultTab">
469|                            <h3>üèÜ R√©sultat Final de la Rencontre</h3>
470|                            <p>Calcul automatique bas√© sur la majorit√© des d√©cisions des juges</p>
471|                            
472|                            <div id="finalResultContainer">
473|                                <div class="message info" style="margin: 20px 0;">
474|                                    <p>En attente des d√©cisions de tous les juges...</p>
475|                                </div>
476|                            </div>
477|                        </div>
478|                        
479|                        <!-- Export Tab -->
480|                        <div class="tab-panel" id="exportTab">
481|                            <div class="export-section">
482|                                <h3>üì§ Export Complet des R√©sultats</h3>
483|                                
484|                                <div class="export-options">
485|                                    <div class="export-card">
486|                                        <h4>üìä Feuille de Match Compl√®te</h4>
487|                                        <p>Export Excel avec tous les d√©tails : juges, scores, r√©sultat final</p>
488|                                        <button class="button-primary" onclick="exportCompleteMatchSheet()">
489|                                            T√©l√©charger Excel
490|                                        </button>
491|                                    </div>
492|                                    
493|                                    <div class="export-card">
494|                                        <h4>üìã Rapport Officiel</h4>
495|                                        <p>Document Markdown format√© pour archives officielles</p>
496|                                        <button class="button-primary" onclick="exportOfficialReport()">
497|                                            T√©l√©charger Rapport
498|                                        </button>
499|                                    </div>
500|                                    
501|                                    <div class="export-card">
502|                                        <h4>üìù Donn√©es Brutes</h4>
503|                                        <p>Export JSON complet pour sauvegarde ou analyse</p>
504|                                        <button class="button-primary" onclick="exportRawData()">
505|                                            T√©l√©charger JSON
506|                                        </button>
507|                                    </div>
508|                                    
509|                                    <div class="export-card">
510|                                        <h4>üñ®Ô∏è Feuille de R√©sultats</h4>
511|                                        <p>Version imprimable du r√©sultat final avec d√©tails</p>
512|                                        <button class="button-primary" onclick="printFinalResult()">
513|                                            Imprimer/PDF
514|                                        </button>
515|                                    </div>
516|                                </div>
517|                                
518|                                <div style="margin-top: 30px; text-align: center;">
519|                                    <button class="button-success" onclick="exportAllFormats()">
520|                                        üöÄ Exporter Tous les Formats
521|                                    </button>
522|                                    <button class="button-warning" onclick="showResetOptions()" style="margin-left: 15px;">
523|                                        üîÑ R√©initialisation
524|                                    </button>
525|                                </div>
526|                            </div>
527|                        </div>
528|                    </div>
529|                </div>
530|            </div>
531|        </div>
532|
533|        <!-- Judge Interface avec CPTE Complet -->
534|        <div class="hidden fade-in" id="judgeInterface">
535|            <!-- Session Status -->
536|            <div class="message success" id="judgeSessionStatus">
537|                üéØ <strong>Interface CPTE Juge - Conforme R√®glement Officiel</strong><br>
538|                Session: <span id="judgeSessionCode"></span> ‚Ä¢ Juge: <span id="judgeInfo"></span>
539|            </div>
540|
541|            <!-- Interface CPTE Compl√®te -->
542|            <div class="content-area">
543|                <h1>FICHE DE JUGE - SAVATE BOXE FRAN√áAISE</h1>
544|                
545|                <div class="header-section">
546|                    <div class="type-selection" id="judgeTypeSelection">
547|                        <!-- Sera rempli dynamiquement selon la session -->
548|                    </div>
549|                    <div class="control-buttons">
550|                        <button class="undo-button" id="judgeUndoButton" onclick="undoLastJudgeAction()" disabled>ANNULER DERNI√àRE ACTION</button>
551|                        <button class="button-success" onclick="syncJudgeData()">üîÑ SYNCHRONISER</button>
552|                    </div>
553|                </div>
554|                
555|                <div class="judge-info">
556|                    <label>Nom:</label>
557|                    <input type="text" id="judgeNameField" placeholder="Nom du juge" readonly>
558|                    <span class="completion-indicator complete" id="judgeNameFieldIndicator"></span>
559|                    <br><br>
560|                    <label>N¬∞ Juge:</label>
561|                    <input type="text" id="judgeNumberField" placeholder="Num√©ro" readonly>
562|                    <span class="completion-indicator complete" id="judgeNumberFieldIndicator"></span>
563|                </div>
564|                
565|                <div class="fighters-section">
566|                    <div class="fighter-info red">
567|                        <h3>TIREUR COIN ROUGE</h3>
568|                        <input type="text" id="judgeRedFighter" placeholder="Nom du tireur" readonly>
569|                        <span class="completion-indicator" id="judgeRedFighterIndicator"></span>
570|                    </div>
571|                    <div class="fighter-info blue">
572|                        <h3>TIREUR COIN BLEU</h3>
573|                        <input type="text" id="judgeBlueFighter" placeholder="Nom du tireur" readonly>
574|                        <span class="completion-indicator" id="judgeBlueFighterIndicator"></span>
575|                    </div>
576|                </div>
577|                
578|                <div id="judgeEqualityWarning" class="equality-warning" style="display: none;">
579|                    ‚ö†Ô∏è √âGALIT√â D√âTECT√âE - Un bonus doit obligatoirement √™tre attribu√© √† l'un des deux tireurs !
580|                </div>
581|                
582|                <div id="judgeValidationAlert" class="validation-warning" style="display: none;">
583|                    <div id="judgeValidationMessage"></div>
584|                </div>
585|                
586|                <div id="judgeValidationSuccess" class="validation-success" style="display: none;">
587|                    ‚úÖ Toutes les informations obligatoires sont compl√®tes !
588|                </div>
589|                
590|                <table class="scoring-table" id="judgeScoringTable">
591|                    <colgroup id="judgeColgroup">
592|                        <!-- D√©finition des colonnes qui s'adaptent au type -->
593|                    </colgroup>
594|                    <thead id="judgeTableHeader">
595|                        <!-- En-t√™tes g√©n√©r√©s dynamiquement -->
596|                    </thead>
597|                    <tbody id="judgeTableBody">
598|                        <!-- Corps du tableau g√©n√©r√© dynamiquement -->
599|                    </tbody>
600|                </table>
601|                
602|                <div id="judgeDisqualificationMessage" style="display: none;" class="disqualification">
603|                    <h2>DISQUALIFICATION</h2>
604|                    <p id="judgeDisqualificationText"></p>
605|                </div>
606|                
607|                <div id="judgeAbandonMessage" style="display: none;" class="abandon-message">
608|                    <h2>ABANDON</h2>
609|                    <p id="judgeAbandonText"></p>
610|                </div>
611|                
612|                <div class="export-buttons">
613|                    <button class="export-button excel" onclick="exportJudgeToExcel()">üìä Exporter en Excel</button>
614|                    <button class="export-button markdown" onclick="exportJudgeToMarkdown()">üìù Exporter en Markdown</button>
615|                </div>
616|            </div>
617|        </div>
618|        
619|        <!-- Content Area -->
620|        <div class="content-area" id="contentArea">
621|            <div style="text-align: center; padding: 60px 20px;">
622|                <h2>üëã Bienvenue dans SAVATE OFFICIALS</h2>
623|                <p style="margin-top: 20px; font-size: 18px; color: #7f8c8d;">
624|                    üåü Application Professionnelle avec Interface CPTE Compl√®te
625|                </p>
626|                
627|                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, rgba(46,204,113,0.1) 0%, rgba(39,174,96,0.1) 100%); border-radius: 15px; border: 2px solid rgba(46,204,113,0.3);">
628|                    <h4 style="color: #27ae60; margin-bottom: 15px;">‚úÖ INTERFACE CPTE COMPL√àTE ET CONFORME ‚úÖ</h4>
629|                    <ul style="list-style: none; color: #2c3e50; line-height: 1.8; font-size: 15px; text-align: left; max-width: 700px; margin: 0 auto;">
630|                        <li>üìã Interface CPTE identique au r√®glement officiel</li>
631|                        <li>üéØ Validation automatique des r√®gles de Savate</li>
632|                        <li>‚ö° Scores 3-2-1 avec validation des combinaisons</li>
633|                        <li>‚ö†Ô∏è Gestion avertissements et comptes (A/C)</li>
634|                        <li>üîí Verrouillage des reprises compl√©t√©es</li>
635|                        <li>üèÜ Calcul automatique des totaux et r√©sultats</li>
636|                        <li>‚ùå D√©tection automatique disqualifications/abandons</li>
637|                        <li>üé≤ Gestion √©galit√© avec bonus obligatoire</li>
638|                        <li>‚Ü∂ Fonction Annuler avec historique d'actions</li>
639|                        <li>üåê Synchronisation WebRTC temps r√©el</li>
640|                        <li>üëë Monitoring d√©l√©gu√© avec fiches compl√®tes</li>
641|                        <li>üìä Export Excel et Markdown</li>
642|                        <li>üíæ Sauvegarde automatique</li>
643|                        <li>üì± Interface 100% responsive</li>
644|                        <li>üõ°Ô∏è Validation compl√®te des champs obligatoires</li>
645|                    </ul>
646|                </div>
647|                
648|                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, rgba(52,152,219,0.1) 0%, rgba(41,128,185,0.1) 100%); border-radius: 10px; border: 2px solid rgba(52,152,219,0.3);">
649|                    <h5 style="color: #2980b9; margin-bottom: 10px;">üîß INTERFACE CPTE PROFESSIONNELLE</h5>
650|                    <p style="color: #2c3e50; font-size: 14px; margin: 0;">
651|                        ü•ä Tous Types de Combats ‚Ä¢ ‚öñÔ∏è Validation R√®glement ‚Ä¢ üîÑ Sync Temps R√©el<br>
652|                        üìã Export Officiel ‚Ä¢ üéØ Indicateurs Visuels ‚Ä¢ ‚ôø Accessibilit√© Compl√®te
653|                    </p>
654|                </div>
655|            </div>
656|        </div>
657|    </div>
658|
659|    <!-- Modal de r√©initialisation pour d√©l√©gu√© -->
660|    <div class="reset-modal hidden" id="resetModal">
661|        <div class="reset-modal-content">
662|            <button class="modal-close" onclick="closeResetModal()">&times;</button>
663|            <h2>üîÑ Options de R√©initialisation</h2>
664|            <p style="margin-bottom: 30px; color: #666;">Choisissez le type de r√©initialisation √† effectuer:</p>
665|            
666|            <div class="reset-option partial" onclick="performPartialReset()">
667|                <h3>üîÑ R√©initialisation Partielle</h3>
668|                <p><strong>Remet √† z√©ro:</strong> Tous les scores, avertissements, comptes, abandons, bonus et noms des tireurs</p>
669|                <p><strong>Conserve:</strong> La session en cours, les connexions des juges, leurs noms et num√©ros</p>
670|                <p style="margin-top: 10px; font-style: italic; color: #f39c12;">‚ö†Ô∏è Id√©al pour un nouveau combat avec les m√™mes juges</p>
671|            </div>
672|
673|            <div class="reset-option complete" onclick="performCompleteReset()">
674|                <h3>üî• R√©initialisation Compl√®te</h3>
675|                <p><strong>Remet √† z√©ro:</strong> Tous les donn√©es, ferme toutes les connexions et g√©n√®re une nouvelle session</p>
676|                <p><strong>Action:</strong> Retour √† l'√©cran de s√©lection de r√¥le pour recommencer</p>
677|                <p style="margin-top: 10px; font-style: italic; color: #e74c3c;">‚ö†Ô∏è N√©cessite une reconnexion de tous les juges</p>
678|            </div>
679|
680|            <div style="margin-top: 30px;">
681|                <button class="button-primary" onclick="closeResetModal()">‚ùå Annuler</button>
682|            </div>
683|        </div>
684|    </div>
685|
686|    <script>
687|        console.log('üöÄ SAVATE OFFICIALS - Interface CPTE Compl√®te Initialis√©e');
688|        console.log('üì± Version: 4.2.0 - Interface CPTE Professionnelle Finalis√©e');
689|        console.log('üîß Fonctionnalit√©s: WebRTC P2P + CPTE Compl√®te + Onglets D√©l√©gu√© + Validation + Export');
690|
691|        // =====================
692|        // VARIABLES GLOBALES COMPL√àTES
693|        // =====================
694|        
695|        let app = {
696|            version: '4.2.0',
697|            webrtc: {
698|                peer: null,
699|                connections: new Map(),
700|                isHost: false,
701|

Action: file_editor view /app/SAVATE-PART-02
Observation: /app/SAVATE-PART-02:
1|                peerId: null,
2|                lastSyncTime: Date.now(),
3|                syncCount: 0,
4|                syncErrors: 0,
5|                reconnectAttempts: 0,
6|                maxReconnectAttempts: 5,
7|                connectionQuality: 'excellent',
8|                latency: 0
9|            },
10|            session: {
11|                id: '',
12|                code: '',
13|                fightType: 'assaut',
14|                judgeCount: 3,
15|                rounds: 3,
16|                initialized: false,
17|                role: '',
18|                judgeId: null,
19|                judgeName: '',
20|                judgeNumber: '',
21|                deviceId: 'device_' + Math.random().toString(36).substr(2, 9),
22|                startTime: null,
23|                status: 'inactive'
24|            },
25|            data: {
26|                judges: {},
27|                fighters: { red: '', blue: '' },
28|                connectedDevices: new Set(),
29|                changeLog: [],
30|                results: null
31|            },
32|            monitoring: {
33|                syncMetrics: {
34|                    totalSync: 0,
35|                    syncErrors: 0,
36|                    uptimeStart: Date.now()
37|                }
38|            }
39|        };
40|
41|        // Variables CPTE (identiques au fichier SO J2 BONNE)
42|        const warnings = { red: {}, blue: {} };
43|        const comptes = { red: {}, blue: {} };
44|        const abandons = { red: false, blue: false };
45|        let actionHistory = [];
46|        let delegateActionHistory = []; // Historique des actions du d√©l√©gu√©
47|        let activeRounds = 3;
48|        
49|        // =====================
50|        // UTILITAIRES
51|        // =====================
52|        
53|        function generateSessionId() {
54|            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
55|        }
56|
57|        function generateUniqueCode() {
58|            return Math.floor(1000 + Math.random() * 9000).toString();
59|        }
60|
61|        function getFightTypeLabel(type) {
62|            const labels = {
63|                'assaut': 'Assaut (3 reprises)',
64|                'combat2espoirs': 'Combat 2√®me S√©rie Espoirs (3 reprises)',
65|                'combat2seniors': 'Combat 2√®me S√©rie Seniors (4 reprises)', 
66|                'combat1juniors': 'Combat 1√®re S√©rie Juniors (4 reprises)',
67|                'combat1seniors': 'Combat 1√®re S√©rie Seniors (5 reprises)'
68|            };
69|            return labels[type] || type;
70|        }
71|
72|        function getRoundsFromFightType(fightType) {
73|            switch(fightType) {
74|                case 'assaut':
75|                case 'combat2espoirs':
76|                    return 3;
77|                case 'combat2seniors':
78|                case 'combat1juniors':
79|                    return 4;
80|                case 'combat1seniors':
81|                    return 5;
82|                default:
83|                    return 3;
84|            }
85|        }
86|
87|        function isCombat() {
88|            return app.session.fightType !== 'assaut';
89|        }
90|
91|        function formatTime(timestamp) {
92|            return new Date(timestamp).toLocaleTimeString('fr-FR');
93|        }
94|
95|        function formatDate(timestamp) {
96|            return new Date(timestamp).toISOString().split('T')[0];
97|        }
98|
99|        function safeGetElement(id) {
100|            return document.getElementById(id);
101|        }
102|
103|        function showNotification(message, type = 'info', duration = 5000) {
104|            const notification = document.createElement('div');
105|            notification.className = `message ${type}`;
106|            notification.innerHTML = `
107|                ${message}
108|                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; float: right; cursor: pointer;">√ó</button>
109|            `;
110|            
111|            const container = document.querySelector('.app-container');
112|            container.insertBefore(notification, container.firstChild);
113|            
114|            setTimeout(() => {
115|                if (notification.parentNode) {
116|                    notification.remove();
117|                }
118|            }, duration);
119|        }
120|
121|        // =====================
122|        // GESTION HISTORIQUE D√âL√âGU√â
123|        // =====================
124|
125|        function saveDelegateState(actionType, actionData = {}) {
126|            const state = {
127|                timestamp: Date.now(),
128|                actionType: actionType,
129|                actionData: actionData,
130|                session: JSON.parse(JSON.stringify(app.session)),
131|                fighters: JSON.parse(JSON.stringify(app.data.fighters)),
132|                judges: JSON.parse(JSON.stringify(app.data.judges)),
133|                results: JSON.parse(JSON.stringify(app.data.results))
134|            };
135|            
136|            delegateActionHistory.push(state);
137|            
138|            // Limiter l'historique √† 20 actions pour √©viter la surcharge m√©moire
139|            if (delegateActionHistory.length > 20) {
140|                delegateActionHistory.shift();
141|            }
142|            
143|            // Activer le bouton annuler
144|            const undoButton = document.getElementById('delegateUndoButton');
145|            if (undoButton) {
146|                undoButton.disabled = false;
147|                undoButton.textContent = `‚Ü∂ ANNULER: ${actionType}`;
148|            }
149|            
150|            console.log(`üíæ √âtat d√©l√©gu√© sauvegard√©: ${actionType}`, state);
151|        }
152|
153|        function undoDelegateLastAction() {
154|            if (delegateActionHistory.length === 0) {
155|                showNotification('‚ùå Aucune action √† annuler', 'warning');
156|                return;
157|            }
158|            
159|            const previousState = delegateActionHistory.pop();
160|            
161|            console.log(`‚Ü∂ Annulation action d√©l√©gu√©: ${previousState.actionType}`);
162|            
163|            // Restaurer l'√©tat pr√©c√©dent
164|            app.session = previousState.session;
165|            app.data.fighters = previousState.fighters;
166|            app.data.judges = previousState.judges;
167|            app.data.results = previousState.results;
168|            
169|            // Envoyer la restauration aux juges connect√©s
170|            sendToAll({
171|                type: 'delegate_undo_action',
172|                data: {
173|                    actionType: previousState.actionType,
174|                    session: app.session,
175|                    fighters: app.data.fighters,
176|                    timestamp: Date.now()
177|                }
178|            }, 'high');
179|            
180|            // Mettre √† jour l'interface d√©l√©gu√©
181|            updateDelegateInterface();
182|            
183|            // Mettre √† jour le bouton annuler
184|            const undoButton = document.getElementById('delegateUndoButton');
185|            if (undoButton) {
186|                if (delegateActionHistory.length === 0) {
187|                    undoButton.disabled = true;
188|                    undoButton.textContent = '‚Ü∂ ANNULER DERNI√àRE ACTION';
189|                } else {
190|                    const nextAction = delegateActionHistory[delegateActionHistory.length - 1];
191|                    undoButton.textContent = `‚Ü∂ ANNULER: ${nextAction.actionType}`;
192|                }
193|            }
194|            
195|            showNotification(`‚Ü∂ Action "${previousState.actionType}" annul√©e avec succ√®s`, 'success');
196|        }
197|
198|        function updateDelegateInterface() {
199|            // Mettre √† jour les noms des tireurs
200|            const redName = document.getElementById('fighterRedName');
201|            const blueName = document.getElementById('fighterBlueName');
202|            if (redName) redName.value = app.data.fighters.red || '';
203|            if (blueName) blueName.value = app.data.fighters.blue || '';
204|            
205|            // Mettre √† jour le monitoring et les tableaux
206|            if (app.session.role === 'delegate' && app.session.initialized) {
207|                updateJudgeMonitoring();
208|                updateRecapTable();
209|                updateFinalResult();
210|            }
211|        }
212|
213|        // =====================
214|        // WEBRTC SYST√àME
215|        // =====================
216|        
217|        function waitForPeerJS(maxWaitTime = 15000) {
218|            return new Promise((resolve, reject) => {
219|                let elapsed = 0;
220|                const checkInterval = 100;
221|                
222|                const checkPeerJS = () => {
223|                    if (typeof Peer !== 'undefined') {
224|                        console.log('‚úÖ PeerJS charg√©');
225|                        resolve();
226|                        return;
227|                    }
228|                    
229|                    elapsed += checkInterval;
230|                    if (elapsed >= maxWaitTime) {
231|                        reject(new Error('PeerJS timeout'));
232|                        return;
233|                    }
234|                    
235|                    setTimeout(checkPeerJS, checkInterval);
236|                };
237|                
238|                checkPeerJS();
239|            });
240|        }
241|
242|        function initializeWebRTC() {
243|            return new Promise((resolve, reject) => {
244|                waitForPeerJS().then(() => {
245|                    try {
246|                        const baseId = app.session.role === 'delegate' ? 
247|                            `delegate_${app.session.code}` : 
248|                            `judge_${app.session.code}_${Date.now()}`;
249|                        
250|                        console.log('üåê Initialisation WebRTC:', baseId);
251|                        
252|                        app.webrtc.peer = new Peer(baseId, {
253|                            config: {
254|                                'iceServers': [
255|                                    { urls: 'stun:stun.l.google.com:19302' },
256|                                    { urls: 'stun:stun1.l.google.com:19302' }
257|                                ]
258|                            }
259|                        });
260|
261|                        app.webrtc.peer.on('open', function(id) {
262|                            console.log('‚úÖ Peer WebRTC cr√©√©:', id);
263|                            app.webrtc.peerId = id;
264|                            updateSyncIndicator('Connect√© WebRTC', 'connected');
265|                            
266|                            if (app.session.role === 'delegate') {
267|                                app.webrtc.isHost = true;
268|                            }
269|                            
270|                            resolve(id);
271|                        });
272|
273|                        app.webrtc.peer.on('connection', function(conn) {
274|                            console.log('üìû Connexion entrante:', conn.peer);
275|                            handleIncomingConnection(conn);
276|                        });
277|
278|                        app.webrtc.peer.on('error', function(err) {
279|                            console.error('‚ùå Erreur WebRTC:', err);
280|                            updateSyncIndicator('Erreur: ' + err.type, 'offline');
281|                            
282|                            if (err.type === 'peer-unavailable') {
283|                                showNotification('‚ùå Session introuvable. V√©rifiez le code.', 'error');
284|                            } else {
285|                                showNotification('‚ùå Erreur WebRTC: ' + err.type, 'error');
286|                            }
287|                            
288|                            reject(err);
289|                        });
290|
291|                        setTimeout(() => {
292|                            if (!app.webrtc.peerId) {
293|                                reject(new Error('Timeout WebRTC'));
294|                            }
295|                        }, 15000);
296|
297|                    } catch (error) {
298|                        console.error('‚ùå Erreur init WebRTC:', error);
299|                        reject(error);
300|                    }
301|                }).catch(error => {
302|                    console.error('‚ùå PeerJS indisponible:', error);
303|                    updateSyncIndicator('‚ùå PeerJS indisponible', 'offline');
304|                    showNotification('‚ùå Impossible de charger PeerJS', 'error');
305|                    reject(error);
306|                });
307|            });
308|        }
309|
310|        function handleIncomingConnection(conn) {
311|            app.webrtc.connections.set(conn.peer, conn);
312|            
313|            conn.on('open', function() {
314|                console.log('‚úÖ Connexion √©tablie:', conn.peer);
315|                updatePeersList();
316|                
317|                if (app.session.role === 'delegate') {
318|                    sendSessionDataToNewPeer(conn);
319|                }
320|            });
321|
322|            conn.on('data', function(data) {
323|                handleWebRTCMessage(data, conn.peer, conn);
324|            });
325|
326|            conn.on('close', function() {
327|                console.log('üîå Connexion ferm√©e:', conn.peer);
328|                app.webrtc.connections.delete(conn.peer);
329|                updatePeersList();
330|                cleanupJudgeData(conn.peer);
331|            });
332|
333|            conn.on('error', function(err) {
334|                console.error('‚ùå Erreur connexion:', err);
335|                app.webrtc.connections.delete(conn.peer);
336|                updatePeersList();
337|            });
338|        }
339|
340|        function connectToPeer(peerId) {
341|            return new Promise((resolve, reject) => {
342|                try {
343|                    console.log('üîó Connexion au peer:', peerId);
344|                    updateSyncIndicator('Connexion...', 'syncing');
345|                    
346|                    const conn = app.webrtc.peer.connect(peerId, {
347|                        reliable: true,
348|                        serialization: 'json'
349|                    });
350|                    
351|                    conn.on('open', function() {
352|                        console.log('‚úÖ Connect√© au d√©l√©gu√©:', peerId);
353|                        app.webrtc.connections.set(peerId, conn);
354|                        updateSyncIndicator('Connect√©', 'connected');
355|                        updatePeersList();
356|                        
357|                        sendJudgeConnectionData(conn);
358|                        resolve(conn);
359|                    });
360|
361|                    conn.on('data', function(data) {
362|                        handleWebRTCMessage(data, peerId, conn);
363|                    });
364|
365|                    conn.on('close', function() {
366|                        console.log('üîå Connexion ferm√©e');
367|                        app.webrtc.connections.delete(peerId);
368|                        updateSyncIndicator('D√©connect√©', 'offline');
369|                        updatePeersList();
370|                    });
371|
372|                    conn.on('error', function(err) {
373|                        console.error('‚ùå Erreur connexion:', err);
374|                        updateSyncIndicator('Erreur', 'offline');
375|                        reject(err);
376|                    });
377|
378|                    setTimeout(() => {
379|                        if (!app.webrtc.connections.has(peerId)) {
380|                            reject(new Error('Timeout connexion'));
381|                        }
382|                    }, 20000);
383|
384|                } catch (error) {
385|                    console.error('‚ùå Erreur connectToPeer:', error);
386|                    reject(error);
387|                }
388|            });
389|        }
390|
391|        function sendToAll(message, priority = 'normal') {
392|            const enrichedMessage = {
393|                ...message,
394|                timestamp: Date.now(),
395|                from: app.webrtc.peerId,
396|                fromRole: app.session.role,
397|                sessionCode: app.session.code,
398|                priority: priority
399|            };
400|            
401|            let sentCount = 0;
402|            let errorCount = 0;
403|            
404|            app.webrtc.connections.forEach((conn, peerId) => {
405|                if (conn.open) {
406|                    try {
407|                        conn.send(enrichedMessage);
408|                        sentCount++;
409|                    } catch (error) {
410|                        console.error('‚ùå Erreur envoi:', peerId, error);
411|                        errorCount++;
412|                    }
413|                } else {
414|                    errorCount++;
415|                }
416|            });
417|            
418|            console.log(`üì§ Message envoy√© √† ${sentCount} peers:`, message.type);
419|            return { sent: sentCount, errors: errorCount };
420|        }
421|
422|        function handleWebRTCMessage(message, fromPeer, conn) {
423|            console.log('üì• Message re√ßu:', message.type, 'de', fromPeer);
424|            
425|            try {
426|                switch (message.type) {
427|                    case 'judge_connection':
428|                        handleJudgeConnection(message.data, fromPeer);
429|                        break;
430|                    case 'judge_data':
431|                        receiveJudgeData(message.data, message);
432|                        break;
433|                    case 'session_data':
434|                        receiveSessionData(message.data);
435|                        break;
436|                    case 'fighter_names':
437|                        receiveFighterNames(message.data);
438|                        break;
439|                    case 'partial_reset_command':
440|                        if (app.session.role === 'judge') {
441|                            console.log('üî• Commande de r√©initialisation partielle re√ßue du d√©l√©gu√©');
442|                            app.data.fighters = message.data.fighters;
443|                            updateFighterNamesInInterface();
444|                            resetJudgeFormData();
445|                            showNotification('üîÑ R√©initialisation effectu√©e par le d√©l√©gu√©', 'warning');
446|                        }
447|                        break;
448|                    case 'delegate_undo_action':
449|                        if (app.session.role === 'judge') {
450|                            console.log('‚Ü∂ Annulation d\'action re√ßue du d√©l√©gu√©:', message.data.actionType);
451|                            if (message.data.session) {
452|                                const currentJudgeName = app.session.judgeName;
453|                                const currentJudgeNumber = app.session.judgeNumber;
454|                                const currentJudgeId = app.session.judgeId;
455|                                const currentRole = app.session.role;
456|                                
457|                                app.session = { ...app.session, ...message.data.session };
458|                                
459|                                app.session.judgeName = currentJudgeName;
460|                                app.session.judgeNumber = currentJudgeNumber;
461|                                app.session.judgeId = currentJudgeId;
462|                                app.session.role = currentRole;
463|                            }
464|                            
465|                            if (message.data.fighters) {
466|                                app.data.fighters = message.data.fighters;
467|                                updateFighterNamesInInterface();
468|                            }
469|                            
470|                            updateJudgeRounds();
471|                            createJudgeTableStructure();
472|                            
473|                            showNotification(`‚Ü∂ Action "${message.data.actionType}" annul√©e par le d√©l√©gu√©`, 'info');
474|                        }
475|                        break;
476|                    case 'session_reset_complete':
477|                        if (app.session.role === 'judge') {
478|                            console.log('üî• Session r√©initialis√©e par le d√©l√©gu√©');
479|                            showNotification('‚ö†Ô∏è Session r√©initialis√©e par le d√©l√©gu√©. D√©connexion...', 'warning');
480|                            setTimeout(() => {
481|                                resetJudgeConnection();
482|                            }, 2000);
483|                        }
484|                        break;
485|                    case 'judge_disconnect':
486|                        if (app.session.role === 'delegate') {
487|                            console.log('üî• Juge d√©connect√©:', message.data);
488|                            const judgeKey = `judge${message.data.judgeId}`;
489|                            
490|                            if (app.data.judges[judgeKey]) {
491|                                app.data.judges[judgeKey].connected = false;
492|                                app.data.judges[judgeKey].lastUpdate = Date.now();
493|                                updateJudgeMonitoring();
494|                                showNotification(`üö™ ${message.data.name} s'est d√©connect√©`, 'info');
495|                            }
496|                        }
497|                        break;
498|                    default:
499|                        console.warn('‚ö†Ô∏è Type message non reconnu:', message.type);
500|                }
501|            } catch (error) {
502|                console.error('‚ùå Erreur traitement message:', error);
503|            }
504|        }
505|
506|        function handleJudgeConnection(connectionData, fromPeer) {
507|            console.log('üì• Connexion juge:', connectionData);
508|            const judgeKey = `judge${connectionData.judgeId}`;
509|            
510|            if (!app.data.judges[judgeKey]) {
511|                app.data.judges[judgeKey] = {
512|                    id: connectionData.judgeId,
513|                    scores: {},
514|                    warnings: { red: {}, blue: {} },
515|                    comptes: { red: {}, blue: {} },
516|                    abandons: { red: false, blue: false },
517|                    bonuses: { red: 0, blue: 0 },
518|                    totalRed: 0,
519|                    totalBlue: 0,
520|                    result: 'En attente...'
521|                };
522|            }
523|            
524|            Object.assign(app.data.judges[judgeKey], {
525|                connected: connectionData.connected,
526|                name: connectionData.name || 'Nom non d√©fini',
527|                number: connectionData.number || 'Non d√©fini',
528|                peerId: fromPeer,
529|                lastUpdate: Date.now(),
530|                connectionTime: Date.now()
531|            });
532|            
533|            if (app.session.role === 'delegate') {
534|                updateJudgeMonitoring();
535|                updateRecapTable();
536|                updateFinalResult();
537|            }
538|            
539|            showNotification(`üéâ Juge ${connectionData.judgeId} (${connectionData.name}) connect√©!`, 'success');
540|        }
541|
542|        function receiveJudgeData(judgeData, fullMessage) {
543|            console.log('üì• Donn√©es juge re√ßues:', judgeData);
544|            const judgeKey = `judge${judgeData.judgeId}`;
545|            
546|            if (!app.data.judges[judgeKey]) {
547|                app.data.judges[judgeKey] = {};
548|            }
549|            
550|            app.data.judges[judgeKey] = {
551|                ...app.data.judges[judgeKey],
552|                ...judgeData,
553|                lastUpdate: Date.now(),
554|                syncSource: 'webrtc'
555|            };
556|            
557|            if (app.session.role === 'delegate') {
558|                updateJudgeMonitoring();
559|                updateRecapTable();
560|                updateFinalResult();
561|            }
562|            
563|            showNotification(`üì° Juge ${judgeData.judgeId} synchronis√©`, 'success', 3000);
564|        }
565|
566|        function receiveSessionData(sessionData) {
567|            console.log('üì• Donn√©es session:', sessionData);
568|            
569|            if (sessionData.session) {
570|                const currentJudgeName = app.session.judgeName;
571|                const currentJudgeNumber = app.session.judgeNumber;
572|                
573|                app.session = { ...app.session, ...sessionData.session };
574|                
575|                if (currentJudgeName && app.session.role === 'judge') {
576|                    app.session.judgeName = currentJudgeName;
577|                }
578|                if (currentJudgeNumber && app.session.role === 'judge') {
579|                    app.session.judgeNumber = currentJudgeNumber;
580|                }
581|            }
582|            
583|            if (sessionData.fighters) {
584|                app.data.fighters = sessionData.fighters;
585|                updateFighterNamesInInterface();
586|            }
587|            
588|            if (sessionData.judges) {
589|                app.data.judges = sessionData.judges;
590|            }
591|            
592|            if (app.session.role === 'judge') {
593|                updateJudgeRounds();
594|                createJudgeTableStructure();
595|                updateFighterNamesInInterface();
596|            }
597|        }
598|
599|        function receiveFighterNames(fighterData) {
600|            console.log('üì• Noms tireurs:', fighterData);
601|            app.data.fighters = { ...app.data.fighters, ...fighterData };
602|            updateFighterNamesInInterface();
603|        }
604|
605|        function sendJudgeConnectionData(conn) {
606|            try {
607|                const connectionData = {
608|                    judgeId: app.session.judgeId,
609|                    name: app.session.judgeName,
610|                    number: app.session.judgeNumber,
611|                    connected: true,
612|                    timestamp: Date.now(),
613|                    deviceId: app.session.deviceId
614|                };
615|                
616|                conn.send({
617|                    type: 'judge_connection',
618|                    data: connectionData,
619|                    timestamp: Date.now(),
620|                    from: app.webrtc.peerId,
621|                    sessionCode: app.session.code
622|                });
623|                
624|                console.log('üì§ Donn√©es connexion juge envoy√©es');
625|            } catch (error) {
626|                console.error('‚ùå Erreur envoi connexion:', error);
627|            }
628|        }
629|
630|        function sendSessionDataToNewPeer(conn) {
631|            try {
632|                const sessionData = {
633|                    session: {
634|                        id: app.session.id,
635|                        code: app.session.code,
636|                        fightType: app.session.fightType,
637|                        judgeCount: app.session.judgeCount,
638|                        rounds: app.session.rounds,
639|                        status: app.session.status
640|                    },
641|                    fighters: app.data.fighters,
642|                    judges: app.data.judges,
643|                    timestamp: Date.now()
644|                };
645|                
646|                conn.send({
647|                    type: 'session_data',
648|                    data: sessionData,
649|                    timestamp: Date.now(),
650|                    from: app.webrtc.peerId,
651|                    sessionCode: app.session.code
652|                });
653|                
654|                console.log('üì§ Donn√©es session envoy√©es');
655|            } catch (error) {
656|                console.error('‚ùå Erreur envoi session:', error);
657|            }
658|        }
659|
660|        function updateSyncIndicator(status = null, type = null) {
661|            const indicator = document.getElementById('syncIndicator');
662|            const statusSpan = document.getElementById('syncStatus');
663|            const devicesCount = document.getElementById('devicesCount');
664|            const icon = document.getElementById('syncIcon');
665|            
666|            if (indicator && !indicator.classList.contains('hidden')) {
667|                if (status) {
668|                    statusSpan.textContent = status;
669|                }
670|                
671|                if (type) {
672|                    indicator.className = `sync-indicator ${type}`;
673|                    
674|                    switch(type) {
675|                        case 'connected':
676|                            icon.textContent = '‚úÖ';
677|                            break;
678|                        case 'syncing':
679|                            icon.textContent = 'üîÑ';
680|                            break;
681|                        case 'offline':
682|                            icon.textContent = '‚ùå';
683|                            break;
684|                        default:
685|                            icon.textContent = '‚ö°';
686|                    }
687|                }
688|                
689|                const deviceCount = app.data.connectedDevices.size;
690|                const judgeCount = Object.keys(app.data.judges).filter(k => app.data.judges[k].connected).length;
691|                devicesCount.textContent = `${deviceCount} appareils ‚Ä¢ ${judgeCount} juges`;
692|            }
693|        }
694|
695|        function updatePeersList() {
696|            app.data.connectedDevices.clear();
697|            app.webrtc.connections.forEach((conn, peerId) => {
698|                if (conn.open) {
699|                    app.data.connectedDevices.add(peerId);
700|                }
701|

Action: file_editor view /app/SAVATE-PART-03
Observation: /app/SAVATE-PART-03:
1|            });
2|            updateSyncIndicator();
3|        }
4|
5|        function cleanupJudgeData(peerId) {
6|            Object.keys(app.data.judges).forEach(judgeKey => {
7|                const judge = app.data.judges[judgeKey];
8|                if (judge.peerId === peerId) {
9|                    judge.connected = false;
10|                    judge.lastUpdate = Date.now();
11|                }
12|            });
13|            
14|            if (app.session.role === 'delegate') {
15|                updateJudgeMonitoring();
16|            }
17|        }
18|
19|        // =====================
20|        // GESTIONNAIRE DE SESSIONS
21|        // =====================
22|        
23|        function selectRole(role) {
24|            app.session.role = role;
25|            document.getElementById('roleSelector').classList.add('hidden');
26|            
27|            if (role === 'delegate') {
28|                document.getElementById('delegateInterface').classList.remove('hidden');
29|                showNotification('üëë Mode d√©l√©gu√© activ√©', 'success');
30|            } else if (role === 'judge') {
31|                document.getElementById('judgeAccessSection').classList.remove('hidden');
32|                showNotification('‚öñÔ∏è Mode juge activ√©', 'info');
33|            }
34|        }
35|
36|        function goBack() {
37|            document.getElementById('judgeAccessSection').classList.add('hidden');
38|            document.getElementById('delegateInterface').classList.add('hidden');
39|            document.getElementById('judgeInterface').classList.add('hidden');
40|            document.getElementById('roleSelector').classList.remove('hidden');
41|            document.getElementById('contentArea').style.display = 'block';
42|            
43|            const syncIndicator = document.getElementById('syncIndicator');
44|            if (syncIndicator) syncIndicator.classList.add('hidden');
45|            
46|            app.session.role = '';
47|        }
48|
49|        function createSession() {
50|            console.log('üöÄ Cr√©ation session...');
51|            
52|            const createButton = document.getElementById('createSessionButton');
53|            createButton.disabled = true;
54|            createButton.innerHTML = '<div class="loading-spinner"></div> Cr√©ation...';
55|            
56|            app.session.fightType = document.querySelector('input[name="fightType"]:checked').value;
57|            app.session.judgeCount = parseInt(document.querySelector('input[name="judgeCount"]:checked').value);
58|            app.session.rounds = getRoundsFromFightType(app.session.fightType);
59|            
60|            app.session.id = generateSessionId();
61|            app.session.code = generateUniqueCode();
62|            app.session.initialized = true;
63|            app.session.role = 'delegate';
64|            app.session.startTime = Date.now();
65|            app.session.status = 'active';
66|            
67|            initializeWebRTC().then(() => {
68|                console.log('‚úÖ WebRTC d√©l√©gu√© initialis√©');
69|                
70|                document.getElementById('configSection').classList.add('hidden');
71|                showDelegateInterface();
72|                
73|                showNotification('‚úÖ Session WebRTC cr√©√©e!', 'success');
74|                
75|                createButton.disabled = false;
76|                createButton.innerHTML = 'üöÄ Cr√©er Session WebRTC';
77|                
78|            }).catch(error => {
79|                console.error('‚ùå Erreur WebRTC:', error);
80|                showNotification('‚ùå Erreur cr√©ation: ' + error.message, 'error');
81|                
82|                createButton.disabled = false;
83|                createButton.innerHTML = 'üöÄ Cr√©er Session WebRTC';
84|            });
85|        }
86|
87|        function accessJudgeSheet() {
88|            const accessKey = document.getElementById('accessKeyInput').value.trim();
89|            const judgeName = document.getElementById('judgeNameInput').value.trim();
90|            const judgeNumber = document.getElementById('judgeNumberInput').value.trim();
91|            
92|            if (!accessKey || !judgeName || !judgeNumber) {
93|                showNotification('‚ö†Ô∏è Veuillez remplir tous les champs', 'error');
94|                return;
95|            }
96|            
97|            if (!/^\d{4}$/.test(accessKey)) {
98|                showNotification('‚ùå Code √† 4 chiffres requis', 'error');
99|                return;
100|            }
101|            
102|            if (judgeName.length < 2) {
103|                showNotification('‚ùå Nom trop court', 'error');
104|                return;
105|            }
106|            
107|            const connectButton = document.getElementById('connectButton');
108|            connectButton.disabled = true;
109|            connectButton.innerHTML = '<div class="loading-spinner"></div> Connexion...';
110|            
111|            app.session.code = accessKey;
112|            app.session.judgeName = judgeName;
113|            app.session.judgeNumber = judgeNumber;
114|            app.session.judgeId = Math.floor(Math.random() * 1000) + 1;
115|            app.session.role = 'judge';
116|            
117|            initializeWebRTC().then(() => {
118|                const delegatePeerId = `delegate_${accessKey}`;
119|                return connectToPeer(delegatePeerId);
120|            }).then(() => {
121|                console.log('‚úÖ Connexion juge √©tablie');
122|                document.getElementById('judgeAccessSection').classList.add('hidden');
123|                showJudgeInterface();
124|                
125|                showNotification('‚úÖ Connexion WebRTC √©tablie!', 'success');
126|                
127|                connectButton.disabled = false;
128|                connectButton.innerHTML = 'üö™ Se connecter WebRTC';
129|                
130|            }).catch(error => {
131|                console.error('‚ùå Erreur connexion:', error);
132|                showNotification('‚ùå Erreur: ' + error.message, 'error');
133|                
134|                connectButton.disabled = false;
135|                connectButton.innerHTML = 'üö™ Se connecter WebRTC';
136|            });
137|        }
138|
139|        // =====================
140|        // INTERFACE D√âL√âGU√â
141|        // =====================
142|
143|        function showDelegateInterface() {
144|            document.getElementById('delegateDashboard').classList.remove('hidden');
145|            document.getElementById('contentArea').style.display = 'none';
146|            document.getElementById('syncIndicator').classList.remove('hidden');
147|            
148|            // Afficher infos session
149|            document.getElementById('sessionCodeDisplay').textContent = app.session.code;
150|            document.getElementById('fightTypeDisplay').textContent = getFightTypeLabel(app.session.fightType);
151|            document.getElementById('judgeCountDisplay').textContent = app.session.judgeCount;
152|            document.getElementById('roundsDisplay').textContent = app.session.rounds;
153|            
154|            updateJudgeMonitoring();
155|            
156|            // Mise √† jour p√©riodique
157|            setInterval(() => {
158|                if (app.session.role === 'delegate' && app.session.initialized) {
159|                    const activeTab = document.querySelector('.tab-panel.active');
160|                    if (activeTab) {
161|                        const tabId = activeTab.id;
162|                        switch(tabId) {
163|                            case 'monitoringTab':
164|                                updateJudgeMonitoring();
165|                                break;
166|                            case 'recapTab':
167|                                updateRecapTable();
168|                                break;
169|                            case 'resultTab':
170|                                updateFinalResult();
171|                                break;
172|                        }
173|                    }
174|                }
175|            }, 3000);
176|        }
177|
178|        function updateFighterNames() {
179|            const redName = document.getElementById('fighterRedName').value.trim();
180|            const blueName = document.getElementById('fighterBlueName').value.trim();
181|            
182|            // Sauvegarder l'√©tat avant modification
183|            saveDelegateState('MODIFICATION NOMS TIREURS', {
184|                previousRed: app.data.fighters.red,
185|                previousBlue: app.data.fighters.blue,
186|                newRed: redName,
187|                newBlue: blueName
188|            });
189|            
190|            app.data.fighters.red = redName;
191|            app.data.fighters.blue = blueName;
192|            
193|            sendToAll({
194|                type: 'fighter_names',
195|                data: app.data.fighters
196|            }, 'normal');
197|            
198|            updateJudgeMonitoring();
199|            showNotification('üìù Noms mis √† jour', 'info', 2000);
200|        }
201|
202|        // =====================
203|        // SYST√àME D'ONGLETS D√âL√âGU√â
204|        // =====================
205|
206|        function showTab(tabName) {
207|            // Masquer tous les onglets
208|            document.querySelectorAll('.tab-panel').forEach(panel => {
209|                panel.classList.remove('active');
210|            });
211|            
212|            // D√©sactiver tous les boutons
213|            document.querySelectorAll('.tab-button').forEach(button => {
214|                button.classList.remove('active');
215|            });
216|            
217|            // Activer l'onglet s√©lectionn√©
218|            const targetTab = document.getElementById(tabName + 'Tab');
219|            if (targetTab) {
220|                targetTab.classList.add('active');
221|            }
222|            
223|            // Activer le bon bouton
224|            const buttons = document.querySelectorAll('.tab-button');
225|            const buttonIndex = ['monitoring', 'recap', 'result', 'export'].indexOf(tabName);
226|            if (buttonIndex !== -1 && buttons[buttonIndex]) {
227|                buttons[buttonIndex].classList.add('active');
228|            }
229|            
230|            // Mettre √† jour le contenu
231|            setTimeout(() => {
232|                switch(tabName) {
233|                    case 'monitoring':
234|                        updateJudgeMonitoring();
235|                        break;
236|                    case 'recap':
237|                        updateRecapTable();
238|                        break;
239|                    case 'result':
240|                        updateFinalResult();
241|                        break;
242|                    case 'export':
243|                        break;
244|                }
245|            }, 100);
246|        }
247|
248|        function updateJudgeMonitoring() {
249|            const container = document.getElementById('judgeMonitoring');
250|            if (!container) return;
251|            
252|            container.innerHTML = '<h3>üìä Monitoring des Juges - Interface CPTE Temps R√©el</h3>';
253|            
254|            const judgeCount = Object.keys(app.data.judges).length;
255|            if (judgeCount === 0) {
256|                container.innerHTML += `
257|                    <div class="message info">
258|                        <h4>üéØ En attente de connexion des juges...</h4>
259|                        <p><strong>Code de session:</strong> ${app.session.code}</p>
260|                        <p><strong>Type:</strong> ${getFightTypeLabel(app.session.fightType)}</p>
261|                        <p>Les juges doivent utiliser ce code pour se connecter.</p>
262|                    </div>
263|                `;
264|                return;
265|            }
266|            
267|            // Cr√©er une fiche pour chaque juge
268|            Object.keys(app.data.judges).forEach(judgeKey => {
269|                const judge = app.data.judges[judgeKey];
270|                const judgeContainer = createJudgeMonitoringCard(judge);
271|                container.appendChild(judgeContainer);
272|            });
273|        }
274|
275|        function createJudgeMonitoringCard(judge) {
276|            const container = document.createElement('div');
277|            container.className = `judge-sheet-container ${judge.connected ? 'connected' : ''}`;
278|            container.id = `judge-monitor-${judge.id}`;
279|            
280|            // Header avec statut
281|            const header = document.createElement('div');
282|            header.className = 'judge-sheet-header';
283|            header.innerHTML = `
284|                <div>
285|                    <h3>üë®‚Äç‚öñÔ∏è Juge ${judge.id} - ${judge.name || 'Nom non d√©fini'}</h3>
286|                    <p><strong>Num√©ro:</strong> ${judge.number || 'Non d√©fini'}</p>
287|                </div>
288|                <div class="judge-sheet-status">
289|                    <div class="status-indicator ${judge.connected ? 'connected' : ''}"></div>
290|                    <span>${judge.connected ? 'Connect√©' : 'D√©connect√©'}</span>
291|                    <span style="font-size: 11px; color: #7f8c8d; margin-left: 10px;">
292|                        ${judge.lastUpdate ? formatTime(judge.lastUpdate) : 'Jamais'}
293|                    </span>
294|                </div>
295|            `;
296|            
297|            // Table CPTE compl√®te identique √† celle des juges
298|            const table = createCompleteMonitoringTable(judge);
299|            
300|            container.appendChild(header);
301|            container.appendChild(table);
302|            
303|            return container;
304|        }
305|
306|        function createCompleteMonitoringTable(judge) {
307|            const isCombatType = isCombat();
308|            const table = document.createElement('table');
309|            table.className = 'scoring-table';
310|            table.style.fontSize = '11px';
311|            table.style.tableLayout = 'fixed';
312|            
313|            // Cr√©er l'en-t√™te
314|            let headerHTML = '';
315|            if (isCombatType) {
316|                headerHTML = `
317|                    <thead>
318|                        <tr>
319|                            <th rowspan="2" style="width: 120px;">NOTATION</th>
320|                            <th colspan="4" style="background-color: #ef5350; color: white;">COIN ROUGE</th>
321|                            <th colspan="4" style="background-color: #42a5f5; color: white;">COIN BLEU</th>
322|                        </tr>
323|                        <tr>
324|                            <th class="corner-red">Reprise</th>
325|                            <th class="corner-red">NOTE</th>
326|                            <th class="corner-red">AVT</th>
327|                            <th class="corner-red">CPTE</th>
328|                            <th class="corner-blue">Reprise</th>
329|                            <th class="corner-blue">NOTE</th>
330|                            <th class="corner-blue">AVT</th>
331|                            <th class="corner-blue">CPTE</th>
332|                        </tr>
333|                    </thead>
334|                `;
335|            } else {
336|                headerHTML = `
337|                    <thead>
338|                        <tr>
339|                            <th rowspan="2" style="width: 120px;">NOTATION</th>
340|                            <th colspan="3" style="background-color: #ef5350; color: white;">COIN ROUGE</th>
341|                            <th colspan="3" style="background-color: #42a5f5; color: white;">COIN BLEU</th>
342|                        </tr>
343|                        <tr>
344|                            <th class="corner-red">Reprise</th>
345|                            <th class="corner-red">NOTE</th>
346|                            <th class="corner-red">AVT</th>
347|                            <th class="corner-blue">Reprise</th>
348|                            <th class="corner-blue">NOTE</th>
349|                            <th class="corner-blue">AVT</th>
350|                        </tr>
351|                    </thead>
352|                `;
353|            }
354|            
355|            // Cr√©er le corps du tableau
356|            const notationText = isCombatType ? 
357|                `√âgalit√©: 2/2<br>Gagn√©: 3/2<br>Domin√©: 3/1<br>Non d√©cision: X/X<br>Avertissement: -1<br>Compte: -1<br>Bonus: +1` :
358|                `√âgalit√©: 2/2<br>Gagn√©: 3/2<br>Domin√©: 3/1<br>Non d√©cision: X/X<br>Avertissement: -1<br>Bonus: +1`;
359|            
360|            let bodyHTML = '<tbody>';
361|            
362|            // Lignes de reprises
363|            for (let i = 1; i <= app.session.rounds; i++) {
364|                const rowspanAttr = i === 1 ? `rowspan="${app.session.rounds}"` : '';
365|                const notationCell = i === 1 ? `<td ${rowspanAttr} style="vertical-align: top; font-size: 9px; padding: 3px;"><small>${notationText}</small></td>` : '';
366|                
367|                // R√©cup√©rer les donn√©es du juge
368|                const roundScore = judge.scores && judge.scores[i] ? judge.scores[i] : null;
369|                const redScore = roundScore ? roundScore.red : '-';
370|                const blueScore = roundScore ? roundScore.blue : '-';
371|                
372|                // Avertissements
373|                const redWarnings = judge.warnings && judge.warnings.red && judge.warnings.red[i] ? 'A'.repeat(judge.warnings.red[i]) : '';
374|                const blueWarnings = judge.warnings && judge.warnings.blue && judge.warnings.blue[i] ? 'A'.repeat(judge.warnings.blue[i]) : '';
375|                
376|                if (isCombatType) {
377|                    // Comptes pour les combats
378|                    const redComptes = judge.comptes && judge.comptes.red && judge.comptes.red[i] ? 'C'.repeat(judge.comptes.red[i]) : '';
379|                    const blueComptes = judge.comptes && judge.comptes.blue && judge.comptes.blue[i] ? 'C'.repeat(judge.comptes.blue[i]) : '';
380|                    
381|                    bodyHTML += `
382|                        <tr>
383|                            ${notationCell}
384|                            <td class="corner-red">${i}</td>
385|                            <td class="corner-red" style="font-weight: bold;">${redScore}</td>
386|                            <td class="corner-red" style="font-size: 10px; color: #dc3545;">${redWarnings}</td>
387|                            <td class="corner-red" style="font-size: 10px; color: #6c757d;">${redComptes}</td>
388|                            <td class="corner-blue">${i}</td>
389|                            <td class="corner-blue" style="font-weight: bold;">${blueScore}</td>
390|                            <td class="corner-blue" style="font-size: 10px; color: #dc3545;">${blueWarnings}</td>
391|                            <td class="corner-blue" style="font-size: 10px; color: #6c757d;">${blueComptes}</td>
392|                        </tr>
393|                    `;
394|                } else {
395|                    bodyHTML += `
396|                        <tr>
397|                            ${notationCell}
398|                            <td class="corner-red">${i}</td>
399|                            <td class="corner-red" style="font-weight: bold;">${redScore}</td>
400|                            <td class="corner-red" style="font-size: 10px; color: #dc3545;">${redWarnings}</td>
401|                            <td class="corner-blue">${i}</td>
402|                            <td class="corner-blue" style="font-weight: bold;">${blueScore}</td>
403|                            <td class="corner-blue" style="font-size: 10px; color: #dc3545;">${blueWarnings}</td>
404|                        </tr>
405|                    `;
406|                }
407|            }
408|            
409|            // Calculer les totaux
410|            let redSubtotal1 = 0, blueSubtotal1 = 0;
411|            let redWarningTotal = 0, blueWarningTotal = 0;
412|            let redCompteTotal = 0, blueCompteTotal = 0;
413|            
414|            // Somme des scores
415|            for (let i = 1; i <= app.session.rounds; i++) {
416|                const roundScore = judge.scores && judge.scores[i] ? judge.scores[i] : null;
417|                if (roundScore) {
418|                    redSubtotal1 += roundScore.red || 0;
419|                    blueSubtotal1 += roundScore.blue || 0;
420|                }
421|            }
422|            
423|            // Somme des avertissements
424|            if (judge.warnings) {
425|                if (judge.warnings.red) {
426|                    for (let round in judge.warnings.red) {
427|                        redWarningTotal += judge.warnings.red[round] || 0;
428|                    }
429|                }
430|                if (judge.warnings.blue) {
431|                    for (let round in judge.warnings.blue) {
432|                        blueWarningTotal += judge.warnings.blue[round] || 0;
433|                    }
434|                }
435|            }
436|            
437|            // Somme des comptes (combats seulement)
438|            if (isCombatType && judge.comptes) {
439|                if (judge.comptes.red) {
440|                    for (let round in judge.comptes.red) {
441|                        redCompteTotal += judge.comptes.red[round] || 0;
442|                    }
443|                }
444|                if (judge.comptes.blue) {
445|                    for (let round in judge.comptes.blue) {
446|                        blueCompteTotal += judge.comptes.blue[round] || 0;
447|                    }
448|                }
449|            }
450|            
451|            const redSubtotal2 = redSubtotal1 - redWarningTotal - redCompteTotal;
452|            const blueSubtotal2 = blueSubtotal1 - blueWarningTotal - blueCompteTotal;
453|            const redBonusValue = judge.bonuses ? (judge.bonuses.red || 0) : 0;
454|            const blueBonusValue = judge.bonuses ? (judge.bonuses.blue || 0) : 0;
455|            const redTotal = redSubtotal2 + redBonusValue;
456|            const blueTotal = blueSubtotal2 + blueBonusValue;
457|            
458|            // Lignes de totaux
459|            if (isCombatType) {
460|                bodyHTML += `
461|                    <tr style="background: #f8f9fa; font-size: 10px;">
462|                        <td style="text-align: left; padding-left: 5px;">Sous TOTAUX 1</td>
463|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redSubtotal1}</td>
464|                        <td class="corner-red"></td>
465|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueSubtotal1}</td>
466|                        <td class="corner-blue"></td>
467|                    </tr>
468|                    <tr style="background: #f8f9fa; font-size: 10px;">
469|                        <td style="text-align: left; padding-left: 5px;">Avertissements</td>
470|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redWarningTotal ? -redWarningTotal : 0}</td>
471|                        <td class="corner-red"></td>
472|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueWarningTotal ? -blueWarningTotal : 0}</td>
473|                        <td class="corner-blue"></td>
474|                    </tr>
475|                    <tr style="background: #f8f9fa; font-size: 10px;">
476|                        <td style="text-align: left; padding-left: 5px;">Compte</td>
477|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redCompteTotal ? -redCompteTotal : 0}</td>
478|                        <td class="corner-red"></td>
479|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueCompteTotal ? -blueCompteTotal : 0}</td>
480|                        <td class="corner-blue"></td>
481|                    </tr>
482|                    <tr style="background: #f8f9fa; font-size: 10px;">
483|                        <td style="text-align: left; padding-left: 5px;">Sous TOTAUX 2</td>
484|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redSubtotal2}</td>
485|                        <td class="corner-red"></td>
486|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueSubtotal2}</td>
487|                        <td class="corner-blue"></td>
488|                    </tr>
489|                    <tr style="background: #f8f9fa; font-size: 10px;">
490|                        <td style="text-align: left; padding-left: 5px;">Bonus</td>
491|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redBonusValue}</td>
492|                        <td class="corner-red"></td>
493|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueBonusValue}</td>
494|                        <td class="corner-blue"></td>
495|                    </tr>
496|                    <tr style="background: #e9ecef; font-size: 12px;">
497|                        <td style="text-align: left; padding-left: 5px; font-weight: bold;">TOTAUX</td>
498|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold; font-size: 14px;">${redTotal}</td>
499|                        <td class="corner-red abandon-cell ${judge.abandons && judge.abandons.red ? 'abandoned' : ''}" style="font-size: 8px;">${judge.abandons && judge.abandons.red ? 'ABANDON' : 'EN LICE'}</td>
500|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold; font-size: 14px;">${blueTotal}</td>
501|                        <td class="corner-blue abandon-cell ${judge.abandons && judge.abandons.blue ? 'abandoned' : ''}" style="font-size: 8px;">${judge.abandons && judge.abandons.blue ? 'ABANDON' : 'EN LICE'}</td>
502|                    </tr>
503|                    <tr style="background: #e1bee7; font-size: 11px;">
504|                        <td style="text-align: left; padding-left: 5px; font-weight: bold;">D√âCISION</td>
505|                        <td colspan="8" style="font-weight: bold; text-align: center;">${judge.result || 'En cours...'}</td>
506|                    </tr>
507|                `;
508|            } else {
509|                bodyHTML += `
510|                    <tr style="background: #f8f9fa; font-size: 10px;">
511|                        <td style="text-align: left; padding-left: 5px;">Sous TOTAUX 1</td>
512|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold;">${redSubtotal1}</td>
513|                        <td class="corner-red"></td>
514|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold;">${blueSubtotal1}</td>
515|                        <td class="corner-blue"></td>
516|                    </tr>
517|                    <tr style="background: #f8f9fa; font-size: 10px;">
518|                        <td style="text-align: left; padding-left: 5px;">Avertissements</td>
519|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold;">${redWarningTotal ? -redWarningTotal : 0}</td>
520|                        <td class="corner-red"></td>
521|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold;">${blueWarningTotal ? -blueWarningTotal : 0}</td>
522|                        <td class="corner-blue"></td>
523|                    </tr>
524|                    <tr style="background: #f8f9fa; font-size: 10px;">
525|                        <td style="text-align: left; padding-left: 5px;">Sous TOTAUX 2</td>
526|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold;">${redSubtotal2}</td>
527|                        <td class="corner-red"></td>
528|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold;">${blueSubtotal2}</td>
529|                        <td class="corner-blue"></td>
530|                    </tr>
531|                    <tr style="background: #f8f9fa; font-size: 10px;">
532|                        <td style="text-align: left; padding-left: 5px;">Bonus</td>
533|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold;">${redBonusValue}</td>
534|                        <td class="corner-red"></td>
535|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold;">${blueBonusValue}</td>
536|                        <td class="corner-blue"></td>
537|                    </tr>
538|                    <tr style="background: #e9ecef; font-size: 12px;">
539|                        <td style="text-align: left; padding-left: 5px; font-weight: bold;">TOTAUX</td>
540|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold; font-size: 14px;">${redTotal}</td>
541|                        <td class="corner-red abandon-cell ${judge.abandons && judge.abandons.red ? 'abandoned' : ''}" style="font-size: 8px;">${judge.abandons && judge.abandons.red ? 'ABANDON' : 'EN LICE'}</td>
542|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold; font-size: 14px;">${blueTotal}</td>
543|                        <td class="corner-blue abandon-cell ${judge.abandons && judge.abandons.blue ? 'abandoned' : ''}" style="font-size: 8px;">${judge.abandons && judge.abandons.blue ? 'ABANDON' : 'EN LICE'}</td>
544|                    </tr>
545|                    <tr style="background: #e1bee7; font-size: 11px;">
546|                        <td style="text-align: left; padding-left: 5px; font-weight: bold;">D√âCISION</td>
547|                        <td colspan="6" style="font-weight: bold; text-align: center;">${judge.result || 'En cours...'}</td>
548|                    </tr>
549|                `;
550|            }
551|            
552|            bodyHTML += '</tbody>';
553|            table.innerHTML = headerHTML + bodyHTML;
554|            
555|            return table;
556|        }
557|
558|        function updateRecapTable() {
559|            const container = document.getElementById('recapTableContainer');
560|            if (!container) return;
561|
562|            const judgeCount = Object.keys(app.data.judges).length;
563|            if (judgeCount === 0) {
564|                container.innerHTML = `
565|                    <div class="message info" style="margin: 20px 0;">
566|                        <p>En attente des donn√©es des juges connect√©s...</p>
567|                    </div>
568|                `;
569|                return;
570|            }
571|
572|            // Cr√©er le tableau r√©capitulatif
573|            let tableHTML = `
574|                <table class="recap-table">
575|                    <thead>
576|                        <tr>
577|                            <th rowspan="2">Reprise</th>
578|            `;
579|
580|            // En-t√™tes des juges
581|            Object.keys(app.data.judges).forEach(judgeKey => {
582|                const judge = app.data.judges[judgeKey];
583|                tableHTML += `<th colspan="2" class="judge-header">Juge ${judge.id} - ${judge.name || 'Non d√©fini'}</th>`;
584|            });
585|
586|            tableHTML += `</tr><tr>`;
587|            
588|            // Sous-en-t√™tes Rouge/Bleu
589|            Object.keys(app.data.judges).forEach(() => {
590|                tableHTML += `<th class="score-red">Rouge</th><th class="score-blue">Bleu</th>`;
591|            });
592|
593|            tableHTML += `</tr></thead><tbody>`;
594|
595|            // Lignes par reprise
596|            for (let round = 1; round <= app.session.rounds; round++) {
597|                tableHTML += `<tr><td class="round-cell">Reprise ${round}</td>`;
598|                
599|                Object.keys(app.data.judges).forEach(judgeKey => {
600|                    const judge = app.data.judges[judgeKey];
601|                    const roundScore = judge.scores && judge.scores[round] ? judge.scores[round] : { red: '-', blue: '-' };
602|                    tableHTML += `<td class="score-red">${roundScore.red || '-'}</td><td class="score-blue">${roundScore.blue || '-'}</td>`;
603|                });
604|                
605|                tableHTML += `</tr>`;
606|            }
607|
608|            // Ligne des totaux
609|            tableHTML += `<tr class="total-row"><td>TOTAUX</td>`;
610|            Object.keys(app.data.judges).forEach(judgeKey => {
611|                const judge = app.data.judges[judgeKey];
612|                tableHTML += `<td class="score-red">${judge.totalRed || 0}</td><td class="score-blue">${judge.totalBlue || 0}</td>`;
613|            });
614|            tableHTML += `</tr>`;
615|
616|            // Ligne des r√©sultats
617|            tableHTML += `<tr class="final-result"><td>R√âSULTAT</td>`;
618|            Object.keys(app.data.judges).forEach(judgeKey => {
619|                const judge = app.data.judges[judgeKey];
620|                const result = judge.result || 'En cours...';
621|                tableHTML += `<td colspan="2">${result}</td>`;
622|            });
623|            tableHTML += `</tr>`;
624|
625|            tableHTML += `</tbody></table>`;
626|            
627|            container.innerHTML = tableHTML;
628|        }
629|
630|        function updateFinalResult() {
631|            const container = document.getElementById('finalResultContainer');
632|            if (!container) return;
633|
634|            const judgeCount = Object.keys(app.data.judges).length;
635|            const completedJudges = Object.keys(app.data.judges).filter(k => {
636|                const judge = app.data.judges[k];
637|                return judge.result && judge.result !== 'En cours...' && judge.result !== 'En attente...';
638|            });
639|
640|            if (completedJudges.length === 0) {
641|                container.innerHTML = `
642|                    <div class="message info" style="margin: 20px 0;">
643|                        <p>En attente des d√©cisions de tous les juges...</p>
644|                    </div>
645|                `;
646|                return;
647|            }
648|
649|            if (completedJudges.length < judgeCount) {
650|                container.innerHTML = `
651|                    <div class="message warning" style="margin: 20px 0;">
652|                        <p>D√©cisions re√ßues: ${completedJudges.length}/${judgeCount}</p>
653|                        <p>En attente des autres juges...</p>
654|                    </div>
655|                `;
656|                return;
657|            }
658|
659|            // Calculer le r√©sultat final par majorit√©
660|            let redVotes = 0;
661|            let blueVotes = 0;
662|            const judgeVotes = {};
663|
664|            completedJudges.forEach(judgeKey => {
665|                const judge = app.data.judges[judgeKey];
666|                const result = judge.result.toLowerCase();
667|                
668|                if (result.includes('rouge')) {
669|                    redVotes++;
670|                    judgeVotes[judgeKey] = 'rouge';
671|                } else if (result.includes('bleu')) {
672|                    blueVotes++;
673|                    judgeVotes[judgeKey] = 'bleu';
674|                } else {
675|                    judgeVotes[judgeKey] = 'autre';
676|                }
677|            });
678|
679|            let finalResult = '';
680|            let winnerColor = '';
681|
682|            if (redVotes > blueVotes) {
683|                finalResult = `VICTOIRE COIN ROUGE - ${app.data.fighters.red || 'Tireur Rouge'}`;
684|                winnerColor = 'red';
685|            } else if (blueVotes > redVotes) {
686|                finalResult = `VICTOIRE COIN BLEU - ${app.data.fighters.blue || 'Tireur Bleu'}`;
687|                winnerColor = 'blue';
688|            } else {
689|                finalResult = '√âGALIT√â - D√©cision partag√©e';
690|                winnerColor = 'tie';
691|            }
692|
693|            const majorityDetails = Object.keys(judgeVotes).map(judgeKey => {
694|                const judge = app.data.judges[judgeKey];
695|                const vote = judgeVotes[judgeKey];
696|                return `
697|                    <div class="judge-vote">
698|                        <span>Juge ${judge.id} (${judge.name})</span>
699|                        <span class="${vote === 'rouge' ? 'winner' : ''}">${judge.result}</span>
700|                    </div>
701|

Action: file_editor view /app/SAVATE-PART-04
Observation: /app/SAVATE-PART-04:
1|                `;
2|            }).join('');
3|
4|            container.innerHTML = `
5|                <div class="final-result-container">
6|                    <div class="final-result-title">üèÜ R√âSULTAT FINAL OFFICIEL</div>
7|                    <div class="final-result-details">${finalResult}</div>
8|                    <div style="font-size: 16px; margin: 10px 0;">
9|                        Majorit√©: ${Math.max(redVotes, blueVotes)}/${completedJudges.length} juges
10|                    </div>
11|                    
12|                    <div class="majority-details">
13|                        <h4 style="margin-bottom: 15px;">D√©tail des votes des juges:</h4>
14|                        ${majorityDetails}
15|                    </div>
16|                    
17|                    <div style="margin-top: 20px; font-size: 14px; color: #666;">
18|                        Calcul automatique bas√© sur la majorit√© des d√©cisions
19|                    </div>
20|                </div>
21|            `;
22|
23|            // Sauvegarder le r√©sultat final
24|            app.data.results = {
25|                finalResult: finalResult,
26|                redVotes: redVotes,
27|                blueVotes: blueVotes,
28|                judgeVotes: judgeVotes,
29|                timestamp: Date.now()
30|            };
31|        }
32|
33|        // =====================
34|        // FONCTIONS D'EXPORT D√âL√âGU√â
35|        // =====================
36|
37|        function exportCompleteMatchSheet() {
38|            // Export Excel complet
39|            const data = [
40|                ['FEUILLE DE MATCH COMPL√àTE - SAVATE BOXE FRAN√áAISE'],
41|                [''],
42|                ['Session:', app.session.code],
43|                ['Type:', getFightTypeLabel(app.session.fightType)],
44|                ['Date:', new Date().toLocaleDateString('fr-FR')],
45|                [''],
46|                ['Tireur Rouge:', app.data.fighters.red || 'Non d√©fini'],
47|                ['Tireur Bleu:', app.data.fighters.blue || 'Non d√©fini'],
48|                ['']
49|            ];
50|
51|            // Ajouter les donn√©es de chaque juge
52|            Object.keys(app.data.judges).forEach(judgeKey => {
53|                const judge = app.data.judges[judgeKey];
54|                data.push([`JUGE ${judge.id} - ${judge.name}`]);
55|                data.push(['R√©sultat:', judge.result || 'En cours']);
56|                data.push(['Total Rouge:', judge.totalRed || 0]);
57|                data.push(['Total Bleu:', judge.totalBlue || 0]);
58|                data.push(['']);
59|            });
60|
61|            if (app.data.results) {
62|                data.push(['R√âSULTAT FINAL:', app.data.results.finalResult]);
63|                data.push(['Votes Rouge:', app.data.results.redVotes]);
64|                data.push(['Votes Bleu:', app.data.results.blueVotes]);
65|            }
66|
67|            downloadCSV(data, `feuille_match_complete_${app.session.code}_${formatDate(Date.now())}.csv`);
68|            showNotification('üìä Export Excel complet r√©alis√©!', 'success');
69|        }
70|
71|        function exportOfficialReport() {
72|            // Export Markdown officiel
73|            let markdown = '# RAPPORT OFFICIEL - SAVATE BOXE FRAN√áAISE\n\n';
74|            markdown += `## Informations de la rencontre\n`;
75|            markdown += `- **Code de session:** ${app.session.code}\n`;
76|            markdown += `- **Type:** ${getFightTypeLabel(app.session.fightType)}\n`;
77|            markdown += `- **Date:** ${new Date().toLocaleDateString('fr-FR')}\n`;
78|            markdown += `- **Heure:** ${new Date().toLocaleTimeString('fr-FR')}\n\n`;
79|            
80|            markdown += `## Tireurs\n`;
81|            markdown += `- **Coin Rouge:** ${app.data.fighters.red || 'Non d√©fini'}\n`;
82|            markdown += `- **Coin Bleu:** ${app.data.fighters.blue || 'Non d√©fini'}\n\n`;
83|            
84|            markdown += `## Juges connect√©s\n`;
85|            Object.keys(app.data.judges).forEach(judgeKey => {
86|                const judge = app.data.judges[judgeKey];
87|                markdown += `### Juge ${judge.id} - ${judge.name}\n`;
88|                markdown += `- **Num√©ro:** ${judge.number}\n`;
89|                markdown += `- **R√©sultat:** ${judge.result || 'En cours'}\n`;
90|                markdown += `- **Score Rouge:** ${judge.totalRed || 0}\n`;
91|                markdown += `- **Score Bleu:** ${judge.totalBlue || 0}\n\n`;
92|            });
93|
94|            if (app.data.results) {
95|                markdown += `## üèÜ R√âSULTAT FINAL OFFICIEL\n`;
96|                markdown += `**${app.data.results.finalResult}**\n\n`;
97|                markdown += `- Votes pour le coin rouge: ${app.data.results.redVotes}\n`;
98|                markdown += `- Votes pour le coin bleu: ${app.data.results.blueVotes}\n\n`;
99|            }
100|
101|            markdown += `---\n_Rapport g√©n√©r√© le ${new Date().toLocaleString('fr-FR')}_`;
102|            
103|            downloadText(markdown, `rapport_officiel_${app.session.code}_${formatDate(Date.now())}.md`);
104|            showNotification('üìã Rapport officiel export√©!', 'success');
105|        }
106|
107|        function exportRawData() {
108|            // Export JSON complet
109|            const exportData = {
110|                session: app.session,
111|                fighters: app.data.fighters,
112|                judges: app.data.judges,
113|                results: app.data.results,
114|                changeLog: app.data.changeLog,
115|                exportTimestamp: Date.now(),
116|                version: app.version
117|            };
118|
119|            downloadJSON(exportData, `donnees_brutes_${app.session.code}_${formatDate(Date.now())}.json`);
120|            showNotification('üìù Donn√©es brutes export√©es!', 'success');
121|        }
122|
123|        function printFinalResult() {
124|            // Version imprimable
125|            if (!app.data.results) {
126|                showNotification('‚ö†Ô∏è Aucun r√©sultat final √† imprimer', 'warning');
127|                return;
128|            }
129|
130|            const printWindow = window.open('', '_blank');
131|            printWindow.document.write(`
132|                <!DOCTYPE html>
133|                <html>
134|                <head>
135|                    <title>R√©sultat Final - ${app.session.code}</title>
136|                    <style>
137|                        body { font-family: Arial, sans-serif; padding: 20px; }
138|                        h1 { text-align: center; color: #2c3e50; }
139|                        .result { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
140|                        .details { margin: 20px 0; }
141|                        .judge-vote { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd; }
142|                        .winner { font-weight: bold; color: #27ae60; }
143|                    </style>
144|                </head>
145|                <body>
146|                    <h1>üèÜ R√âSULTAT FINAL OFFICIEL</h1>
147|                    <div class="result">
148|                        <h2>${app.data.results.finalResult}</h2>
149|                        <p><strong>Majorit√©:</strong> ${Math.max(app.data.results.redVotes, app.data.results.blueVotes)}/${Object.keys(app.data.judges).length} juges</p>
150|                    </div>
151|                    
152|                    <div class="details">
153|                        <h3>D√©tail des votes:</h3>
154|                        ${Object.keys(app.data.results.judgeVotes).map(judgeKey => {
155|                            const judge = app.data.judges[judgeKey];
156|                            return `<div class="judge-vote"><span>Juge ${judge.id} (${judge.name})</span><span class="winner">${judge.result}</span></div>`;
157|                        }).join('')}
158|                    </div>
159|                    
160|                    <div style="margin-top: 40px; text-align: center; color: #666;">
161|                        Session: ${app.session.code} - ${new Date().toLocaleString('fr-FR')}
162|                    </div>
163|                
164|    
165|    <script>
166|
167|        console.log('üöÄ SAVATE OFFICIALS - Interface CPTE Compl√®te Initialis√©e');
168|        console.log('üì± Version: 4.2.0 - Interface CPTE Professionnelle Finalis√©e');
169|        console.log('üîß Fonctionnalit√©s: WebRTC P2P + CPTE Compl√®te + Onglets D√©l√©gu√© + Validation + Export');
170|
171|        // =====================
172|        // VARIABLES GLOBALES COMPL√àTES
173|        // =====================
174|        
175|        let app = {
176|            version: '4.2.0',
177|            webrtc: {
178|                peer: null,
179|                connections: new Map(),
180|                isHost: false,
181|                peerId: null,
182|                lastSyncTime: Date.now(),
183|                syncCount: 0,
184|                syncErrors: 0,
185|                reconnectAttempts: 0,
186|                maxReconnectAttempts: 5,
187|                connectionQuality: 'excellent',
188|                latency: 0
189|            },
190|            session: {
191|                id: '',
192|                code: '',
193|                fightType: 'assaut',
194|                judgeCount: 3,
195|                rounds: 3,
196|                initialized: false,
197|                role: '',
198|                judgeId: null,
199|                judgeName: '',
200|                judgeNumber: '',
201|                deviceId: 'device_' + Math.random().toString(36).substr(2, 9),
202|                startTime: null,
203|                status: 'inactive'
204|            },
205|            data: {
206|                judges: {},
207|                fighters: { red: '', blue: '' },
208|                connectedDevices: new Set(),
209|                changeLog: [],
210|                results: null
211|            },
212|            monitoring: {
213|                syncMetrics: {
214|                    totalSync: 0,
215|                    syncErrors: 0,
216|                    uptimeStart: Date.now()
217|                }
218|            }
219|        };
220|
221|        // Variables CPTE (identiques au fichier SO J2 BONNE)
222|        const warnings = { red: {}, blue: {} };
223|        const comptes = { red: {}, blue: {} };
224|        const abandons = { red: false, blue: false };
225|        let actionHistory = [];
226|        let delegateActionHistory = []; // Historique des actions du d√©l√©gu√©
227|        let activeRounds = 3;
228|        
229|        // =====================
230|        // UTILITAIRES
231|        // =====================
232|        
233|        function generateSessionId() {
234|            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
235|        }
236|
237|        function generateUniqueCode() {
238|            return Math.floor(1000 + Math.random() * 9000).toString();
239|        }
240|
241|        function getFightTypeLabel(type) {
242|            const labels = {
243|                'assaut': 'Assaut (3 reprises)',
244|                'combat2espoirs': 'Combat 2√®me S√©rie Espoirs (3 reprises)',
245|                'combat2seniors': 'Combat 2√®me S√©rie Seniors (4 reprises)', 
246|                'combat1juniors': 'Combat 1√®re S√©rie Juniors (4 reprises)',
247|                'combat1seniors': 'Combat 1√®re S√©rie Seniors (5 reprises)'
248|            };
249|            return labels[type] || type;
250|        }
251|
252|        function getRoundsFromFightType(fightType) {
253|            switch(fightType) {
254|                case 'assaut':
255|                case 'combat2espoirs':
256|                    return 3;
257|                case 'combat2seniors':
258|                case 'combat1juniors':
259|                    return 4;
260|                case 'combat1seniors':
261|                    return 5;
262|                default:
263|                    return 3;
264|            }
265|        }
266|
267|        function isCombat() {
268|            return app.session.fightType !== 'assaut';
269|        }
270|
271|        function formatTime(timestamp) {
272|            return new Date(timestamp).toLocaleTimeString('fr-FR');
273|        }
274|
275|        function formatDate(timestamp) {
276|            return new Date(timestamp).toISOString().split('T')[0];
277|        }
278|
279|        function safeGetElement(id) {
280|            return document.getElementById(id);
281|        }
282|
283|        function showNotification(message, type = 'info', duration = 5000) {
284|            const notification = document.createElement('div');
285|            notification.className = `message ${type}`;
286|            notification.innerHTML = `
287|                ${message}
288|                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; float: right; cursor: pointer;">√ó</button>
289|            `;
290|            
291|            const container = document.querySelector('.app-container');
292|            container.insertBefore(notification, container.firstChild);
293|            
294|            setTimeout(() => {
295|                if (notification.parentNode) {
296|                    notification.remove();
297|                }
298|            }, duration);
299|        }
300|
301|        // =====================
302|        // GESTION HISTORIQUE D√âL√âGU√â
303|        // =====================
304|
305|        function saveDelegateState(actionType, actionData = {}) {
306|            const state = {
307|                timestamp: Date.now(),
308|                actionType: actionType,
309|                actionData: actionData,
310|                session: JSON.parse(JSON.stringify(app.session)),
311|                fighters: JSON.parse(JSON.stringify(app.data.fighters)),
312|                judges: JSON.parse(JSON.stringify(app.data.judges)),
313|                results: JSON.parse(JSON.stringify(app.data.results))
314|            };
315|            
316|            delegateActionHistory.push(state);
317|            
318|            // Limiter l'historique √† 20 actions pour √©viter la surcharge m√©moire
319|            if (delegateActionHistory.length > 20) {
320|                delegateActionHistory.shift();
321|            }
322|            
323|            // Activer le bouton annuler
324|            const undoButton = document.getElementById('delegateUndoButton');
325|            if (undoButton) {
326|                undoButton.disabled = false;
327|                undoButton.textContent = `‚Ü∂ ANNULER: ${actionType}`;
328|            }
329|            
330|            console.log(`üíæ √âtat d√©l√©gu√© sauvegard√©: ${actionType}`, state);
331|        }
332|
333|        function undoDelegateLastAction() {
334|            if (delegateActionHistory.length === 0) {
335|                showNotification('‚ùå Aucune action √† annuler', 'warning');
336|                return;
337|            }
338|            
339|            const previousState = delegateActionHistory.pop();
340|            
341|            console.log(`‚Ü∂ Annulation action d√©l√©gu√©: ${previousState.actionType}`);
342|            
343|            // Restaurer l'√©tat pr√©c√©dent
344|            app.session = previousState.session;
345|            app.data.fighters = previousState.fighters;
346|            app.data.judges = previousState.judges;
347|            app.data.results = previousState.results;
348|            
349|            // Envoyer la restauration aux juges connect√©s
350|            sendToAll({
351|                type: 'delegate_undo_action',
352|                data: {
353|                    actionType: previousState.actionType,
354|                    session: app.session,
355|                    fighters: app.data.fighters,
356|                    timestamp: Date.now()
357|                }
358|            }, 'high');
359|            
360|            // Mettre √† jour l'interface d√©l√©gu√©
361|            updateDelegateInterface();
362|            
363|            // Mettre √† jour le bouton annuler
364|            const undoButton = document.getElementById('delegateUndoButton');
365|            if (undoButton) {
366|                if (delegateActionHistory.length === 0) {
367|                    undoButton.disabled = true;
368|                    undoButton.textContent = '‚Ü∂ ANNULER DERNI√àRE ACTION';
369|                } else {
370|                    const nextAction = delegateActionHistory[delegateActionHistory.length - 1];
371|                    undoButton.textContent = `‚Ü∂ ANNULER: ${nextAction.actionType}`;
372|                }
373|            }
374|            
375|            showNotification(`‚Ü∂ Action "${previousState.actionType}" annul√©e avec succ√®s`, 'success');
376|        }
377|
378|        function updateDelegateInterface() {
379|            // Mettre √† jour les noms des tireurs
380|            const redName = document.getElementById('fighterRedName');
381|            const blueName = document.getElementById('fighterBlueName');
382|            if (redName) redName.value = app.data.fighters.red || '';
383|            if (blueName) blueName.value = app.data.fighters.blue || '';
384|            
385|            // Mettre √† jour le monitoring et les tableaux
386|            if (app.session.role === 'delegate' && app.session.initialized) {
387|                updateJudgeMonitoring();
388|                updateRecapTable();
389|                updateFinalResult();
390|            }
391|        }
392|
393|        // =====================
394|        // WEBRTC SYST√àME
395|        // =====================
396|        
397|        function waitForPeerJS(maxWaitTime = 15000) {
398|            return new Promise((resolve, reject) => {
399|                let elapsed = 0;
400|                const checkInterval = 100;
401|                
402|                const checkPeerJS = () => {
403|                    if (typeof Peer !== 'undefined') {
404|                        console.log('‚úÖ PeerJS charg√©');
405|                        resolve();
406|                        return;
407|                    }
408|                    
409|                    elapsed += checkInterval;
410|                    if (elapsed >= maxWaitTime) {
411|                        reject(new Error('PeerJS timeout'));
412|                        return;
413|                    }
414|                    
415|                    setTimeout(checkPeerJS, checkInterval);
416|                };
417|                
418|                checkPeerJS();
419|            });
420|        }
421|
422|        function initializeWebRTC() {
423|            return new Promise((resolve, reject) => {
424|                waitForPeerJS().then(() => {
425|                    try {
426|                        const baseId = app.session.role === 'delegate' ? 
427|                            `delegate_${app.session.code}` : 
428|                            `judge_${app.session.code}_${Date.now()}`;
429|                        
430|                        console.log('üåê Initialisation WebRTC:', baseId);
431|                        
432|                        app.webrtc.peer = new Peer(baseId, {
433|                            config: {
434|                                'iceServers': [
435|                                    { urls: 'stun:stun.l.google.com:19302' },
436|                                    { urls: 'stun:stun1.l.google.com:19302' }
437|                                ]
438|                            }
439|                        });
440|
441|                        app.webrtc.peer.on('open', function(id) {
442|                            console.log('‚úÖ Peer WebRTC cr√©√©:', id);
443|                            app.webrtc.peerId = id;
444|                            updateSyncIndicator('Connect√© WebRTC', 'connected');
445|                            
446|                            if (app.session.role === 'delegate') {
447|                                app.webrtc.isHost = true;
448|                            }
449|                            
450|                            resolve(id);
451|                        });
452|
453|                        app.webrtc.peer.on('connection', function(conn) {
454|                            console.log('üìû Connexion entrante:', conn.peer);
455|                            handleIncomingConnection(conn);
456|                        });
457|
458|                        app.webrtc.peer.on('error', function(err) {
459|                            console.error('‚ùå Erreur WebRTC:', err);
460|                            updateSyncIndicator('Erreur: ' + err.type, 'offline');
461|                            
462|                            if (err.type === 'peer-unavailable') {
463|                                showNotification('‚ùå Session introuvable. V√©rifiez le code.', 'error');
464|                            } else {
465|                                showNotification('‚ùå Erreur WebRTC: ' + err.type, 'error');
466|                            }
467|                            
468|                            reject(err);
469|                        });
470|
471|                        setTimeout(() => {
472|                            if (!app.webrtc.peerId) {
473|                                reject(new Error('Timeout WebRTC'));
474|                            }
475|                        }, 15000);
476|
477|                    } catch (error) {
478|                        console.error('‚ùå Erreur init WebRTC:', error);
479|                        reject(error);
480|                    }
481|                }).catch(error => {
482|                    console.error('‚ùå PeerJS indisponible:', error);
483|                    updateSyncIndicator('‚ùå PeerJS indisponible', 'offline');
484|                    showNotification('‚ùå Impossible de charger PeerJS', 'error');
485|                    reject(error);
486|                });
487|            });
488|        }
489|
490|        function handleIncomingConnection(conn) {
491|            app.webrtc.connections.set(conn.peer, conn);
492|            
493|            conn.on('open', function() {
494|                console.log('‚úÖ Connexion √©tablie:', conn.peer);
495|                updatePeersList();
496|                
497|                if (app.session.role === 'delegate') {
498|                    sendSessionDataToNewPeer(conn);
499|                }
500|            });
501|
502|            conn.on('data', function(data) {
503|                handleWebRTCMessage(data, conn.peer, conn);
504|            });
505|
506|            conn.on('close', function() {
507|                console.log('üîå Connexion ferm√©e:', conn.peer);
508|                app.webrtc.connections.delete(conn.peer);
509|                updatePeersList();
510|                cleanupJudgeData(conn.peer);
511|            });
512|
513|            conn.on('error', function(err) {
514|                console.error('‚ùå Erreur connexion:', err);
515|                app.webrtc.connections.delete(conn.peer);
516|                updatePeersList();
517|            });
518|        }
519|
520|        function connectToPeer(peerId) {
521|            return new Promise((resolve, reject) => {
522|                try {
523|                    console.log('üîó Connexion au peer:', peerId);
524|                    updateSyncIndicator('Connexion...', 'syncing');
525|                    
526|                    const conn = app.webrtc.peer.connect(peerId, {
527|                        reliable: true,
528|                        serialization: 'json'
529|                    });
530|                    
531|                    conn.on('open', function() {
532|                        console.log('‚úÖ Connect√© au d√©l√©gu√©:', peerId);
533|                        app.webrtc.connections.set(peerId, conn);
534|                        updateSyncIndicator('Connect√©', 'connected');
535|                        updatePeersList();
536|                        
537|                        sendJudgeConnectionData(conn);
538|                        resolve(conn);
539|                    });
540|
541|                    conn.on('data', function(data) {
542|                        handleWebRTCMessage(data, peerId, conn);
543|                    });
544|
545|                    conn.on('close', function() {
546|                        console.log('üîå Connexion ferm√©e');
547|                        app.webrtc.connections.delete(peerId);
548|                        updateSyncIndicator('D√©connect√©', 'offline');
549|                        updatePeersList();
550|                    });
551|
552|                    conn.on('error', function(err) {
553|                        console.error('‚ùå Erreur connexion:', err);
554|                        updateSyncIndicator('Erreur', 'offline');
555|                        reject(err);
556|                    });
557|
558|                    setTimeout(() => {
559|                        if (!app.webrtc.connections.has(peerId)) {
560|                            reject(new Error('Timeout connexion'));
561|                        }
562|                    }, 20000);
563|
564|                } catch (error) {
565|                    console.error('‚ùå Erreur connectToPeer:', error);
566|                    reject(error);
567|                }
568|            });
569|        }
570|
571|        function sendToAll(message, priority = 'normal') {
572|            const enrichedMessage = {
573|                ...message,
574|                timestamp: Date.now(),
575|                from: app.webrtc.peerId,
576|                fromRole: app.session.role,
577|                sessionCode: app.session.code,
578|                priority: priority
579|            };
580|            
581|            let sentCount = 0;
582|            let errorCount = 0;
583|            
584|            app.webrtc.connections.forEach((conn, peerId) => {
585|                if (conn.open) {
586|                    try {
587|                        conn.send(enrichedMessage);
588|                        sentCount++;
589|                    } catch (error) {
590|                        console.error('‚ùå Erreur envoi:', peerId, error);
591|                        errorCount++;
592|                    }
593|                } else {
594|                    errorCount++;
595|                }
596|            });
597|            
598|            console.log(`üì§ Message envoy√© √† ${sentCount} peers:`, message.type);
599|            return { sent: sentCount, errors: errorCount };
600|        }
601|
602|        function handleWebRTCMessage(message, fromPeer, conn) {
603|            console.log('üì• Message re√ßu:', message.type, 'de', fromPeer);
604|            
605|            try {
606|                switch (message.type) {
607|                    case 'judge_connection':
608|                        handleJudgeConnection(message.data, fromPeer);
609|                        break;
610|                    case 'judge_data':
611|                        receiveJudgeData(message.data, message);
612|                        break;
613|                    case 'session_data':
614|                        receiveSessionData(message.data);
615|                        break;
616|                    case 'fighter_names':
617|                        receiveFighterNames(message.data);
618|                        break;
619|                    case 'partial_reset_command':
620|                        if (app.session.role === 'judge') {
621|                            console.log('üî• Commande de r√©initialisation partielle re√ßue du d√©l√©gu√©');
622|                            app.data.fighters = message.data.fighters;
623|                            updateFighterNamesInInterface();
624|                            resetJudgeFormData();
625|                            showNotification('üîÑ R√©initialisation effectu√©e par le d√©l√©gu√©', 'warning');
626|                        }
627|                        break;
628|                    case 'delegate_undo_action':
629|                        if (app.session.role === 'judge') {
630|                            console.log('‚Ü∂ Annulation d\'action re√ßue du d√©l√©gu√©:', message.data.actionType);
631|                            if (message.data.session) {
632|                                const currentJudgeName = app.session.judgeName;
633|                                const currentJudgeNumber = app.session.judgeNumber;
634|                                const currentJudgeId = app.session.judgeId;
635|                                const currentRole = app.session.role;
636|                                
637|                                app.session = { ...app.session, ...message.data.session };
638|                                
639|                                app.session.judgeName = currentJudgeName;
640|                                app.session.judgeNumber = currentJudgeNumber;
641|                                app.session.judgeId = currentJudgeId;
642|                                app.session.role = currentRole;
643|                            }
644|                            
645|                            if (message.data.fighters) {
646|                                app.data.fighters = message.data.fighters;
647|                                updateFighterNamesInInterface();
648|                            }
649|                            
650|                            updateJudgeRounds();
651|                            createJudgeTableStructure();
652|                            
653|                            showNotification(`‚Ü∂ Action "${message.data.actionType}" annul√©e par le d√©l√©gu√©`, 'info');
654|                        }
655|                        break;
656|                    case 'session_reset_complete':
657|                        if (app.session.role === 'judge') {
658|                            console.log('üî• Session r√©initialis√©e par le d√©l√©gu√©');
659|                            showNotification('‚ö†Ô∏è Session r√©initialis√©e par le d√©l√©gu√©. D√©connexion...', 'warning');
660|                            setTimeout(() => {
661|                                resetJudgeConnection();
662|                            }, 2000);
663|                        }
664|                        break;
665|                    case 'judge_disconnect':
666|                        if (app.session.role === 'delegate') {
667|                            console.log('üî• Juge d√©connect√©:', message.data);
668|                            const judgeKey = `judge${message.data.judgeId}`;
669|                            
670|                            if (app.data.judges[judgeKey]) {
671|                                app.data.judges[judgeKey].connected = false;
672|                                app.data.judges[judgeKey].lastUpdate = Date.now();
673|                                updateJudgeMonitoring();
674|                                showNotification(`üö™ ${message.data.name} s'est d√©connect√©`, 'info');
675|                            }
676|                        }
677|                        break;
678|                    default:
679|                        console.warn('‚ö†Ô∏è Type message non reconnu:', message.type);
680|                }
681|            } catch (error) {
682|                console.error('‚ùå Erreur traitement message:', error);
683|            }
684|        }
685|
686|        function handleJudgeConnection(connectionData, fromPeer) {
687|            console.log('üì• Connexion juge:', connectionData);
688|            const judgeKey = `judge${connectionData.judgeId}`;
689|            
690|            if (!app.data.judges[judgeKey]) {
691|                app.data.judges[judgeKey] = {
692|                    id: connectionData.judgeId,
693|                    scores: {},
694|                    warnings: { red: {}, blue: {} },
695|                    comptes: { red: {}, blue: {} },
696|                    abandons: { red: false, blue: false },
697|                    bonuses: { red: 0, blue: 0 },
698|                    totalRed: 0,
699|                    totalBlue: 0,
700|                    result: 'En attente...'
701|

Action: file_editor view /app/SAVATE-PART-05
Observation: /app/SAVATE-PART-05:
1|                };
2|            }
3|            
4|            Object.assign(app.data.judges[judgeKey], {
5|                connected: connectionData.connected,
6|                name: connectionData.name || 'Nom non d√©fini',
7|                number: connectionData.number || 'Non d√©fini',
8|                peerId: fromPeer,
9|                lastUpdate: Date.now(),
10|                connectionTime: Date.now()
11|            });
12|            
13|            if (app.session.role === 'delegate') {
14|                updateJudgeMonitoring();
15|                updateRecapTable();
16|                updateFinalResult();
17|            }
18|            
19|            showNotification(`üéâ Juge ${connectionData.judgeId} (${connectionData.name}) connect√©!`, 'success');
20|        }
21|
22|        function receiveJudgeData(judgeData, fullMessage) {
23|            console.log('üì• Donn√©es juge re√ßues:', judgeData);
24|            const judgeKey = `judge${judgeData.judgeId}`;
25|            
26|            if (!app.data.judges[judgeKey]) {
27|                app.data.judges[judgeKey] = {};
28|            }
29|            
30|            app.data.judges[judgeKey] = {
31|                ...app.data.judges[judgeKey],
32|                ...judgeData,
33|                lastUpdate: Date.now(),
34|                syncSource: 'webrtc'
35|            };
36|            
37|            if (app.session.role === 'delegate') {
38|                updateJudgeMonitoring();
39|                updateRecapTable();
40|                updateFinalResult();
41|            }
42|            
43|            showNotification(`üì° Juge ${judgeData.judgeId} synchronis√©`, 'success', 3000);
44|        }
45|
46|        function receiveSessionData(sessionData) {
47|            console.log('üì• Donn√©es session:', sessionData);
48|            
49|            if (sessionData.session) {
50|                const currentJudgeName = app.session.judgeName;
51|                const currentJudgeNumber = app.session.judgeNumber;
52|                
53|                app.session = { ...app.session, ...sessionData.session };
54|                
55|                if (currentJudgeName && app.session.role === 'judge') {
56|                    app.session.judgeName = currentJudgeName;
57|                }
58|                if (currentJudgeNumber && app.session.role === 'judge') {
59|                    app.session.judgeNumber = currentJudgeNumber;
60|                }
61|            }
62|            
63|            if (sessionData.fighters) {
64|                app.data.fighters = sessionData.fighters;
65|                updateFighterNamesInInterface();
66|            }
67|            
68|            if (sessionData.judges) {
69|                app.data.judges = sessionData.judges;
70|            }
71|            
72|            if (app.session.role === 'judge') {
73|                updateJudgeRounds();
74|                createJudgeTableStructure();
75|                updateFighterNamesInInterface();
76|            }
77|        }
78|
79|        function receiveFighterNames(fighterData) {
80|            console.log('üì• Noms tireurs:', fighterData);
81|            app.data.fighters = { ...app.data.fighters, ...fighterData };
82|            updateFighterNamesInInterface();
83|        }
84|
85|        function sendJudgeConnectionData(conn) {
86|            try {
87|                const connectionData = {
88|                    judgeId: app.session.judgeId,
89|                    name: app.session.judgeName,
90|                    number: app.session.judgeNumber,
91|                    connected: true,
92|                    timestamp: Date.now(),
93|                    deviceId: app.session.deviceId
94|                };
95|                
96|                conn.send({
97|                    type: 'judge_connection',
98|                    data: connectionData,
99|                    timestamp: Date.now(),
100|                    from: app.webrtc.peerId,
101|                    sessionCode: app.session.code
102|                });
103|                
104|                console.log('üì§ Donn√©es connexion juge envoy√©es');
105|            } catch (error) {
106|                console.error('‚ùå Erreur envoi connexion:', error);
107|            }
108|        }
109|
110|        function sendSessionDataToNewPeer(conn) {
111|            try {
112|                const sessionData = {
113|                    session: {
114|                        id: app.session.id,
115|                        code: app.session.code,
116|                        fightType: app.session.fightType,
117|                        judgeCount: app.session.judgeCount,
118|                        rounds: app.session.rounds,
119|                        status: app.session.status
120|                    },
121|                    fighters: app.data.fighters,
122|                    judges: app.data.judges,
123|                    timestamp: Date.now()
124|                };
125|                
126|                conn.send({
127|                    type: 'session_data',
128|                    data: sessionData,
129|                    timestamp: Date.now(),
130|                    from: app.webrtc.peerId,
131|                    sessionCode: app.session.code
132|                });
133|                
134|                console.log('üì§ Donn√©es session envoy√©es');
135|            } catch (error) {
136|                console.error('‚ùå Erreur envoi session:', error);
137|            }
138|        }
139|
140|        function updateSyncIndicator(status = null, type = null) {
141|            const indicator = document.getElementById('syncIndicator');
142|            const statusSpan = document.getElementById('syncStatus');
143|            const devicesCount = document.getElementById('devicesCount');
144|            const icon = document.getElementById('syncIcon');
145|            
146|            if (indicator && !indicator.classList.contains('hidden')) {
147|                if (status) {
148|                    statusSpan.textContent = status;
149|                }
150|                
151|                if (type) {
152|                    indicator.className = `sync-indicator ${type}`;
153|                    
154|                    switch(type) {
155|                        case 'connected':
156|                            icon.textContent = '‚úÖ';
157|                            break;
158|                        case 'syncing':
159|                            icon.textContent = 'üîÑ';
160|                            break;
161|                        case 'offline':
162|                            icon.textContent = '‚ùå';
163|                            break;
164|                        default:
165|                            icon.textContent = '‚ö°';
166|                    }
167|                }
168|                
169|                const deviceCount = app.data.connectedDevices.size;
170|                const judgeCount = Object.keys(app.data.judges).filter(k => app.data.judges[k].connected).length;
171|                devicesCount.textContent = `${deviceCount} appareils ‚Ä¢ ${judgeCount} juges`;
172|            }
173|        }
174|
175|        function updatePeersList() {
176|            app.data.connectedDevices.clear();
177|            app.webrtc.connections.forEach((conn, peerId) => {
178|                if (conn.open) {
179|                    app.data.connectedDevices.add(peerId);
180|                }
181|            });
182|            updateSyncIndicator();
183|        }
184|
185|        function cleanupJudgeData(peerId) {
186|            Object.keys(app.data.judges).forEach(judgeKey => {
187|                const judge = app.data.judges[judgeKey];
188|                if (judge.peerId === peerId) {
189|                    judge.connected = false;
190|                    judge.lastUpdate = Date.now();
191|                }
192|            });
193|            
194|            if (app.session.role === 'delegate') {
195|                updateJudgeMonitoring();
196|            }
197|        }
198|
199|        // =====================
200|        // GESTIONNAIRE DE SESSIONS
201|        // =====================
202|        
203|        function selectRole(role) {
204|            app.session.role = role;
205|            document.getElementById('roleSelector').classList.add('hidden');
206|            
207|            if (role === 'delegate') {
208|                document.getElementById('delegateInterface').classList.remove('hidden');
209|                showNotification('üëë Mode d√©l√©gu√© activ√©', 'success');
210|            } else if (role === 'judge') {
211|                document.getElementById('judgeAccessSection').classList.remove('hidden');
212|                showNotification('‚öñÔ∏è Mode juge activ√©', 'info');
213|            }
214|        }
215|
216|        function goBack() {
217|            document.getElementById('judgeAccessSection').classList.add('hidden');
218|            document.getElementById('delegateInterface').classList.add('hidden');
219|            document.getElementById('judgeInterface').classList.add('hidden');
220|            document.getElementById('roleSelector').classList.remove('hidden');
221|            document.getElementById('contentArea').style.display = 'block';
222|            
223|            const syncIndicator = document.getElementById('syncIndicator');
224|            if (syncIndicator) syncIndicator.classList.add('hidden');
225|            
226|            app.session.role = '';
227|        }
228|
229|        function createSession() {
230|            console.log('üöÄ Cr√©ation session...');
231|            
232|            const createButton = document.getElementById('createSessionButton');
233|            createButton.disabled = true;
234|            createButton.innerHTML = '<div class="loading-spinner"></div> Cr√©ation...';
235|            
236|            app.session.fightType = document.querySelector('input[name="fightType"]:checked').value;
237|            app.session.judgeCount = parseInt(document.querySelector('input[name="judgeCount"]:checked').value);
238|            app.session.rounds = getRoundsFromFightType(app.session.fightType);
239|            
240|            app.session.id = generateSessionId();
241|            app.session.code = generateUniqueCode();
242|            app.session.initialized = true;
243|            app.session.role = 'delegate';
244|            app.session.startTime = Date.now();
245|            app.session.status = 'active';
246|            
247|            initializeWebRTC().then(() => {
248|                console.log('‚úÖ WebRTC d√©l√©gu√© initialis√©');
249|                
250|                document.getElementById('configSection').classList.add('hidden');
251|                showDelegateInterface();
252|                
253|                showNotification('‚úÖ Session WebRTC cr√©√©e!', 'success');
254|                
255|                createButton.disabled = false;
256|                createButton.innerHTML = 'üöÄ Cr√©er Session WebRTC';
257|                
258|            }).catch(error => {
259|                console.error('‚ùå Erreur WebRTC:', error);
260|                showNotification('‚ùå Erreur cr√©ation: ' + error.message, 'error');
261|                
262|                createButton.disabled = false;
263|                createButton.innerHTML = 'üöÄ Cr√©er Session WebRTC';
264|            });
265|        }
266|
267|        function accessJudgeSheet() {
268|            const accessKey = document.getElementById('accessKeyInput').value.trim();
269|            const judgeName = document.getElementById('judgeNameInput').value.trim();
270|            const judgeNumber = document.getElementById('judgeNumberInput').value.trim();
271|            
272|            if (!accessKey || !judgeName || !judgeNumber) {
273|                showNotification('‚ö†Ô∏è Veuillez remplir tous les champs', 'error');
274|                return;
275|            }
276|            
277|            if (!/^\d{4}$/.test(accessKey)) {
278|                showNotification('‚ùå Code √† 4 chiffres requis', 'error');
279|                return;
280|            }
281|            
282|            if (judgeName.length < 2) {
283|                showNotification('‚ùå Nom trop court', 'error');
284|                return;
285|            }
286|            
287|            const connectButton = document.getElementById('connectButton');
288|            connectButton.disabled = true;
289|            connectButton.innerHTML = '<div class="loading-spinner"></div> Connexion...';
290|            
291|            app.session.code = accessKey;
292|            app.session.judgeName = judgeName;
293|            app.session.judgeNumber = judgeNumber;
294|            app.session.judgeId = Math.floor(Math.random() * 1000) + 1;
295|            app.session.role = 'judge';
296|            
297|            initializeWebRTC().then(() => {
298|                const delegatePeerId = `delegate_${accessKey}`;
299|                return connectToPeer(delegatePeerId);
300|            }).then(() => {
301|                console.log('‚úÖ Connexion juge √©tablie');
302|                document.getElementById('judgeAccessSection').classList.add('hidden');
303|                showJudgeInterface();
304|                
305|                showNotification('‚úÖ Connexion WebRTC √©tablie!', 'success');
306|                
307|                connectButton.disabled = false;
308|                connectButton.innerHTML = 'üö™ Se connecter WebRTC';
309|                
310|            }).catch(error => {
311|                console.error('‚ùå Erreur connexion:', error);
312|                showNotification('‚ùå Erreur: ' + error.message, 'error');
313|                
314|                connectButton.disabled = false;
315|                connectButton.innerHTML = 'üö™ Se connecter WebRTC';
316|            });
317|        }
318|
319|        // =====================
320|        // INTERFACE D√âL√âGU√â
321|        // =====================
322|
323|        function showDelegateInterface() {
324|            document.getElementById('delegateDashboard').classList.remove('hidden');
325|            document.getElementById('contentArea').style.display = 'none';
326|            document.getElementById('syncIndicator').classList.remove('hidden');
327|            
328|            // Afficher infos session
329|            document.getElementById('sessionCodeDisplay').textContent = app.session.code;
330|            document.getElementById('fightTypeDisplay').textContent = getFightTypeLabel(app.session.fightType);
331|            document.getElementById('judgeCountDisplay').textContent = app.session.judgeCount;
332|            document.getElementById('roundsDisplay').textContent = app.session.rounds;
333|            
334|            updateJudgeMonitoring();
335|            
336|            // Mise √† jour p√©riodique
337|            setInterval(() => {
338|                if (app.session.role === 'delegate' && app.session.initialized) {
339|                    const activeTab = document.querySelector('.tab-panel.active');
340|                    if (activeTab) {
341|                        const tabId = activeTab.id;
342|                        switch(tabId) {
343|                            case 'monitoringTab':
344|                                updateJudgeMonitoring();
345|                                break;
346|                            case 'recapTab':
347|                                updateRecapTable();
348|                                break;
349|                            case 'resultTab':
350|                                updateFinalResult();
351|                                break;
352|                        }
353|                    }
354|                }
355|            }, 3000);
356|        }
357|
358|        function updateFighterNames() {
359|            const redName = document.getElementById('fighterRedName').value.trim();
360|            const blueName = document.getElementById('fighterBlueName').value.trim();
361|            
362|            // Sauvegarder l'√©tat avant modification
363|            saveDelegateState('MODIFICATION NOMS TIREURS', {
364|                previousRed: app.data.fighters.red,
365|                previousBlue: app.data.fighters.blue,
366|                newRed: redName,
367|                newBlue: blueName
368|            });
369|            
370|            app.data.fighters.red = redName;
371|            app.data.fighters.blue = blueName;
372|            
373|            sendToAll({
374|                type: 'fighter_names',
375|                data: app.data.fighters
376|            }, 'normal');
377|            
378|            updateJudgeMonitoring();
379|            showNotification('üìù Noms mis √† jour', 'info', 2000);
380|        }
381|
382|        // =====================
383|        // SYST√àME D'ONGLETS D√âL√âGU√â
384|        // =====================
385|
386|        function showTab(tabName) {
387|            // Masquer tous les onglets
388|            document.querySelectorAll('.tab-panel').forEach(panel => {
389|                panel.classList.remove('active');
390|            });
391|            
392|            // D√©sactiver tous les boutons
393|            document.querySelectorAll('.tab-button').forEach(button => {
394|                button.classList.remove('active');
395|            });
396|            
397|            // Activer l'onglet s√©lectionn√©
398|            const targetTab = document.getElementById(tabName + 'Tab');
399|            if (targetTab) {
400|                targetTab.classList.add('active');
401|            }
402|            
403|            // Activer le bon bouton
404|            const buttons = document.querySelectorAll('.tab-button');
405|            const buttonIndex = ['monitoring', 'recap', 'result', 'export'].indexOf(tabName);
406|            if (buttonIndex !== -1 && buttons[buttonIndex]) {
407|                buttons[buttonIndex].classList.add('active');
408|            }
409|            
410|            // Mettre √† jour le contenu
411|            setTimeout(() => {
412|                switch(tabName) {
413|                    case 'monitoring':
414|                        updateJudgeMonitoring();
415|                        break;
416|                    case 'recap':
417|                        updateRecapTable();
418|                        break;
419|                    case 'result':
420|                        updateFinalResult();
421|                        break;
422|                    case 'export':
423|                        break;
424|                }
425|            }, 100);
426|        }
427|
428|        function updateJudgeMonitoring() {
429|            const container = document.getElementById('judgeMonitoring');
430|            if (!container) return;
431|            
432|            container.innerHTML = '<h3>üìä Monitoring des Juges - Interface CPTE Temps R√©el</h3>';
433|            
434|            const judgeCount = Object.keys(app.data.judges).length;
435|            if (judgeCount === 0) {
436|                container.innerHTML += `
437|                    <div class="message info">
438|                        <h4>üéØ En attente de connexion des juges...</h4>
439|                        <p><strong>Code de session:</strong> ${app.session.code}</p>
440|                        <p><strong>Type:</strong> ${getFightTypeLabel(app.session.fightType)}</p>
441|                        <p>Les juges doivent utiliser ce code pour se connecter.</p>
442|                    </div>
443|                `;
444|                return;
445|            }
446|            
447|            // Cr√©er une fiche pour chaque juge
448|            Object.keys(app.data.judges).forEach(judgeKey => {
449|                const judge = app.data.judges[judgeKey];
450|                const judgeContainer = createJudgeMonitoringCard(judge);
451|                container.appendChild(judgeContainer);
452|            });
453|        }
454|
455|        function createJudgeMonitoringCard(judge) {
456|            const container = document.createElement('div');
457|            container.className = `judge-sheet-container ${judge.connected ? 'connected' : ''}`;
458|            container.id = `judge-monitor-${judge.id}`;
459|            
460|            // Header avec statut
461|            const header = document.createElement('div');
462|            header.className = 'judge-sheet-header';
463|            header.innerHTML = `
464|                <div>
465|                    <h3>üë®‚Äç‚öñÔ∏è Juge ${judge.id} - ${judge.name || 'Nom non d√©fini'}</h3>
466|                    <p><strong>Num√©ro:</strong> ${judge.number || 'Non d√©fini'}</p>
467|                </div>
468|                <div class="judge-sheet-status">
469|                    <div class="status-indicator ${judge.connected ? 'connected' : ''}"></div>
470|                    <span>${judge.connected ? 'Connect√©' : 'D√©connect√©'}</span>
471|                    <span style="font-size: 11px; color: #7f8c8d; margin-left: 10px;">
472|                        ${judge.lastUpdate ? formatTime(judge.lastUpdate) : 'Jamais'}
473|                    </span>
474|                </div>
475|            `;
476|            
477|            // Table CPTE compl√®te identique √† celle des juges
478|            const table = createCompleteMonitoringTable(judge);
479|            
480|            container.appendChild(header);
481|            container.appendChild(table);
482|            
483|            return container;
484|        }
485|
486|        function createCompleteMonitoringTable(judge) {
487|            const isCombatType = isCombat();
488|            const table = document.createElement('table');
489|            table.className = 'scoring-table';
490|            table.style.fontSize = '11px';
491|            table.style.tableLayout = 'fixed';
492|            
493|            // Cr√©er l'en-t√™te
494|            let headerHTML = '';
495|            if (isCombatType) {
496|                headerHTML = `
497|                    <thead>
498|                        <tr>
499|                            <th rowspan="2" style="width: 120px;">NOTATION</th>
500|                            <th colspan="4" style="background-color: #ef5350; color: white;">COIN ROUGE</th>
501|                            <th colspan="4" style="background-color: #42a5f5; color: white;">COIN BLEU</th>
502|                        </tr>
503|                        <tr>
504|                            <th class="corner-red">Reprise</th>
505|                            <th class="corner-red">NOTE</th>
506|                            <th class="corner-red">AVT</th>
507|                            <th class="corner-red">CPTE</th>
508|                            <th class="corner-blue">Reprise</th>
509|                            <th class="corner-blue">NOTE</th>
510|                            <th class="corner-blue">AVT</th>
511|                            <th class="corner-blue">CPTE</th>
512|                        </tr>
513|                    </thead>
514|                `;
515|            } else {
516|                headerHTML = `
517|                    <thead>
518|                        <tr>
519|                            <th rowspan="2" style="width: 120px;">NOTATION</th>
520|                            <th colspan="3" style="background-color: #ef5350; color: white;">COIN ROUGE</th>
521|                            <th colspan="3" style="background-color: #42a5f5; color: white;">COIN BLEU</th>
522|                        </tr>
523|                        <tr>
524|                            <th class="corner-red">Reprise</th>
525|                            <th class="corner-red">NOTE</th>
526|                            <th class="corner-red">AVT</th>
527|                            <th class="corner-blue">Reprise</th>
528|                            <th class="corner-blue">NOTE</th>
529|                            <th class="corner-blue">AVT</th>
530|                        </tr>
531|                    </thead>
532|                `;
533|            }
534|            
535|            // Cr√©er le corps du tableau
536|            const notationText = isCombatType ? 
537|                `√âgalit√©: 2/2<br>Gagn√©: 3/2<br>Domin√©: 3/1<br>Non d√©cision: X/X<br>Avertissement: -1<br>Compte: -1<br>Bonus: +1` :
538|                `√âgalit√©: 2/2<br>Gagn√©: 3/2<br>Domin√©: 3/1<br>Non d√©cision: X/X<br>Avertissement: -1<br>Bonus: +1`;
539|            
540|            let bodyHTML = '<tbody>';
541|            
542|            // Lignes de reprises
543|            for (let i = 1; i <= app.session.rounds; i++) {
544|                const rowspanAttr = i === 1 ? `rowspan="${app.session.rounds}"` : '';
545|                const notationCell = i === 1 ? `<td ${rowspanAttr} style="vertical-align: top; font-size: 9px; padding: 3px;"><small>${notationText}</small></td>` : '';
546|                
547|                // R√©cup√©rer les donn√©es du juge
548|                const roundScore = judge.scores && judge.scores[i] ? judge.scores[i] : null;
549|                const redScore = roundScore ? roundScore.red : '-';
550|                const blueScore = roundScore ? roundScore.blue : '-';
551|                
552|                // Avertissements
553|                const redWarnings = judge.warnings && judge.warnings.red && judge.warnings.red[i] ? 'A'.repeat(judge.warnings.red[i]) : '';
554|                const blueWarnings = judge.warnings && judge.warnings.blue && judge.warnings.blue[i] ? 'A'.repeat(judge.warnings.blue[i]) : '';
555|                
556|                if (isCombatType) {
557|                    // Comptes pour les combats
558|                    const redComptes = judge.comptes && judge.comptes.red && judge.comptes.red[i] ? 'C'.repeat(judge.comptes.red[i]) : '';
559|                    const blueComptes = judge.comptes && judge.comptes.blue && judge.comptes.blue[i] ? 'C'.repeat(judge.comptes.blue[i]) : '';
560|                    
561|                    bodyHTML += `
562|                        <tr>
563|                            ${notationCell}
564|                            <td class="corner-red">${i}</td>
565|                            <td class="corner-red" style="font-weight: bold;">${redScore}</td>
566|                            <td class="corner-red" style="font-size: 10px; color: #dc3545;">${redWarnings}</td>
567|                            <td class="corner-red" style="font-size: 10px; color: #6c757d;">${redComptes}</td>
568|                            <td class="corner-blue">${i}</td>
569|                            <td class="corner-blue" style="font-weight: bold;">${blueScore}</td>
570|                            <td class="corner-blue" style="font-size: 10px; color: #dc3545;">${blueWarnings}</td>
571|                            <td class="corner-blue" style="font-size: 10px; color: #6c757d;">${blueComptes}</td>
572|                        </tr>
573|                    `;
574|                } else {
575|                    bodyHTML += `
576|                        <tr>
577|                            ${notationCell}
578|                            <td class="corner-red">${i}</td>
579|                            <td class="corner-red" style="font-weight: bold;">${redScore}</td>
580|                            <td class="corner-red" style="font-size: 10px; color: #dc3545;">${redWarnings}</td>
581|                            <td class="corner-blue">${i}</td>
582|                            <td class="corner-blue" style="font-weight: bold;">${blueScore}</td>
583|                            <td class="corner-blue" style="font-size: 10px; color: #dc3545;">${blueWarnings}</td>
584|                        </tr>
585|                    `;
586|                }
587|            }
588|            
589|            // Calculer les totaux
590|            let redSubtotal1 = 0, blueSubtotal1 = 0;
591|            let redWarningTotal = 0, blueWarningTotal = 0;
592|            let redCompteTotal = 0, blueCompteTotal = 0;
593|            
594|            // Somme des scores
595|            for (let i = 1; i <= app.session.rounds; i++) {
596|                const roundScore = judge.scores && judge.scores[i] ? judge.scores[i] : null;
597|                if (roundScore) {
598|                    redSubtotal1 += roundScore.red || 0;
599|                    blueSubtotal1 += roundScore.blue || 0;
600|                }
601|            }
602|            
603|            // Somme des avertissements
604|            if (judge.warnings) {
605|                if (judge.warnings.red) {
606|                    for (let round in judge.warnings.red) {
607|                        redWarningTotal += judge.warnings.red[round] || 0;
608|                    }
609|                }
610|                if (judge.warnings.blue) {
611|                    for (let round in judge.warnings.blue) {
612|                        blueWarningTotal += judge.warnings.blue[round] || 0;
613|                    }
614|                }
615|            }
616|            
617|            // Somme des comptes (combats seulement)
618|            if (isCombatType && judge.comptes) {
619|                if (judge.comptes.red) {
620|                    for (let round in judge.comptes.red) {
621|                        redCompteTotal += judge.comptes.red[round] || 0;
622|                    }
623|                }
624|                if (judge.comptes.blue) {
625|                    for (let round in judge.comptes.blue) {
626|                        blueCompteTotal += judge.comptes.blue[round] || 0;
627|                    }
628|                }
629|            }
630|            
631|            const redSubtotal2 = redSubtotal1 - redWarningTotal - redCompteTotal;
632|            const blueSubtotal2 = blueSubtotal1 - blueWarningTotal - blueCompteTotal;
633|            const redBonusValue = judge.bonuses ? (judge.bonuses.red || 0) : 0;
634|            const blueBonusValue = judge.bonuses ? (judge.bonuses.blue || 0) : 0;
635|            const redTotal = redSubtotal2 + redBonusValue;
636|            const blueTotal = blueSubtotal2 + blueBonusValue;
637|            
638|            // Lignes de totaux
639|            if (isCombatType) {
640|                bodyHTML += `
641|                    <tr style="background: #f8f9fa; font-size: 10px;">
642|                        <td style="text-align: left; padding-left: 5px;">Sous TOTAUX 1</td>
643|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redSubtotal1}</td>
644|                        <td class="corner-red"></td>
645|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueSubtotal1}</td>
646|                        <td class="corner-blue"></td>
647|                    </tr>
648|                    <tr style="background: #f8f9fa; font-size: 10px;">
649|                        <td style="text-align: left; padding-left: 5px;">Avertissements</td>
650|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redWarningTotal ? -redWarningTotal : 0}</td>
651|                        <td class="corner-red"></td>
652|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueWarningTotal ? -blueWarningTotal : 0}</td>
653|                        <td class="corner-blue"></td>
654|                    </tr>
655|                    <tr style="background: #f8f9fa; font-size: 10px;">
656|                        <td style="text-align: left; padding-left: 5px;">Compte</td>
657|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redCompteTotal ? -redCompteTotal : 0}</td>
658|                        <td class="corner-red"></td>
659|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueCompteTotal ? -blueCompteTotal : 0}</td>
660|                        <td class="corner-blue"></td>
661|                    </tr>
662|                    <tr style="background: #f8f9fa; font-size: 10px;">
663|                        <td style="text-align: left; padding-left: 5px;">Sous TOTAUX 2</td>
664|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redSubtotal2}</td>
665|                        <td class="corner-red"></td>
666|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueSubtotal2}</td>
667|                        <td class="corner-blue"></td>
668|                    </tr>
669|                    <tr style="background: #f8f9fa; font-size: 10px;">
670|                        <td style="text-align: left; padding-left: 5px;">Bonus</td>
671|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold;">${redBonusValue}</td>
672|                        <td class="corner-red"></td>
673|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold;">${blueBonusValue}</td>
674|                        <td class="corner-blue"></td>
675|                    </tr>
676|                    <tr style="background: #e9ecef; font-size: 12px;">
677|                        <td style="text-align: left; padding-left: 5px; font-weight: bold;">TOTAUX</td>
678|                        <td colspan="3" class="corner-red" style="text-align: center; font-weight: bold; font-size: 14px;">${redTotal}</td>
679|                        <td class="corner-red abandon-cell ${judge.abandons && judge.abandons.red ? 'abandoned' : ''}" style="font-size: 8px;">${judge.abandons && judge.abandons.red ? 'ABANDON' : 'EN LICE'}</td>
680|                        <td colspan="3" class="corner-blue" style="text-align: center; font-weight: bold; font-size: 14px;">${blueTotal}</td>
681|                        <td class="corner-blue abandon-cell ${judge.abandons && judge.abandons.blue ? 'abandoned' : ''}" style="font-size: 8px;">${judge.abandons && judge.abandons.blue ? 'ABANDON' : 'EN LICE'}</td>
682|                    </tr>
683|                    <tr style="background: #e1bee7; font-size: 11px;">
684|                        <td style="text-align: left; padding-left: 5px; font-weight: bold;">D√âCISION</td>
685|                        <td colspan="8" style="font-weight: bold; text-align: center;">${judge.result || 'En cours...'}</td>
686|                    </tr>
687|                `;
688|            } else {
689|                bodyHTML += `
690|                    <tr style="background: #f8f9fa; font-size: 10px;">
691|                        <td style="text-align: left; padding-left: 5px;">Sous TOTAUX 1</td>
692|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold;">${redSubtotal1}</td>
693|                        <td class="corner-red"></td>
694|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold;">${blueSubtotal1}</td>
695|                        <td class="corner-blue"></td>
696|                    </tr>
697|                    <tr style="background: #f8f9fa; font-size: 10px;">
698|                        <td style="text-align: left; padding-left: 5px;">Avertissements</td>
699|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold;">${redWarningTotal ? -redWarningTotal : 0}</td>
700|                        <td class="corner-red"></td>
701|

Action: file_editor view /app/SAVATE-PART-06
Observation: /app/SAVATE-PART-06:
1|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold;">${blueWarningTotal ? -blueWarningTotal : 0}</td>
2|                        <td class="corner-blue"></td>
3|                    </tr>
4|                    <tr style="background: #f8f9fa; font-size: 10px;">
5|                        <td style="text-align: left; padding-left: 5px;">Sous TOTAUX 2</td>
6|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold;">${redSubtotal2}</td>
7|                        <td class="corner-red"></td>
8|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold;">${blueSubtotal2}</td>
9|                        <td class="corner-blue"></td>
10|                    </tr>
11|                    <tr style="background: #f8f9fa; font-size: 10px;">
12|                        <td style="text-align: left; padding-left: 5px;">Bonus</td>
13|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold;">${redBonusValue}</td>
14|                        <td class="corner-red"></td>
15|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold;">${blueBonusValue}</td>
16|                        <td class="corner-blue"></td>
17|                    </tr>
18|                    <tr style="background: #e9ecef; font-size: 12px;">
19|                        <td style="text-align: left; padding-left: 5px; font-weight: bold;">TOTAUX</td>
20|                        <td colspan="2" class="corner-red" style="text-align: center; font-weight: bold; font-size: 14px;">${redTotal}</td>
21|                        <td class="corner-red abandon-cell ${judge.abandons && judge.abandons.red ? 'abandoned' : ''}" style="font-size: 8px;">${judge.abandons && judge.abandons.red ? 'ABANDON' : 'EN LICE'}</td>
22|                        <td colspan="2" class="corner-blue" style="text-align: center; font-weight: bold; font-size: 14px;">${blueTotal}</td>
23|                        <td class="corner-blue abandon-cell ${judge.abandons && judge.abandons.blue ? 'abandoned' : ''}" style="font-size: 8px;">${judge.abandons && judge.abandons.blue ? 'ABANDON' : 'EN LICE'}</td>
24|                    </tr>
25|                    <tr style="background: #e1bee7; font-size: 11px;">
26|                        <td style="text-align: left; padding-left: 5px; font-weight: bold;">D√âCISION</td>
27|                        <td colspan="6" style="font-weight: bold; text-align: center;">${judge.result || 'En cours...'}</td>
28|                    </tr>
29|                `;
30|            }
31|            
32|            bodyHTML += '</tbody>';
33|            table.innerHTML = headerHTML + bodyHTML;
34|            
35|            return table;
36|        }
37|
38|        function updateRecapTable() {
39|            const container = document.getElementById('recapTableContainer');
40|            if (!container) return;
41|
42|            const judgeCount = Object.keys(app.data.judges).length;
43|            if (judgeCount === 0) {
44|                container.innerHTML = `
45|                    <div class="message info" style="margin: 20px 0;">
46|                        <p>En attente des donn√©es des juges connect√©s...</p>
47|                    </div>
48|                `;
49|                return;
50|            }
51|
52|            // Cr√©er le tableau r√©capitulatif
53|            let tableHTML = `
54|                <table class="recap-table">
55|                    <thead>
56|                        <tr>
57|                            <th rowspan="2">Reprise</th>
58|            `;
59|
60|            // En-t√™tes des juges
61|            Object.keys(app.data.judges).forEach(judgeKey => {
62|                const judge = app.data.judges[judgeKey];
63|                tableHTML += `<th colspan="2" class="judge-header">Juge ${judge.id} - ${judge.name || 'Non d√©fini'}</th>`;
64|            });
65|
66|            tableHTML += `</tr><tr>`;
67|            
68|            // Sous-en-t√™tes Rouge/Bleu
69|            Object.keys(app.data.judges).forEach(() => {
70|                tableHTML += `<th class="score-red">Rouge</th><th class="score-blue">Bleu</th>`;
71|            });
72|
73|            tableHTML += `</tr></thead><tbody>`;
74|
75|            // Lignes par reprise
76|            for (let round = 1; round <= app.session.rounds; round++) {
77|                tableHTML += `<tr><td class="round-cell">Reprise ${round}</td>`;
78|                
79|                Object.keys(app.data.judges).forEach(judgeKey => {
80|                    const judge = app.data.judges[judgeKey];
81|                    const roundScore = judge.scores && judge.scores[round] ? judge.scores[round] : { red: '-', blue: '-' };
82|                    tableHTML += `<td class="score-red">${roundScore.red || '-'}</td><td class="score-blue">${roundScore.blue || '-'}</td>`;
83|                });
84|                
85|                tableHTML += `</tr>`;
86|            }
87|
88|            // Ligne des totaux
89|            tableHTML += `<tr class="total-row"><td>TOTAUX</td>`;
90|            Object.keys(app.data.judges).forEach(judgeKey => {
91|                const judge = app.data.judges[judgeKey];
92|                tableHTML += `<td class="score-red">${judge.totalRed || 0}</td><td class="score-blue">${judge.totalBlue || 0}</td>`;
93|            });
94|            tableHTML += `</tr>`;
95|
96|            // Ligne des r√©sultats
97|            tableHTML += `<tr class="final-result"><td>R√âSULTAT</td>`;
98|            Object.keys(app.data.judges).forEach(judgeKey => {
99|                const judge = app.data.judges[judgeKey];
100|                const result = judge.result || 'En cours...';
101|                tableHTML += `<td colspan="2">${result}</td>`;
102|            });
103|            tableHTML += `</tr>`;
104|
105|            tableHTML += `</tbody></table>`;
106|            
107|            container.innerHTML = tableHTML;
108|        }
109|
110|        function updateFinalResult() {
111|            const container = document.getElementById('finalResultContainer');
112|            if (!container) return;
113|
114|            const judgeCount = Object.keys(app.data.judges).length;
115|            const completedJudges = Object.keys(app.data.judges).filter(k => {
116|                const judge = app.data.judges[k];
117|                return judge.result && judge.result !== 'En cours...' && judge.result !== 'En attente...';
118|            });
119|
120|            if (completedJudges.length === 0) {
121|                container.innerHTML = `
122|                    <div class="message info" style="margin: 20px 0;">
123|                        <p>En attente des d√©cisions de tous les juges...</p>
124|                    </div>
125|                `;
126|                return;
127|            }
128|
129|            if (completedJudges.length < judgeCount) {
130|                container.innerHTML = `
131|                    <div class="message warning" style="margin: 20px 0;">
132|                        <p>D√©cisions re√ßues: ${completedJudges.length}/${judgeCount}</p>
133|                        <p>En attente des autres juges...</p>
134|                    </div>
135|                `;
136|                return;
137|            }
138|
139|            // Calculer le r√©sultat final par majorit√©
140|            let redVotes = 0;
141|            let blueVotes = 0;
142|            const judgeVotes = {};
143|
144|            completedJudges.forEach(judgeKey => {
145|                const judge = app.data.judges[judgeKey];
146|                const result = judge.result.toLowerCase();
147|                
148|                if (result.includes('rouge')) {
149|                    redVotes++;
150|                    judgeVotes[judgeKey] = 'rouge';
151|                } else if (result.includes('bleu')) {
152|                    blueVotes++;
153|                    judgeVotes[judgeKey] = 'bleu';
154|                } else {
155|                    judgeVotes[judgeKey] = 'autre';
156|                }
157|            });
158|
159|            let finalResult = '';
160|            let winnerColor = '';
161|
162|            if (redVotes > blueVotes) {
163|                finalResult = `VICTOIRE COIN ROUGE - ${app.data.fighters.red || 'Tireur Rouge'}`;
164|                winnerColor = 'red';
165|            } else if (blueVotes > redVotes) {
166|                finalResult = `VICTOIRE COIN BLEU - ${app.data.fighters.blue || 'Tireur Bleu'}`;
167|                winnerColor = 'blue';
168|            } else {
169|                finalResult = '√âGALIT√â - D√©cision partag√©e';
170|                winnerColor = 'tie';
171|            }
172|
173|            const majorityDetails = Object.keys(judgeVotes).map(judgeKey => {
174|                const judge = app.data.judges[judgeKey];
175|                const vote = judgeVotes[judgeKey];
176|                return `
177|                    <div class="judge-vote">
178|                        <span>Juge ${judge.id} (${judge.name})</span>
179|                        <span class="${vote === 'rouge' ? 'winner' : ''}">${judge.result}</span>
180|                    </div>
181|                `;
182|            }).join('');
183|
184|            container.innerHTML = `
185|                <div class="final-result-container">
186|                    <div class="final-result-title">üèÜ R√âSULTAT FINAL OFFICIEL</div>
187|                    <div class="final-result-details">${finalResult}</div>
188|                    <div style="font-size: 16px; margin: 10px 0;">
189|                        Majorit√©: ${Math.max(redVotes, blueVotes)}/${completedJudges.length} juges
190|                    </div>
191|                    
192|                    <div class="majority-details">
193|                        <h4 style="margin-bottom: 15px;">D√©tail des votes des juges:</h4>
194|                        ${majorityDetails}
195|                    </div>
196|                    
197|                    <div style="margin-top: 20px; font-size: 14px; color: #666;">
198|                        Calcul automatique bas√© sur la majorit√© des d√©cisions
199|                    </div>
200|                </div>
201|            `;
202|
203|            // Sauvegarder le r√©sultat final
204|            app.data.results = {
205|                finalResult: finalResult,
206|                redVotes: redVotes,
207|                blueVotes: blueVotes,
208|                judgeVotes: judgeVotes,
209|                timestamp: Date.now()
210|            };
211|        }
212|
213|        // =====================
214|        // FONCTIONS D'EXPORT D√âL√âGU√â
215|        // =====================
216|
217|        function exportCompleteMatchSheet() {
218|            // Export Excel complet
219|            const data = [
220|                ['FEUILLE DE MATCH COMPL√àTE - SAVATE BOXE FRAN√áAISE'],
221|                [''],
222|                ['Session:', app.session.code],
223|                ['Type:', getFightTypeLabel(app.session.fightType)],
224|                ['Date:', new Date().toLocaleDateString('fr-FR')],
225|                [''],
226|                ['Tireur Rouge:', app.data.fighters.red || 'Non d√©fini'],
227|                ['Tireur Bleu:', app.data.fighters.blue || 'Non d√©fini'],
228|                ['']
229|            ];
230|
231|            // Ajouter les donn√©es de chaque juge
232|            Object.keys(app.data.judges).forEach(judgeKey => {
233|                const judge = app.data.judges[judgeKey];
234|                data.push([`JUGE ${judge.id} - ${judge.name}`]);
235|                data.push(['R√©sultat:', judge.result || 'En cours']);
236|                data.push(['Total Rouge:', judge.totalRed || 0]);
237|                data.push(['Total Bleu:', judge.totalBlue || 0]);
238|                data.push(['']);
239|            });
240|
241|            if (app.data.results) {
242|                data.push(['R√âSULTAT FINAL:', app.data.results.finalResult]);
243|                data.push(['Votes Rouge:', app.data.results.redVotes]);
244|                data.push(['Votes Bleu:', app.data.results.blueVotes]);
245|            }
246|
247|            downloadCSV(data, `feuille_match_complete_${app.session.code}_${formatDate(Date.now())}.csv`);
248|            showNotification('üìä Export Excel complet r√©alis√©!', 'success');
249|        }
250|
251|        function exportOfficialReport() {
252|            // Export Markdown officiel
253|            let markdown = '# RAPPORT OFFICIEL - SAVATE BOXE FRAN√áAISE\n\n';
254|            markdown += `## Informations de la rencontre\n`;
255|            markdown += `- **Code de session:** ${app.session.code}\n`;
256|            markdown += `- **Type:** ${getFightTypeLabel(app.session.fightType)}\n`;
257|            markdown += `- **Date:** ${new Date().toLocaleDateString('fr-FR')}\n`;
258|            markdown += `- **Heure:** ${new Date().toLocaleTimeString('fr-FR')}\n\n`;
259|            
260|            markdown += `## Tireurs\n`;
261|            markdown += `- **Coin Rouge:** ${app.data.fighters.red || 'Non d√©fini'}\n`;
262|            markdown += `- **Coin Bleu:** ${app.data.fighters.blue || 'Non d√©fini'}\n\n`;
263|            
264|            markdown += `## Juges connect√©s\n`;
265|            Object.keys(app.data.judges).forEach(judgeKey => {
266|                const judge = app.data.judges[judgeKey];
267|                markdown += `### Juge ${judge.id} - ${judge.name}\n`;
268|                markdown += `- **Num√©ro:** ${judge.number}\n`;
269|                markdown += `- **R√©sultat:** ${judge.result || 'En cours'}\n`;
270|                markdown += `- **Score Rouge:** ${judge.totalRed || 0}\n`;
271|                markdown += `- **Score Bleu:** ${judge.totalBlue || 0}\n\n`;
272|            });
273|
274|            if (app.data.results) {
275|                markdown += `## üèÜ R√âSULTAT FINAL OFFICIEL\n`;
276|                markdown += `**${app.data.results.finalResult}**\n\n`;
277|                markdown += `- Votes pour le coin rouge: ${app.data.results.redVotes}\n`;
278|                markdown += `- Votes pour le coin bleu: ${app.data.results.blueVotes}\n\n`;
279|            }
280|
281|            markdown += `---\n_Rapport g√©n√©r√© le ${new Date().toLocaleString('fr-FR')}_`;
282|            
283|            downloadText(markdown, `rapport_officiel_${app.session.code}_${formatDate(Date.now())}.md`);
284|            showNotification('üìã Rapport officiel export√©!', 'success');
285|        }
286|
287|        function exportRawData() {
288|            // Export JSON complet
289|            const exportData = {
290|                session: app.session,
291|                fighters: app.data.fighters,
292|                judges: app.data.judges,
293|                results: app.data.results,
294|                changeLog: app.data.changeLog,
295|                exportTimestamp: Date.now(),
296|                version: app.version
297|            };
298|
299|            downloadJSON(exportData, `donnees_brutes_${app.session.code}_${formatDate(Date.now())}.json`);
300|            showNotification('üìù Donn√©es brutes export√©es!', 'success');
301|        }
302|
303|        function printFinalResult() {
304|            // Version imprimable
305|            if (!app.data.results) {
306|                showNotification('‚ö†Ô∏è Aucun r√©sultat final √† imprimer', 'warning');
307|                return;
308|            }
309|
310|            const printWindow = window.open('', '_blank');
311|            printWindow.document.write(`
312|                <!DOCTYPE html>
313|                <html>
314|                <head>
315|                    <title>R√©sultat Final - ${app.session.code}</title>
316|                    <style>
317|                        body { font-family: Arial, sans-serif; padding: 20px; }
318|                        h1 { text-align: center; color: #2c3e50; }
319|                        .result { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
320|                        .details { margin: 20px 0; }
321|                        .judge-vote { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd; }
322|                        .winner { font-weight: bold; color: #27ae60; }
323|                    </style>
324|                </head>
325|                <body>
326|                    <h1>üèÜ R√âSULTAT FINAL OFFICIEL</h1>
327|                    <div class="result">
328|                        <h2>${app.data.results.finalResult}</h2>
329|                        <p><strong>Majorit√©:</strong> ${Math.max(app.data.results.redVotes, app.data.results.blueVotes)}/${Object.keys(app.data.judges).length} juges</p>
330|                    </div>
331|                    
332|                    <div class="details">
333|                        <h3>D√©tail des votes:</h3>
334|                        ${Object.keys(app.data.results.judgeVotes).map(judgeKey => {
335|                            const judge = app.data.judges[judgeKey];
336|                            return `<div class="judge-vote"><span>Juge ${judge.id} (${judge.name})</span><span class="winner">${judge.result}</span></div>`;
337|                        }).join('')}
338|                    </div>
339|                    
340|                    <div style="margin-top: 40px; text-align: center; color: #666;">
341|                        Session: ${app.session.code} - ${new Date().toLocaleString('fr-FR')}
342|                    </div>
343|                </body>
344|                </html>
345|            `);
346|            printWindow.document.close();
347|            printWindow.print();
348|            
349|            showNotification('üñ®Ô∏è Fen√™tre d\'impression ouverte!', 'success');
350|        }
351|
352|        function exportAllFormats() {
353|            exportCompleteMatchSheet();
354|            setTimeout(() => exportOfficialReport(), 500);
355|            setTimeout(() => exportRawData(), 1000);
356|            showNotification('üöÄ Export de tous les formats lanc√©!', 'success');
357|        }
358|
359|        // =====================
360|        // INTERFACE JUGE CPTE COMPL√àTE
361|        // =====================
362|
363|        function showJudgeInterface() {
364|            document.getElementById('judgeInterface').classList.remove('hidden');
365|            document.getElementById('contentArea').style.display = 'none';
366|            document.getElementById('syncIndicator').classList.remove('hidden');
367|            
368|            // Afficher les informations du juge
369|            document.getElementById('judgeSessionCode').textContent = app.session.code;
370|            document.getElementById('judgeInfo').textContent = `${app.session.judgeName} (#${app.session.judgeNumber})`;
371|            
372|            // Remplir les champs de juge
373|            document.getElementById('judgeNameField').value = app.session.judgeName;
374|            document.getElementById('judgeNumberField').value = app.session.judgeNumber;
375|            
376|            // Initialiser l'interface CPTE
377|            updateJudgeTypeSelection();
378|            updateJudgeRounds();
379|            createJudgeTableStructure();
380|            updateFighterNamesInInterface();
381|        }
382|
383|        function updateJudgeTypeSelection() {
384|            const typeSelection = document.getElementById('judgeTypeSelection');
385|            if (!typeSelection) return;
386|            
387|            typeSelection.innerHTML = `
388|                <label style="font-weight: bold; color: #2c3e50; font-size: 18px;">
389|                    üìã ${getFightTypeLabel(app.session.fightType)}
390|                </label>
391|            `;
392|        }
393|
394|        function updateJudgeRounds() {
395|            activeRounds = app.session.rounds;
396|        }
397|
398|        function createJudgeTableStructure() {
399|            const isCombatType = isCombat();
400|            const colgroup = safeGetElement('judgeColgroup');
401|            const tableHeader = safeGetElement('judgeTableHeader');
402|            const tableBody = safeGetElement('judgeTableBody');
403|            
404|            if (!colgroup || !tableHeader || !tableBody) return;
405|            
406|            // Vider le contenu existant
407|            colgroup.innerHTML = '';
408|            tableHeader.innerHTML = '';
409|            tableBody.innerHTML = '';
410|            
411|            // Cr√©er les colonnes
412|            if (isCombatType) {
413|                colgroup.innerHTML = `
414|                    <col style="width: 150px;">
415|                    <col style="width: 60px;">
416|                    <col style="width: 60px;">
417|                    <col style="width: 60px;">
418|                    <col style="width: 60px;">
419|                    <col style="width: 60px;">
420|                    <col style="width: 60px;">
421|                    <col style="width: 60px;">
422|                    <col style="width: 60px;">
423|                `;
424|            } else {
425|                colgroup.innerHTML = `
426|                    <col style="width: 150px;">
427|                    <col style="width: 80px;">
428|                    <col style="width: 70px;">
429|                    <col style="width: 70px;">
430|                    <col style="width: 80px;">
431|                    <col style="width: 70px;">
432|                    <col style="width: 70px;">
433|                `;
434|            }
435|            
436|            // Cr√©er l'en-t√™te
437|            if (isCombatType) {
438|                tableHeader.innerHTML = `
439|                    <tr>
440|                        <th rowspan="2" style="width: 150px;">NOTATION</th>
441|                        <th colspan="4" style="background-color: #ef5350; color: white;">COIN ROUGE</th>
442|                        <th colspan="4" style="background-color: #42a5f5; color: white;">COIN BLEU</th>
443|                    </tr>
444|                    <tr>
445|                        <th class="corner-red">Reprise</th>
446|                        <th class="corner-red">NOTE</th>
447|                        <th class="corner-red">AVT</th>
448|                        <th class="corner-red">CPTE</th>
449|                        <th class="corner-blue">Reprise</th>
450|                        <th class="corner-blue">NOTE</th>
451|                        <th class="corner-blue">AVT</th>
452|                        <th class="corner-blue">CPTE</th>
453|                    </tr>
454|                `;
455|            } else {
456|                tableHeader.innerHTML = `
457|                    <tr>
458|                        <th rowspan="2" style="width: 150px;">NOTATION</th>
459|                        <th colspan="3" style="background-color: #ef5350; color: white;">COIN ROUGE</th>
460|                        <th colspan="3" style="background-color: #42a5f5; color: white;">COIN BLEU</th>
461|                    </tr>
462|                    <tr>
463|                        <th class="corner-red">Reprise</th>
464|                        <th class="corner-red">NOTE</th>
465|                        <th class="corner-red">AVT</th>
466|                        <th class="corner-blue">Reprise</th>
467|                        <th class="corner-blue">NOTE</th>
468|                        <th class="corner-blue">AVT</th>
469|                    </tr>
470|                `;
471|            }
472|            
473|            // Cr√©er le corps du tableau
474|            const notationText = isCombatType ? 
475|                `√âgalit√©: 2/2<br>Gagn√©: 3/2<br>Domin√©: 3/1<br>Non d√©cision: X/X<br>Avertissement: -1<br>Compte: -1<br>Bonus: +1` :
476|                `√âgalit√©: 2/2<br>Gagn√©: 3/2<br>Domin√©: 3/1<br>Non d√©cision: X/X<br>Avertissement: -1<br>Bonus: +1`;
477|            
478|            let bodyHTML = '';
479|            
480|            // Initialiser les donn√©es de juge
481|            if (!warnings.red) warnings.red = {};
482|            if (!warnings.blue) warnings.blue = {};
483|            if (!comptes.red) comptes.red = {};
484|            if (!comptes.blue) comptes.blue = {};
485|            
486|            // Lignes de reprises
487|            for (let i = 1; i <= 5; i++) {
488|                const hiddenClass = i > activeRounds ? 'hidden-row' : '';
489|                const rowspanAttr = i === 1 ? `rowspan="${activeRounds}"` : '';
490|                const notationCell = i === 1 ? `<td ${rowspanAttr} style="vertical-align: top;" class="notation-cell"><small>${notationText}</small></td>` : '';
491|                
492|                if (isCombatType) {
493|                    bodyHTML += `
494|                        <tr id="judgeRound${i}" class="${hiddenClass}">
495|                            ${notationCell}
496|                            <td class="corner-red">${i}</td>
497|                            <td class="corner-red">
498|                                <select class="score-select" id="judgeRed${i}" onchange="validateAndUpdateJudgeScores(${i})">
499|                                    <option value="">-</option>
500|                                    <option value="3">3</option>
501|                                    <option value="2">2</option>
502|                                    <option value="1">1</option>
503|                                </select>
504|                            </td>
505|                            <td class="corner-red warning-cell" id="judgeRedAvtCell${i}" onclick="toggleJudgeWarning('red', ${i})"></td>
506|                            <td class="corner-red compte-cell" id="judgeRedCpteCell${i}" onclick="toggleJudgeCompte('red', ${i})"></td>
507|                            <td class="corner-blue">${i}</td>
508|                            <td class="corner-blue">
509|                                <select class="score-select" id="judgeBlue${i}" onchange="validateAndUpdateJudgeScores(${i})">
510|                                    <option value="">-</option>
511|                                    <option value="3">3</option>
512|                                    <option value="2">2</option>
513|                                    <option value="1">1</option>
514|                                </select>
515|                            </td>
516|                            <td class="corner-blue warning-cell" id="judgeBlueAvtCell${i}" onclick="toggleJudgeWarning('blue', ${i})"></td>
517|                            <td class="corner-blue compte-cell" id="judgeBlueCpteCell${i}" onclick="toggleJudgeCompte('blue', ${i})"></td>
518|                        </tr>
519|                    `;
520|                } else {
521|                    bodyHTML += `
522|                        <tr id="judgeRound${i}" class="${hiddenClass}">
523|                            ${notationCell}
524|                            <td class="corner-red">${i}</td>
525|                            <td class="corner-red">
526|                                <select class="score-select" id="judgeRed${i}" onchange="validateAndUpdateJudgeScores(${i})">
527|                                    <option value="">-</option>
528|                                    <option value="3">3</option>
529|                                    <option value="2">2</option>
530|                                    <option value="1">1</option>
531|                                </select>
532|                            </td>
533|                            <td class="corner-red warning-cell" id="judgeRedAvtCell${i}" onclick="toggleJudgeWarning('red', ${i})"></td>
534|                            <td class="corner-blue">${i}</td>
535|                            <td class="corner-blue">
536|                                <select class="score-select" id="judgeBlue${i}" onchange="validateAndUpdateJudgeScores(${i})">
537|                                    <option value="">-</option>
538|                                    <option value="3">3</option>
539|                                    <option value="2">2</option>
540|                                    <option value="1">1</option>
541|                                </select>
542|                            </td>
543|                            <td class="corner-blue warning-cell" id="judgeBlueAvtCell${i}" onclick="toggleJudgeWarning('blue', ${i})"></td>
544|                        </tr>
545|                    `;
546|                }
547|            }
548|            
549|            // Lignes de totaux
550|            if (isCombatType) {
551|                bodyHTML += `
552|                    <tr class="subtotal">
553|                        <td style="text-align: left; padding-left: 10px;">Sous TOTAUX 1</td>
554|                        <td colspan="3" class="corner-red" style="text-align: center;"><span id="judgeRedSubtotal1">0</span></td>
555|                        <td class="corner-red"></td>
556|                        <td colspan="3" class="corner-blue" style="text-align: center;"><span id="judgeBlueSubtotal1">0</span></td>
557|                        <td class="corner-blue"></td>
558|                    </tr>
559|                    <tr class="subtotal">
560|                        <td style="text-align: left; padding-left: 10px;">**Avertissements**</td>
561|                        <td colspan="3" class="corner-red" style="text-align: center;"><span id="judgeRedWarnings">0</span></td>
562|                        <td class="corner-red"></td>
563|                        <td colspan="3" class="corner-blue" style="text-align: center;"><span id="judgeBlueWarnings">0</span></td>
564|                        <td class="corner-blue"></td>
565|                    </tr>
566|                    <tr class="subtotal">
567|                        <td style="text-align: left; padding-left: 10px;">Compte</td>
568|                        <td colspan="3" class="corner-red" style="text-align: center;"><span id="judgeRedComptes">0</span></td>
569|                        <td class="corner-red"></td>
570|                        <td colspan="3" class="corner-blue" style="text-align: center;"><span id="judgeBlueComptes">0</span></td>
571|                        <td class="corner-blue"></td>
572|                    </tr>
573|                    <tr class="subtotal">
574|                        <td style="text-align: left; padding-left: 10px;">Sous TOTAUX 2</td>
575|                        <td colspan="3" class="corner-red" style="text-align: center;"><span id="judgeRedSubtotal2">0</span></td>
576|                        <td class="corner-red"></td>
577|                        <td colspan="3" class="corner-blue" style="text-align: center;"><span id="judgeBlueSubtotal2">0</span></td>
578|                        <td class="corner-blue"></td>
579|                    </tr>
580|                    <tr>
581|                        <td>Bonus</td>
582|                        <td colspan="3" class="corner-red" style="text-align: center;">
583|                            <input type="number" class="score-input" id="judgeRedBonus" min="0" max="1" value="0" onchange="validateJudgeBonus()">
584|                        </td>
585|                        <td class="corner-red"></td>
586|                        <td colspan="3" class="corner-blue" style="text-align: center;">
587|                            <input type="number" class="score-input" id="judgeBlueBonus" min="0" max="1" value="0" onchange="validateJudgeBonus()">
588|                        </td>
589|                        <td class="corner-blue"></td>
590|                    </tr>
591|                    <tr class="total">
592|                        <td>TOTAUX</td>
593|                        <td colspan="3" class="corner-red" style="text-align: center;"><span id="judgeRedTotal">0</span></td>
594|                        <td class="corner-red abandon-cell" id="judgeAbandonRed" onclick="toggleJudgeAbandon('red')">ABANDON</td>
595|                        <td colspan="3" class="corner-blue" style="text-align: center;"><span id="judgeBlueTotal">0</span></td>
596|                        <td class="corner-blue abandon-cell" id="judgeAbandonBlue" onclick="toggleJudgeAbandon('blue')">ABANDON</td>
597|                    </tr>
598|                    <tr class="decision-row">
599|                        <td>D√âCISION</td>
600|                        <td colspan="8" class="decision-cell"><span id="judgeDecision">-</span></td>
601|                    </tr>
602|                `;
603|            } else {
604|                bodyHTML += `
605|                    <tr class="subtotal">
606|                        <td style="text-align: left; padding-left: 10px;">Sous TOTAUX 1</td>
607|                        <td colspan="2" class="corner-red" style="text-align: center;"><span id="judgeRedSubtotal1">0</span></td>
608|                        <td class="corner-red"></td>
609|                        <td colspan="2" class="corner-blue" style="text-align: center;"><span id="judgeBlueSubtotal1">0</span></td>
610|                        <td class="corner-blue"></td>
611|                    </tr>
612|                    <tr class="subtotal">
613|                        <td style="text-align: left; padding-left: 10px;">**Avertissements**</td>
614|                        <td colspan="2" class="corner-red" style="text-align: center;"><span id="judgeRedWarnings">0</span></td>
615|                        <td class="corner-red"></td>
616|                        <td colspan="2" class="corner-blue" style="text-align: center;"><span id="judgeBlueWarnings">0</span></td>
617|                        <td class="corner-blue"></td>
618|                    </tr>
619|                    <tr class="subtotal">
620|                        <td style="text-align: left; padding-left: 10px;">Sous TOTAUX 2</td>
621|                        <td colspan="2" class="corner-red" style="text-align: center;"><span id="judgeRedSubtotal2">0</span></td>
622|                        <td class="corner-red"></td>
623|                        <td colspan="2" class="corner-blue" style="text-align: center;"><span id="judgeBlueSubtotal2">0</span></td>
624|                        <td class="corner-blue"></td>
625|                    </tr>
626|                    <tr>
627|                        <td>Bonus</td>
628|                        <td colspan="2" class="corner-red" style="text-align: center;">
629|                            <input type="number" class="score-input" id="judgeRedBonus" min="0" max="1" value="0" onchange="validateJudgeBonus()">
630|                        </td>
631|                        <td class="corner-red"></td>
632|                        <td colspan="2" class="corner-blue" style="text-align: center;">
633|                            <input type="number" class="score-input" id="judgeBlueBonus" min="0" max="1" value="0" onchange="validateJudgeBonus()">
634|                        </td>
635|                        <td class="corner-blue"></td>
636|                    </tr>
637|                    <tr class="total">
638|                        <td>TOTAUX</td>
639|                        <td colspan="2" class="corner-red" style="text-align: center;"><span id="judgeRedTotal">0</span></td>
640|                        <td class="corner-red abandon-cell" id="judgeAbandonRed" onclick="toggleJudgeAbandon('red')">ABANDON</td>
641|                        <td colspan="2" class="corner-blue" style="text-align: center;"><span id="judgeBlueTotal">0</span></td>
642|                        <td class="corner-blue abandon-cell" id="judgeAbandonBlue" onclick="toggleJudgeAbandon('blue')">ABANDON</td>
643|                    </tr>
644|                    <tr class="decision-row">
645|                        <td>D√âCISION</td>
646|                        <td colspan="6" class="decision-cell"><span id="judgeDecision">-</span></td>
647|                    </tr>
648|                `;
649|            }
650|            
651|            tableBody.innerHTML = bodyHTML;
652|        }
653|
654|        function updateFighterNamesInInterface() {
655|            // Interface juge
656|            const redFighter = document.getElementById('judgeRedFighter');
657|            const blueFighter = document.getElementById('judgeBlueFighter');
658|            
659|            if (redFighter) redFighter.value = app.data.fighters.red || '';
660|            if (blueFighter) blueFighter.value = app.data.fighters.blue || '';
661|            
662|            // Mise √† jour des indicateurs
663|            updateJudgeFieldIndicators();
664|        }
665|
666|        function updateJudgeFieldIndicators() {
667|            const redIndicator = document.getElementById('judgeRedFighterIndicator');
668|            const blueIndicator = document.getElementById('judgeBlueFighterIndicator');
669|            
670|            if (redIndicator) {
671|                const hasRed = app.data.fighters.red && app.data.fighters.red.trim() !== '';
672|                redIndicator.className = `completion-indicator ${hasRed ? 'complete' : 'incomplete'}`;
673|            }
674|            
675|            if (blueIndicator) {
676|                const hasBlue = app.data.fighters.blue && app.data.fighters.blue.trim() !== '';
677|                blueIndicator.className = `completion-indicator ${hasBlue ? 'complete' : 'incomplete'}`;
678|            }
679|        }
680|
681|        // =====================
682|        // FONCTIONS CPTE JUGE COMPL√àTES
683|        // =====================
684|
685|        function saveJudgeState() {
686|            const state = {
687|                warnings: JSON.parse(JSON.stringify(warnings)),
688|                comptes: JSON.parse(JSON.stringify(comptes)),
689|                abandons: JSON.parse(JSON.stringify(abandons)),
690|                scores: {},
691|                bonus: {
692|                    red: safeGetElement('judgeRedBonus')?.value || '0',
693|                    blue: safeGetElement('judgeBlueBonus')?.value || '0'
694|                }
695|            };
696|            
697|            // Sauvegarder les scores
698|            for (let i = 1; i <= 5; i++) {
699|                const redElement = safeGetElement(`judgeRed${i}`);
700|                const blueElement = safeGetElement(`judgeBlue${i}`);
701|

Action: file_editor view /app/SAVATE-PART-07
Observation: /app/SAVATE-PART-07:
1|                state.scores[`red${i}`] = redElement ? redElement.value : '';
2|                state.scores[`blue${i}`] = blueElement ? blueElement.value : '';
3|            }
4|            
5|            actionHistory.push(state);
6|            
7|            // Limiter l'historique √† 50 actions
8|            if (actionHistory.length > 50) {
9|                actionHistory.shift();
10|            }
11|            
12|            // Activer le bouton annuler
13|            const undoButton = safeGetElement('judgeUndoButton');
14|            if (undoButton) undoButton.disabled = false;
15|        }
16|
17|        function validateAndUpdateJudgeScores(round) {
18|            const redSelect = safeGetElement(`judgeRed${round}`);
19|            const blueSelect = safeGetElement(`judgeBlue${round}`);
20|            
21|            if (!redSelect || !blueSelect) return;
22|            
23|            const redValue = parseInt(redSelect.value) || 0;
24|            const blueValue = parseInt(blueSelect.value) || 0;
25|            
26|            // Si un des deux a la valeur 3, l'autre ne peut pas l'avoir
27|            if (redValue === 3 && blueValue === 3) {
28|                showNotification(`Reprise ${round}: Les deux tireurs ne peuvent pas avoir la note 3 simultan√©ment!`, 'error');
29|                
30|                // R√©initialiser la derni√®re valeur modifi√©e
31|                if (document.activeElement === redSelect) {
32|                    redSelect.value = '';
33|                } else {
34|                    blueSelect.value = '';
35|                }
36|                return;
37|            }
38|            
39|            // Si les deux valeurs sont d√©finies, v√©rifier les combinaisons valides
40|            if (redValue && blueValue) {
41|                const isValidCombination = 
42|                    (redValue === 3 && blueValue === 2) ||
43|                    (redValue === 2 && blueValue === 3) ||
44|                    (redValue === 3 && blueValue === 1) ||
45|                    (redValue === 1 && blueValue === 3) ||
46|                    (redValue === 2 && blueValue === 2);
47|                
48|                if (!isValidCombination) {
49|                    showNotification(`Reprise ${round}: Seuls les scores 3-2, 3-1 ou 2-2 sont autoris√©s!`, 'error');
50|                    
51|                    // R√©initialiser la derni√®re valeur modifi√©e
52|                    if (document.activeElement === redSelect) {
53|                        redSelect.value = '';
54|                    } else {
55|                        blueSelect.value = '';
56|                    }
57|                    return;
58|                }
59|            }
60|            
61|            saveJudgeState();
62|            calculateJudgeTotals();
63|            lockJudgeCompletedRounds();
64|            
65|            // Synchroniser avec le d√©l√©gu√©
66|            syncJudgeData('score_change', { round: round });
67|        }
68|
69|        function toggleJudgeWarning(color, round) {
70|            saveJudgeState();
71|            
72|            // Calculer le total actuel des avertissements pour ce tireur
73|            let currentTotal = 0;
74|            for (let r in warnings[color]) {
75|                currentTotal += warnings[color][r] || 0;
76|            }
77|            
78|            if (!warnings[color][round]) {
79|                warnings[color][round] = 0;
80|            }
81|            
82|            const currentCellWarnings = warnings[color][round];
83|            
84|            // Cycle: 0 -> 1 -> 2 -> 3 -> 0
85|            if (currentCellWarnings < 3) {
86|                // V√©rifier si on peut ajouter un avertissement
87|                if (currentTotal < 3) {
88|                    warnings[color][round]++;
89|                } else {
90|                    showNotification('Maximum 3 avertissements par tireur sur l\'ensemble de la rencontre!', 'error');
91|                    undoLastJudgeAction();
92|                    return;
93|                }
94|            } else {
95|                // R√©initialiser √† 0
96|                warnings[color][round] = 0;
97|            }
98|            
99|            updateJudgeWarningDisplay(color, round);
100|            checkJudgeDisqualification(color);
101|            calculateJudgeTotals();
102|            
103|            // Synchroniser
104|            syncJudgeData('warning_toggle', { color: color, round: round });
105|        }
106|
107|        function toggleJudgeCompte(color, round) {
108|            if (!isCombat()) return;
109|            
110|            saveJudgeState();
111|            
112|            // Calculer le total actuel des comptes pour ce tireur
113|            let currentTotal = 0;
114|            for (let r in comptes[color]) {
115|                currentTotal += comptes[color][r] || 0;
116|            }
117|            
118|            if (!comptes[color][round]) {
119|                comptes[color][round] = 0;
120|            }
121|            
122|            const currentCellComptes = comptes[color][round];
123|            
124|            // Cycle: 0 -> 1 -> 2 -> 3 -> 0
125|            if (currentCellComptes < 3) {
126|                // V√©rifier si on peut ajouter un compte
127|                if (currentTotal < 3) {
128|                    comptes[color][round]++;
129|                } else {
130|                    showNotification('Maximum 3 comptes par tireur sur l\'ensemble de la rencontre!', 'error');
131|                    undoLastJudgeAction();
132|                    return;
133|                }
134|            } else {
135|                // R√©initialiser √† 0
136|                comptes[color][round] = 0;
137|            }
138|            
139|            updateJudgeCompteDisplay(color, round);
140|            checkJudgeDisqualification(color);
141|            calculateJudgeTotals();
142|            
143|            // Synchroniser
144|            syncJudgeData('compte_toggle', { color: color, round: round });
145|        }
146|
147|        function toggleJudgeAbandon(color) {
148|            saveJudgeState();
149|            
150|            const button = safeGetElement(`judgeAbandon${color.charAt(0).toUpperCase() + color.slice(1)}`);
151|            if (!button) return;
152|            
153|            const opponentColor = color === 'red' ? 'blue' : 'red';
154|            
155|            if (!abandons[color]) {
156|                // Confirmer l'abandon
157|                const fighterName = app.data.fighters[color] || `Tireur ${color === 'red' ? 'rouge' : 'bleu'}`;
158|                
159|                if (confirm(`Confirmer l'abandon de ${fighterName} ?`)) {
160|                    abandons[color] = true;
161|                    button.textContent = 'ABANDONN√â';
162|                    button.classList.add('abandoned');
163|                    
164|                    // D√©sactiver tous les contr√¥les de scoring
165|                    document.querySelectorAll('.score-select').forEach(select => {
166|                        select.disabled = true;
167|                    });
168|                    document.querySelectorAll('.warning-cell').forEach(cell => cell.style.pointerEvents = 'none');
169|                    document.querySelectorAll('.compte-cell').forEach(cell => cell.style.pointerEvents = 'none');
170|                    document.querySelectorAll('.score-input').forEach(input => input.disabled = true);
171|                    
172|                    // Afficher le message d'abandon
173|                    const opponentName = app.data.fighters[opponentColor] || `Tireur ${opponentColor === 'red' ? 'rouge' : 'bleu'}`;
174|                    const abandonMessage = safeGetElement('judgeAbandonMessage');
175|                    const abandonText = safeGetElement('judgeAbandonText');
176|                    
177|                    if (abandonMessage) abandonMessage.style.display = 'block';
178|                    if (abandonText) abandonText.textContent = `${fighterName} a abandonn√©. ${opponentName} est d√©clar√©(e) vainqueur!`;
179|                    
180|                    // Mettre √† jour la d√©cision imm√©diatement
181|                    updateJudgeDecision();
182|                    
183|                    // Synchroniser
184|                    syncJudgeData('abandon_toggle', { color: color });
185|                } else {
186|                    // Si l'utilisateur annule, annuler l'√©tat sauvegard√©
187|                    undoLastJudgeAction();
188|                }
189|            } else {
190|                // Annuler l'abandon
191|                abandons[color] = false;
192|                button.textContent = 'ABANDON';
193|                button.classList.remove('abandoned');
194|                
195|                // R√©activer les contr√¥les
196|                unlockAllJudgeRounds();
197|                lockJudgeCompletedRounds();
198|                document.querySelectorAll('.warning-cell').forEach(cell => cell.style.pointerEvents = 'auto');
199|                document.querySelectorAll('.compte-cell').forEach(cell => cell.style.pointerEvents = 'auto');
200|                document.querySelectorAll('.score-input').forEach(input => input.disabled = false);
201|                
202|                // Cacher le message d'abandon
203|                const abandonMessage = safeGetElement('judgeAbandonMessage');
204|                if (abandonMessage) abandonMessage.style.display = 'none';
205|                
206|                // Recalculer les totaux
207|                calculateJudgeTotals();
208|                
209|                // Synchroniser
210|                syncJudgeData('abandon_toggle', { color: color });
211|            }
212|        }
213|
214|        function validateJudgeBonus() {
215|            saveJudgeState();
216|            
217|            const redBonus = safeGetElement('judgeRedBonus');
218|            const blueBonus = safeGetElement('judgeBlueBonus');
219|            
220|            if (!redBonus || !blueBonus) return;
221|            
222|            redBonus.classList.remove('error', 'bonus-required');
223|            blueBonus.classList.remove('error', 'bonus-required');
224|            
225|            const redValue = parseInt(redBonus.value) || 0;
226|            const blueValue = parseInt(blueBonus.value) || 0;
227|            
228|            if (redValue === 1 && blueValue === 1) {
229|                redBonus.classList.add('error');
230|                blueBonus.classList.add('error');
231|                showNotification('Le bonus ne peut √™tre attribu√© qu\'√† un seul coin!', 'error');
232|                
233|                // Annuler la derni√®re action
234|                undoLastJudgeAction();
235|                return;
236|            }
237|            
238|            calculateJudgeTotals();
239|            
240|            // Synchroniser
241|            syncJudgeData('bonus_change');
242|        }
243|
244|        function updateJudgeWarningDisplay(color, round) {
245|            const cell = safeGetElement(`judge${color.charAt(0).toUpperCase() + color.slice(1)}AvtCell${round}`);
246|            if (!cell) return;
247|            
248|            const count = warnings[color][round] || 0;
249|            
250|            if (count === 0) {
251|                cell.textContent = '';
252|                cell.classList.remove('full');
253|            } else {
254|                cell.textContent = 'A'.repeat(count);
255|                if (count >= 3) {
256|                    cell.classList.add('full');
257|                } else {
258|                    cell.classList.remove('full');
259|                }
260|            }
261|        }
262|
263|        function updateJudgeCompteDisplay(color, round) {
264|            const cell = safeGetElement(`judge${color.charAt(0).toUpperCase() + color.slice(1)}CpteCell${round}`);
265|            if (!cell) return;
266|            
267|            const count = comptes[color][round] || 0;
268|            
269|            if (count === 0) {
270|                cell.textContent = '';
271|                cell.classList.remove('full');
272|            } else {
273|                cell.textContent = 'C'.repeat(count);
274|                if (count >= 3) {
275|                    cell.classList.add('full');
276|                } else {
277|                    cell.classList.remove('full');
278|                }
279|            }
280|        }
281|
282|        function checkJudgeDisqualification(color) {
283|            let totalWarnings = 0;
284|            let totalComptes = 0;
285|            
286|            for (let round in warnings[color]) {
287|                totalWarnings += warnings[color][round] || 0;
288|            }
289|            
290|            if (isCombat()) {
291|                for (let round in comptes[color]) {
292|                    totalComptes += comptes[color][round] || 0;
293|                }
294|            }
295|            
296|            if (totalWarnings >= 3 || totalComptes >= 3) {
297|                const fighterName = app.data.fighters[color] || `Tireur ${color === 'red' ? 'rouge' : 'bleu'}`;
298|                const opponentColor = color === 'red' ? 'blue' : 'red';
299|                const opponentName = app.data.fighters[opponentColor] || `Tireur ${opponentColor === 'red' ? 'rouge' : 'bleu'}`;
300|                
301|                let reason, decisionText, messageTitle;
302|                
303|                if (totalComptes >= 3) {
304|                    reason = '3 comptes';
305|                    decisionText = `VICTOIRE ${opponentColor === 'red' ? 'COIN ROUGE' : 'COIN BLEU'} PAR HORS COMBAT - ${opponentName}`;
306|                    messageTitle = 'HORS COMBAT';
307|                } else {
308|                    reason = '3 avertissements';
309|                    decisionText = `VICTOIRE ${opponentColor === 'red' ? 'COIN ROUGE' : 'COIN BLEU'} PAR DISQUALIFICATION - ${opponentName}`;
310|                    messageTitle = 'DISQUALIFICATION';
311|                }
312|                
313|                const disqualificationMessage = safeGetElement('judgeDisqualificationMessage');
314|                const disqualificationText = safeGetElement('judgeDisqualificationText');
315|                
316|                if (disqualificationMessage) {
317|                    disqualificationMessage.style.display = 'block';
318|                    const titleElement = disqualificationMessage.querySelector('h2');
319|                    if (titleElement) titleElement.textContent = messageTitle;
320|                }
321|                
322|                if (disqualificationText) {
323|                    disqualificationText.textContent = `${fighterName} est ${totalComptes >= 3 ? 'd√©clar√©(e) HORS COMBAT' : 'disqualifi√©(e)'} pour ${reason}. ${opponentName} est d√©clar√©(e) vainqueur!`;
324|                }
325|                
326|                // D√©sactiver tous les selects
327|                document.querySelectorAll('.score-select').forEach(select => {
328|                    select.disabled = true;
329|                });
330|                
331|                // Mettre √† jour la d√©cision
332|                const decisionElement = safeGetElement('judgeDecision');
333|                if (decisionElement) {
334|                    decisionElement.textContent = decisionText;
335|                    decisionElement.style.color = opponentColor === 'red' ? '#dc3545' : '#007bff';
336|                }
337|                
338|                // Synchroniser
339|                syncJudgeData('disqualification', { color: color, reason: reason });
340|            } else {
341|                const disqualificationMessage = safeGetElement('judgeDisqualificationMessage');
342|                if (disqualificationMessage) disqualificationMessage.style.display = 'none';
343|                
344|                // R√©activer les selects si pas de disqualification
345|                if (!abandons.red && !abandons.blue) {
346|                    unlockAllJudgeRounds();
347|                    lockJudgeCompletedRounds();
348|                }
349|            }
350|        }
351|
352|        function calculateJudgeTotals() {
353|            let redScore = 0;
354|            let blueScore = 0;
355|            let redWarningTotal = 0;
356|            let blueWarningTotal = 0;
357|            let redCompteTotal = 0;
358|            let blueCompteTotal = 0;
359|            
360|            // Calculer les scores des reprises actives uniquement
361|            for (let i = 1; i <= activeRounds; i++) {
362|                const redValue = parseInt(safeGetElement(`judgeRed${i}`)?.value) || 0;
363|                const blueValue = parseInt(safeGetElement(`judgeBlue${i}`)?.value) || 0;
364|                
365|                redScore += redValue;
366|                blueScore += blueValue;
367|            }
368|            
369|            // Calculer les avertissements
370|            for (let round in warnings.red) {
371|                if (round <= activeRounds) {
372|                    redWarningTotal += warnings.red[round] || 0;
373|                }
374|            }
375|            for (let round in warnings.blue) {
376|                if (round <= activeRounds) {
377|                    blueWarningTotal += warnings.blue[round] || 0;
378|                }
379|            }
380|            
381|            // Calculer les comptes (pour les combats seulement)
382|            if (isCombat()) {
383|                for (let round in comptes.red) {
384|                    if (round <= activeRounds) {
385|                        redCompteTotal += comptes.red[round] || 0;
386|                    }
387|                }
388|                for (let round in comptes.blue) {
389|                    if (round <= activeRounds) {
390|                        blueCompteTotal += comptes.blue[round] || 0;
391|                    }
392|                }
393|            }
394|            
395|            // Afficher sous-total 1
396|            const redSubtotal1 = safeGetElement('judgeRedSubtotal1');
397|            const blueSubtotal1 = safeGetElement('judgeBlueSubtotal1');
398|            if (redSubtotal1) redSubtotal1.textContent = redScore;
399|            if (blueSubtotal1) blueSubtotal1.textContent = blueScore;
400|            
401|            // Afficher avertissements (valeur n√©gative)
402|            const redWarnings = safeGetElement('judgeRedWarnings');
403|            const blueWarnings = safeGetElement('judgeBlueWarnings');
404|            if (redWarnings) redWarnings.textContent = redWarningTotal > 0 ? -redWarningTotal : 0;
405|            if (blueWarnings) blueWarnings.textContent = blueWarningTotal > 0 ? -blueWarningTotal : 0;
406|            
407|            // Afficher comptes (valeur n√©gative, pour les combats seulement)
408|            if (isCombat()) {
409|                const redComptes = safeGetElement('judgeRedComptes');
410|                const blueComptes = safeGetElement('judgeBlueComptes');
411|                if (redComptes) redComptes.textContent = redCompteTotal > 0 ? -redCompteTotal : 0;
412|                if (blueComptes) blueComptes.textContent = blueCompteTotal > 0 ? -blueCompteTotal : 0;
413|            }
414|            
415|            // Calculer sous-total 2
416|            const redSubtotal2 = redScore - redWarningTotal - redCompteTotal;
417|            const blueSubtotal2 = blueScore - blueWarningTotal - blueCompteTotal;
418|            const redSubtotal2Element = safeGetElement('judgeRedSubtotal2');
419|            const blueSubtotal2Element = safeGetElement('judgeBlueSubtotal2');
420|            if (redSubtotal2Element) redSubtotal2Element.textContent = redSubtotal2;
421|            if (blueSubtotal2Element) blueSubtotal2Element.textContent = blueSubtotal2;
422|            
423|            // V√©rifier l'√©galit√© et forcer l'attribution d'un bonus
424|            const redBonus = safeGetElement('judgeRedBonus');
425|            const blueBonus = safeGetElement('judgeBlueBonus');
426|            const redBonusValue = parseInt(redBonus?.value) || 0;
427|            const blueBonusValue = parseInt(blueBonus?.value) || 0;
428|            
429|            // V√©rifier si toutes les reprises sont compl√©t√©es
430|            const allRoundsCompleted = areAllJudgeRoundsCompleted();
431|            
432|            const equalityWarning = safeGetElement('judgeEqualityWarning');
433|            if (allRoundsCompleted && redSubtotal2 === blueSubtotal2 && redBonusValue === 0 && blueBonusValue === 0 && !abandons.red && !abandons.blue) {
434|                // √âgalit√© d√©tect√©e - afficher l'avertissement et mettre en √©vidence les bonus
435|                if (equalityWarning) equalityWarning.style.display = 'block';
436|                if (redBonus) redBonus.classList.add('bonus-required');
437|                if (blueBonus) blueBonus.classList.add('bonus-required');
438|            } else {
439|                // Masquer l'avertissement d'√©galit√©
440|                if (equalityWarning) equalityWarning.style.display = 'none';
441|                if (redBonus) redBonus.classList.remove('bonus-required');
442|                if (blueBonus) blueBonus.classList.remove('bonus-required');
443|            }
444|            
445|            // Calculer totaux finaux
446|            const redTotal = redSubtotal2 + redBonusValue;
447|            const blueTotal = blueSubtotal2 + blueBonusValue;
448|            
449|            const redTotalElement = safeGetElement('judgeRedTotal');
450|            const blueTotalElement = safeGetElement('judgeBlueTotal');
451|            if (redTotalElement) redTotalElement.textContent = redTotal;
452|            if (blueTotalElement) blueTotalElement.textContent = blueTotal;
453|            
454|            // D√©terminer la d√©cision
455|            const disqualificationMessage = safeGetElement('judgeDisqualificationMessage');
456|            const abandonMessage = safeGetElement('judgeAbandonMessage');
457|            
458|            if ((!disqualificationMessage || disqualificationMessage.style.display === 'none') && 
459|                (!abandonMessage || abandonMessage.style.display === 'none')) {
460|                updateJudgeDecision(redTotal, blueTotal, allRoundsCompleted);
461|            }
462|        }
463|
464|        function updateJudgeDecision(redTotal, blueTotal, allRoundsCompleted) {
465|            const decisionElement = safeGetElement('judgeDecision');
466|            if (!decisionElement) return;
467|            
468|            const redName = app.data.fighters.red || 'Tireur rouge';
469|            const blueName = app.data.fighters.blue || 'Tireur bleu';
470|            
471|            // Ne pas afficher de r√©sultat tant que toutes les reprises ne sont pas compl√©t√©es
472|            if (!allRoundsCompleted && !abandons.red && !abandons.blue) {
473|                decisionElement.textContent = 'En cours... (toutes les reprises doivent √™tre not√©es)';
474|                decisionElement.style.color = '#6c757d';
475|                return;
476|            }
477|            
478|            // Si abandon, la d√©cision a d√©j√† √©t√© mise √† jour
479|            if (abandons.red || abandons.blue) {
480|                return;
481|            }
482|            
483|            // V√©rifier l'√©galit√©
484|            if (redTotal === blueTotal) {
485|                decisionElement.textContent = '√âGALIT√â INTERDITE - Attribuer un bonus !';
486|                decisionElement.style.color = '#ffc107';
487|                return;
488|            }
489|            
490|            // Afficher la d√©cision finale
491|            if (redTotal > blueTotal) {
492|                decisionElement.textContent = `VICTOIRE COIN ROUGE - ${redName}`;
493|                decisionElement.style.color = '#dc3545';
494|            } else if (blueTotal > redTotal) {
495|                decisionElement.textContent = `VICTOIRE COIN BLEU - ${blueName}`;
496|                decisionElement.style.color = '#007bff';
497|            }
498|        }
499|
500|        function areAllJudgeRoundsCompleted() {
501|            if (abandons.red || abandons.blue) {
502|                return true;
503|            }
504|            
505|            for (let i = 1; i <= activeRounds; i++) {
506|                const redValue = safeGetElement(`judgeRed${i}`)?.value;
507|                const blueValue = safeGetElement(`judgeBlue${i}`)?.value;
508|                if (!redValue || !blueValue) {
509|                    return false;
510|                }
511|            }
512|            return true;
513|        }
514|
515|        function isJudgeRoundComplete(round) {
516|            const redValue = safeGetElement(`judgeRed${round}`)?.value;
517|            const blueValue = safeGetElement(`judgeBlue${round}`)?.value;
518|            return redValue !== '' && blueValue !== '';
519|        }
520|
521|        function lockJudgeCompletedRounds() {
522|            for (let i = 1; i <= activeRounds; i++) {
523|                if (isJudgeRoundComplete(i)) {
524|                    const redSelect = safeGetElement(`judgeRed${i}`);
525|                    const blueSelect = safeGetElement(`judgeBlue${i}`);
526|                    
527|                    if (redSelect && blueSelect) {
528|                        redSelect.disabled = true;
529|                        redSelect.classList.add('locked');
530|                        blueSelect.disabled = true;
531|                        blueSelect.classList.add('locked');
532|                    }
533|                }
534|            }
535|        }
536|
537|        function unlockAllJudgeRounds() {
538|            for (let i = 1; i <= 5; i++) {
539|                const redSelect = safeGetElement(`judgeRed${i}`);
540|                const blueSelect = safeGetElement(`judgeBlue${i}`);
541|                if (redSelect && blueSelect) {
542|                    redSelect.disabled = false;
543|                    redSelect.classList.remove('locked');
544|                    blueSelect.disabled = false;
545|                    blueSelect.classList.remove('locked');
546|                }
547|            }
548|        }
549|
550|        function undoLastJudgeAction() {
551|            if (actionHistory.length === 0) {
552|                showNotification('‚ùå Aucune action √† annuler', 'warning');
553|                return;
554|            }
555|            
556|            const previousState = actionHistory.pop();
557|            
558|            // Restaurer les avertissements et comptes
559|            Object.assign(warnings, previousState.warnings);
560|            Object.assign(comptes, previousState.comptes);
561|            
562|            // Restaurer les abandons
563|            Object.assign(abandons, previousState.abandons);
564|            
565|            // Restaurer l'interface des abandons
566|            ['red', 'blue'].forEach(color => {
567|                const button = safeGetElement(`judgeAbandon${color.charAt(0).toUpperCase() + color.slice(1)}`);
568|                if (button) {
569|                    if (abandons[color]) {
570|                        button.textContent = 'ABANDONN√â';
571|                        button.classList.add('abandoned');
572|                    } else {
573|                        button.textContent = 'ABANDON';
574|                        button.classList.remove('abandoned');
575|                    }
576|                }
577|            });
578|            
579|            // D√©verrouiller tous les selects existants
580|            unlockAllJudgeRounds();
581|            
582|            // Restaurer l'affichage des avertissements et comptes
583|            for (let color of ['red', 'blue']) {
584|                for (let i = 1; i <= 5; i++) {
585|                    updateJudgeWarningDisplay(color, i);
586|                    updateJudgeCompteDisplay(color, i);
587|                }
588|            }
589|            
590|            // Restaurer les scores
591|            for (let key in previousState.scores) {
592|                const element = safeGetElement(`judge${key.charAt(0).toUpperCase() + key.slice(1)}`);
593|                if (element) element.value = previousState.scores[key];
594|            }
595|            
596|            // Restaurer les bonus
597|            const redBonus = safeGetElement('judgeRedBonus');
598|            const blueBonus = safeGetElement('judgeBlueBonus');
599|            if (redBonus) redBonus.value = previousState.bonus.red;
600|            if (blueBonus) blueBonus.value = previousState.bonus.blue;
601|            
602|            // Recalculer les totaux
603|            calculateJudgeTotals();
604|            
605|            // V√©rifier la disqualification
606|            checkJudgeDisqualification('red');
607|            checkJudgeDisqualification('blue');
608|            
609|            // Re-verrouiller les reprises compl√®tes apr√®s restauration
610|            lockJudgeCompletedRounds();
611|            
612|            // D√©sactiver le bouton si plus d'historique
613|            if (actionHistory.length === 0) {
614|                const undoButton = safeGetElement('judgeUndoButton');
615|                if (undoButton) undoButton.disabled = true;
616|            }
617|            
618|            showNotification('‚Ü∂ Derni√®re action annul√©e', 'info');
619|        }
620|
621|        function resetJudgeFormData() {
622|            try {
623|                // 1. R√©initialiser les donn√©es CPTE
624|                for (let color of ['red', 'blue']) {
625|                    warnings[color] = {};
626|                    comptes[color] = {};
627|                }
628|                abandons.red = false;
629|                abandons.blue = false;
630|                
631|                // 2. R√©initialiser l'historique
632|                actionHistory = [];
633|                const undoButton = safeGetElement('judgeUndoButton');
634|                if (undoButton) undoButton.disabled = true;
635|                
636|                // 3. D√©verrouiller tous les selects
637|                unlockAllJudgeRounds();
638|                
639|                // 4. R√©initialiser tous les selects de scores
640|                for (let i = 1; i <= 5; i++) {
641|                    const redSelect = safeGetElement(`judgeRed${i}`);
642|                    const blueSelect = safeGetElement(`judgeBlue${i}`);
643|                    if (redSelect) {
644|                        redSelect.value = '';
645|                        redSelect.disabled = false;
646|                        redSelect.classList.remove('locked');
647|                    }
648|                    if (blueSelect) {
649|                        blueSelect.value = '';
650|                        blueSelect.disabled = false;
651|                        blueSelect.classList.remove('locked');
652|                    }
653|                }
654|                
655|                // 5. R√©initialiser les inputs bonus
656|                const redBonus = safeGetElement('judgeRedBonus');
657|                const blueBonus = safeGetElement('judgeBlueBonus');
658|                if (redBonus) {
659|                    redBonus.value = '0';
660|                    redBonus.disabled = false;
661|                    redBonus.classList.remove('error', 'bonus-required');
662|                }
663|                if (blueBonus) {
664|                    blueBonus.value = '0';
665|                    blueBonus.disabled = false;
666|                    blueBonus.classList.remove('error', 'bonus-required');
667|                }
668|                
669|                // 6. R√©initialiser tous les totaux
670|                const totalElements = [
671|                    'judgeRedSubtotal1', 'judgeBlueSubtotal1', 'judgeRedWarnings', 'judgeBlueWarnings',
672|                    'judgeRedSubtotal2', 'judgeBlueSubtotal2', 'judgeRedTotal', 'judgeBlueTotal',
673|                    'judgeRedComptes', 'judgeBlueComptes'
674|                ];
675|                totalElements.forEach(id => {
676|                    const element = safeGetElement(id);
677|                    if (element) element.textContent = '0';
678|                });
679|                
680|                // 7. R√©initialiser la d√©cision
681|                const decision = safeGetElement('judgeDecision');
682|                if (decision) {
683|                    decision.textContent = '-';
684|                    decision.style.color = '#000';
685|                }
686|                
687|                // 8. R√©initialiser les boutons d'abandon
688|                const abandonRed = safeGetElement('judgeAbandonRed');
689|                const abandonBlue = safeGetElement('judgeAbandonBlue');
690|                
691|                if (abandonRed) {
692|                    abandonRed.textContent = 'ABANDON';
693|                    abandonRed.classList.remove('abandoned');
694|                }
695|                if (abandonBlue) {
696|                    abandonBlue.textContent = 'ABANDON';
697|                    abandonBlue.classList.remove('abandoned');
698|                }
699|                
700|                // 9. R√©initialiser l'affichage des avertissements et comptes
701|

Action: file_editor view /app/SAVATE-PART-08
Observation: /app/SAVATE-PART-08:
1|                for (let color of ['red', 'blue']) {
2|                    for (let i = 1; i <= 5; i++) {
3|                        updateJudgeWarningDisplay(color, i);
4|                        updateJudgeCompteDisplay(color, i);
5|                    }
6|                }
7|                
8|                // 10. Cacher tous les messages d'alerte
9|                const messages = ['judgeDisqualificationMessage', 'judgeAbandonMessage', 'judgeEqualityWarning'];
10|                messages.forEach(id => {
11|                    const element = safeGetElement(id);
12|                    if (element) element.style.display = 'none';
13|                });
14|                
15|                // 11. R√©activer tous les contr√¥les
16|                document.querySelectorAll('.score-select').forEach(select => {
17|                    select.disabled = false;
18|                    select.classList.remove('locked');
19|                });
20|                document.querySelectorAll('.score-input').forEach(input => {
21|                    input.disabled = false;
22|                });
23|                document.querySelectorAll('.warning-cell').forEach(cell => {
24|                    cell.style.pointerEvents = 'auto';
25|                });
26|                document.querySelectorAll('.compte-cell').forEach(cell => {
27|                    cell.style.pointerEvents = 'auto';
28|                });
29|                
30|                // 12. Synchroniser la r√©initialisation
31|                syncJudgeData('delegate_reset_applied');
32|                
33|            } catch (error) {
34|                console.error('Erreur lors de la r√©initialisation:', error);
35|                showNotification('‚ùå Erreur lors de la r√©initialisation.', 'error');
36|            }
37|        }
38|
39|        function resetJudgeConnection() {
40|            // Fermer toutes les connexions WebRTC
41|            if (app.webrtc.peer) {
42|                app.webrtc.peer.destroy();
43|            }
44|            
45|            // R√©initialiser les variables de session (garder les infos personnelles pour faciliter la reconnexion)
46|            const savedJudgeName = app.session.judgeName;
47|            const savedJudgeNumber = app.session.judgeNumber;
48|            
49|            app.webrtc = {
50|                peer: null,
51|                connections: new Map(),
52|                isHost: false,
53|                peerId: null,
54|                lastSyncTime: Date.now(),
55|                syncCount: 0,
56|                syncErrors: 0,
57|                reconnectAttempts: 0,
58|                maxReconnectAttempts: 5,
59|                connectionQuality: 'excellent',
60|                latency: 0
61|            };
62|            
63|            app.session = {
64|                id: '',
65|                code: '',
66|                fightType: 'assaut',
67|                judgeCount: 3,
68|                rounds: 3,
69|                initialized: false,
70|                role: '',
71|                judgeId: null,
72|                judgeName: savedJudgeName, // Garder le nom pour faciliter la reconnexion
73|                judgeNumber: savedJudgeNumber, // Garder le num√©ro
74|                deviceId: 'device_' + Math.random().toString(36).substr(2, 9),
75|                startTime: null,
76|                status: 'inactive'
77|            };
78|            
79|            // R√©initialiser les donn√©es CPTE
80|            Object.assign(warnings, { red: {}, blue: {} });
81|            Object.assign(comptes, { red: {}, blue: {} });
82|            Object.assign(abandons, { red: false, blue: false });
83|            actionHistory = [];
84|            activeRounds = 3;
85|            
86|            // Retourner √† l'√©cran de s√©lection juge avec les champs pr√©-remplis
87|            document.getElementById('judgeInterface').classList.add('hidden');
88|            document.getElementById('judgeAccessSection').classList.remove('hidden');
89|            document.getElementById('syncIndicator').classList.add('hidden');
90|            
91|            // Pr√©-remplir les champs avec les donn√©es sauvegard√©es
92|            if (savedJudgeName) {
93|                document.getElementById('judgeNameInput').value = savedJudgeName;
94|            }
95|            if (savedJudgeNumber) {
96|                document.getElementById('judgeNumberInput').value = savedJudgeNumber;
97|            }
98|            
99|            showNotification('üö™ Vous √™tes maintenant d√©connect√©. Entrez un code de session pour vous reconnecter.', 'info');
100|        }
101|
102|        // =====================
103|        // SYNCHRONISATION WEBRTC JUGE
104|        // =====================
105|
106|        function syncJudgeData(actionType = 'general_sync', focusData = null) {
107|            if (app.session.role !== 'judge' || !app.webrtc.connections.size) {
108|                console.warn('‚ö†Ô∏è Pas de connexion WebRTC pour synchroniser');
109|                return;
110|            }
111|            
112|            // Construire les donn√©es compl√®tes de juge
113|            const judgeScores = {};
114|            for (let i = 1; i <= activeRounds; i++) {
115|                const redValue = parseInt(safeGetElement(`judgeRed${i}`)?.value) || 0;
116|                const blueValue = parseInt(safeGetElement(`judgeBlue${i}`)?.value) || 0;
117|                judgeScores[i] = { red: redValue, blue: blueValue };
118|            }
119|            
120|            const redBonusValue = parseInt(safeGetElement('judgeRedBonus')?.value) || 0;
121|            const blueBonusValue = parseInt(safeGetElement('judgeBlueBonus')?.value) || 0;
122|            
123|            // Calculer les totaux pour l'affichage d√©l√©gu√©
124|            let redSubtotal1 = 0, blueSubtotal1 = 0;
125|            for (let i = 1; i <= activeRounds; i++) {
126|                redSubtotal1 += judgeScores[i].red || 0;
127|                blueSubtotal1 += judgeScores[i].blue || 0;
128|            }
129|            
130|            let redWarningTotal = 0, blueWarningTotal = 0;
131|            for (let round in warnings.red) {
132|                if (round <= activeRounds) {
133|                    redWarningTotal += warnings.red[round] || 0;
134|                }
135|            }
136|            for (let round in warnings.blue) {
137|                if (round <= activeRounds) {
138|                    blueWarningTotal += warnings.blue[round] || 0;
139|                }
140|            }
141|            
142|            let redCompteTotal = 0, blueCompteTotal = 0;
143|            if (isCombat()) {
144|                for (let round in comptes.red) {
145|                    if (round <= activeRounds) {
146|                        redCompteTotal += comptes.red[round] || 0;
147|                    }
148|                }
149|                for (let round in comptes.blue) {
150|                    if (round <= activeRounds) {
151|                        blueCompteTotal += comptes.blue[round] || 0;
152|                    }
153|                }
154|            }
155|            
156|            const redSubtotal2 = redSubtotal1 - redWarningTotal - redCompteTotal;
157|            const blueSubtotal2 = blueSubtotal1 - blueWarningTotal - blueCompteTotal;
158|            const redTotal = redSubtotal2 + redBonusValue;
159|            const blueTotal = blueSubtotal2 + blueBonusValue;
160|            
161|            // D√©terminer le r√©sultat
162|            let result = 'En cours...';
163|            if (abandons.red && !abandons.blue) {
164|                result = `Victoire BLEU par abandon`;
165|            } else if (abandons.blue && !abandons.red) {
166|                result = `Victoire ROUGE par abandon`;
167|            } else if (abandons.red && abandons.blue) {
168|                result = `Double abandon`;
169|            } else if (areAllJudgeRoundsCompleted()) {
170|                if (redTotal > blueTotal) {
171|                    result = `Victoire ROUGE (${redTotal} - ${blueTotal})`;
172|                } else if (blueTotal > redTotal) {
173|                    result = `Victoire BLEU (${blueTotal} - ${redTotal})`;
174|                } else {
175|                    result = `√âgalit√© (${redTotal} - ${blueTotal})`;
176|                }
177|            }
178|            
179|            const syncData = {
180|                judgeId: app.session.judgeId,
181|                name: app.session.judgeName,
182|                number: app.session.judgeNumber,
183|                scores: judgeScores,
184|                warnings: warnings,
185|                comptes: comptes,
186|                abandons: abandons,
187|                bonuses: { red: redBonusValue, blue: blueBonusValue },
188|                totalRed: redTotal,
189|                totalBlue: blueTotal,
190|                result: result,
191|                lastAction: actionType,
192|                focusRound: focusData ? focusData.round : null,
193|                focusData: focusData,
194|                timestamp: Date.now(),
195|                connected: true
196|            };
197|            
198|            const syncResult = sendToAll({
199|                type: 'judge_data',
200|                data: syncData
201|            }, 'high');
202|            
203|            console.log('üì° Donn√©es juge synchronis√©es:', syncData);
204|            showNotification(`üì° Synchronisation ${actionType} envoy√©e (${syncResult.sent} connexions)`, 'success', 2000);
205|            
206|            return syncResult;
207|        }
208|
209|        // =====================
210|        // EXPORT JUGE
211|        // =====================
212|        
213|        function exportJudgeToExcel() {
214|            try {
215|                // Cr√©er un tableau de donn√©es
216|                const data = [];
217|                
218|                // En-t√™te
219|                data.push(['FICHE DE JUGE - SAVATE BOXE FRAN√áAISE']);
220|                data.push([]);
221|                
222|                // Type de rencontre
223|                const fightType = getFightTypeLabel(app.session.fightType);
224|                data.push(['Type de rencontre:', fightType]);
225|                data.push([]);
226|                
227|                // Informations du juge
228|                data.push(['Juge:', app.session.judgeName || 'Non renseign√©']);
229|                data.push(['N¬∞ Juge:', app.session.judgeNumber || 'Non renseign√©']);
230|                data.push([]);
231|                
232|                // Informations des tireurs
233|                data.push(['TIREUR COIN ROUGE:', app.data.fighters.red || 'Non renseign√©']);
234|                data.push(['TIREUR COIN BLEU:', app.data.fighters.blue || 'Non renseign√©']);
235|                data.push([]);
236|                
237|                // Statut d'abandon
238|                if (abandons.red) data.push(['ABANDON COIN ROUGE']);
239|                if (abandons.blue) data.push(['ABANDON COIN BLEU']);
240|                if (abandons.red || abandons.blue) data.push([]);
241|                
242|                // Tableau des scores
243|                if (isCombat()) {
244|                    data.push(['', 'COIN ROUGE', '', '', '', 'COIN BLEU', '', '', '']);
245|                    data.push(['Reprise', 'Reprise', 'NOTE', 'AVT', 'CPTE', 'Reprise', 'NOTE', 'AVT', 'CPTE']);
246|                } else {
247|                    data.push(['', 'COIN ROUGE', '', '', 'COIN BLEU', '', '']);
248|                    data.push(['Reprise', 'Reprise', 'NOTE', 'AVT', 'Reprise', 'NOTE', 'AVT']);
249|                }
250|                
251|                // Scores par reprise
252|                for (let i = 1; i <= activeRounds; i++) {
253|                    const redScore = safeGetElement(`judgeRed${i}`)?.value || '-';
254|                    const blueScore = safeGetElement(`judgeBlue${i}`)?.value || '-';
255|                    const redAvt = warnings.red[i] ? 'A'.repeat(warnings.red[i]) : '';
256|                    const blueAvt = warnings.blue[i] ? 'A'.repeat(warnings.blue[i]) : '';
257|                    
258|                    if (isCombat()) {
259|                        const redCpte = comptes.red[i] ? 'C'.repeat(comptes.red[i]) : '';
260|                        const blueCpte = comptes.blue[i] ? 'C'.repeat(comptes.blue[i]) : '';
261|                        data.push([`Reprise ${i}`, i, redScore, redAvt, redCpte, i, blueScore, blueAvt, blueCpte]);
262|                    } else {
263|                        data.push([`Reprise ${i}`, i, redScore, redAvt, i, blueScore, blueAvt]);
264|                    }
265|                }
266|                
267|                data.push([]);
268|                
269|                // Totaux
270|                if (isCombat()) {
271|                    data.push(['Sous TOTAUX 1', '', safeGetElement('judgeRedSubtotal1')?.textContent || '0', '', '', '', safeGetElement('judgeBlueSubtotal1')?.textContent || '0', '', '']);
272|                    data.push(['Avertissements', '', safeGetElement('judgeRedWarnings')?.textContent || '0', '', '', '', safeGetElement('judgeBlueWarnings')?.textContent || '0', '', '']);
273|                    data.push(['Compte', '', safeGetElement('judgeRedComptes')?.textContent || '0', '', '', '', safeGetElement('judgeBlueComptes')?.textContent || '0', '', '']);
274|                    data.push(['Sous TOTAUX 2', '', safeGetElement('judgeRedSubtotal2')?.textContent || '0', '', '', '', safeGetElement('judgeBlueSubtotal2')?.textContent || '0', '', '']);
275|                    data.push(['Bonus', '', safeGetElement('judgeRedBonus')?.value || '0', '', '', '', safeGetElement('judgeBlueBonus')?.value || '0', '', '']);
276|                    data.push(['TOTAUX', '', safeGetElement('judgeRedTotal')?.textContent || '0', '', '', '', safeGetElement('judgeBlueTotal')?.textContent || '0', '', '']);
277|                } else {
278|                    data.push(['Sous TOTAUX 1', '', safeGetElement('judgeRedSubtotal1')?.textContent || '0', '', '', safeGetElement('judgeBlueSubtotal1')?.textContent || '0', '']);
279|                    data.push(['Avertissements', '', safeGetElement('judgeRedWarnings')?.textContent || '0', '', '', safeGetElement('judgeBlueWarnings')?.textContent || '0', '']);
280|                    data.push(['Sous TOTAUX 2', '', safeGetElement('judgeRedSubtotal2')?.textContent || '0', '', '', safeGetElement('judgeBlueSubtotal2')?.textContent || '0', '']);
281|                    data.push(['Bonus', '', safeGetElement('judgeRedBonus')?.value || '0', '', '', safeGetElement('judgeBlueBonus')?.value || '0', '']);
282|                    data.push(['TOTAUX', '', safeGetElement('judgeRedTotal')?.textContent || '0', '', '', safeGetElement('judgeBlueTotal')?.textContent || '0', '']);
283|                }
284|                
285|                data.push([]);
286|                data.push(['D√âCISION:', safeGetElement('judgeDecision')?.textContent || '-']);
287|                
288|                downloadCSV(data, `fiche_juge_${app.session.judgeId}_${formatDate(Date.now())}.csv`);
289|                showNotification('üìä Export Excel r√©alis√© avec succ√®s!', 'success');
290|                
291|            } catch (error) {
292|                console.error('Erreur lors de l\'export Excel:', error);
293|                showNotification('‚ùå Erreur lors de l\'export Excel.', 'error');
294|            }
295|        }
296|
297|        function exportJudgeToMarkdown() {
298|            try {
299|                let markdown = '# FICHE DE JUGE - SAVATE BOXE FRAN√áAISE\n\n';
300|                
301|                // Type de rencontre
302|                const fightType = getFightTypeLabel(app.session.fightType);
303|                markdown += `## ${fightType}\n\n`;
304|                
305|                // Informations du juge
306|                markdown += '### Informations du juge\n';
307|                markdown += `- **Nom:** ${app.session.judgeName || 'Non renseign√©'}\n`;
308|                markdown += `- **N¬∞ Juge:** ${app.session.judgeNumber || 'Non renseign√©'}\n\n`;
309|                
310|                // Informations des tireurs
311|                markdown += '### Tireurs\n';
312|                markdown += `- **COIN ROUGE:** ${app.data.fighters.red || 'Non renseign√©'}`;
313|                if (abandons.red) markdown += ' *(ABANDON)*';
314|                markdown += '\n';
315|                markdown += `- **COIN BLEU:** ${app.data.fighters.blue || 'Non renseign√©'}`;
316|                if (abandons.blue) markdown += ' *(ABANDON)*';
317|                markdown += '\n\n';
318|                
319|                // Tableau des scores
320|                markdown += '### Scores par reprise\n\n';
321|                if (isCombat()) {
322|                    markdown += '| Reprise | Coin Rouge | Avertissements | Comptes | Coin Bleu | Avertissements | Comptes |\n';
323|                    markdown += '|---------|------------|----------------|---------|-----------|----------------|----------|\n';
324|                } else {
325|                    markdown += '| Reprise | Coin Rouge | Avertissements | Coin Bleu | Avertissements |\n';
326|                    markdown += '|---------|------------|----------------|-----------|----------------|\n';
327|                }
328|                
329|                for (let i = 1; i <= activeRounds; i++) {
330|                    const redScore = safeGetElement(`judgeRed${i}`)?.value || '-';
331|                    const blueScore = safeGetElement(`judgeBlue${i}`)?.value || '-';
332|                    const redAvt = warnings.red[i] ? 'A'.repeat(warnings.red[i]) : '-';
333|                    const blueAvt = warnings.blue[i] ? 'A'.repeat(warnings.blue[i]) : '-';
334|                    
335|                    if (isCombat()) {
336|                        const redCpte = comptes.red[i] ? 'C'.repeat(comptes.red[i]) : '-';
337|                        const blueCpte = comptes.blue[i] ? 'C'.repeat(comptes.blue[i]) : '-';
338|                        markdown += `| ${i} | ${redScore} | ${redAvt} | ${redCpte} | ${blueScore} | ${blueAvt} | ${blueCpte} |\n`;
339|                    } else {
340|                        markdown += `| ${i} | ${redScore} | ${redAvt} | ${blueScore} | ${blueAvt} |\n`;
341|                    }
342|                }
343|                
344|                markdown += '\n### R√©capitulatif\n\n';
345|                markdown += '| | Coin Rouge | Coin Bleu |\n';
346|                markdown += '|---|------------|------------|\n';
347|                markdown += `| **Sous TOTAUX 1** | ${safeGetElement('judgeRedSubtotal1')?.textContent || '0'} | ${safeGetElement('judgeBlueSubtotal1')?.textContent || '0'} |\n`;
348|                markdown += `| **Avertissements** | ${safeGetElement('judgeRedWarnings')?.textContent || '0'} | ${safeGetElement('judgeBlueWarnings')?.textContent || '0'} |\n`;
349|                
350|                if (isCombat()) {
351|                    markdown += `| **Compte** | ${safeGetElement('judgeRedComptes')?.textContent || '0'} | ${safeGetElement('judgeBlueComptes')?.textContent || '0'} |\n`;
352|                }
353|                
354|                markdown += `| **Sous TOTAUX 2** | ${safeGetElement('judgeRedSubtotal2')?.textContent || '0'} | ${safeGetElement('judgeBlueSubtotal2')?.textContent || '0'} |\n`;
355|                markdown += `| **Bonus** | ${safeGetElement('judgeRedBonus')?.value || '0'} | ${safeGetElement('judgeBlueBonus')?.value || '0'} |\n`;
356|                markdown += `| **TOTAUX** | ${safeGetElement('judgeRedTotal')?.textContent || '0'} | ${safeGetElement('judgeBlueTotal')?.textContent || '0'} |\n`;
357|                
358|                markdown += `\n### D√âCISION\n\n**${safeGetElement('judgeDecision')?.textContent || '-'}**\n`;
359|                
360|                markdown += `\n---\n_Export√© le ${new Date().toLocaleString('fr-FR')}_`;
361|                
362|                downloadText(markdown, `fiche_juge_${app.session.judgeId}_${formatDate(Date.now())}.md`);
363|                showNotification('üìù Export Markdown r√©alis√© avec succ√®s!', 'success');
364|                
365|            } catch (error) {
366|                console.error('Erreur lors de l\'export Markdown:', error);
367|                showNotification('‚ùå Erreur lors de l\'export Markdown.', 'error');
368|            }
369|        }
370|
371|        // =====================
372|        // UTILITAIRES D'EXPORT
373|        // =====================
374|        
375|        function downloadCSV(data, filename) {
376|            let csv = '';
377|            data.forEach(row => {
378|                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
379|            });
380|            
381|            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
382|            const link = document.createElement('a');
383|            const url = URL.createObjectURL(blob);
384|            link.setAttribute('href', url);
385|            link.setAttribute('download', filename);
386|            link.style.visibility = 'hidden';
387|            document.body.appendChild(link);
388|            link.click();
389|            document.body.removeChild(link);
390|            URL.revokeObjectURL(url);
391|        }
392|        
393|        function downloadText(text, filename) {
394|            const blob = new Blob([text], { type: 'text/plain;charset=utf-8;' });
395|            const link = document.createElement('a');
396|            const url = URL.createObjectURL(blob);
397|            link.setAttribute('href', url);
398|            link.setAttribute('download', filename);
399|            link.style.visibility = 'hidden';
400|            document.body.appendChild(link);
401|            link.click();
402|            document.body.removeChild(link);
403|            URL.revokeObjectURL(url);
404|        }
405|        
406|        function downloadJSON(data, filename) {
407|            const jsonString = JSON.stringify(data, null, 2);
408|            const blob = new Blob([jsonString], { type: 'application/json' });
409|            const link = document.createElement('a');
410|            const url = URL.createObjectURL(blob);
411|            link.setAttribute('href', url);
412|            link.setAttribute('download', filename);
413|            link.style.visibility = 'hidden';
414|            document.body.appendChild(link);
415|            link.click();
416|            document.body.removeChild(link);
417|            URL.revokeObjectURL(url);
418|        }
419|
420|        // =====================
421|        // FONCTIONS DE R√âINITIALISATION AVANC√âES
422|        // =====================
423|
424|        // Fonctions pour le d√©l√©gu√©
425|        function showResetOptions() {
426|            const modal = document.getElementById('resetModal');
427|            if (modal) {
428|                modal.classList.remove('hidden');
429|                document.body.style.overflow = 'hidden';
430|            }
431|        }
432|
433|        function closeResetModal() {
434|            const modal = document.getElementById('resetModal');
435|            if (modal) {
436|                modal.classList.add('hidden');
437|                document.body.style.overflow = 'auto';
438|            }
439|        }
440|
441|        function performPartialReset() {
442|            if (!confirm('‚ö†Ô∏è Confirmer la r√©initialisation partielle ?\n\nTous les scores seront effac√©s mais la session et les juges connect√©s seront conserv√©s.')) {
443|                return;
444|            }
445|
446|            console.log('üîÑ R√©initialisation partielle en cours...');
447|            
448|            // Sauvegarder l'√©tat avant la r√©initialisation
449|            saveDelegateState('R√âINITIALISATION PARTIELLE', {
450|                fightersReset: true,
451|                judgesDataReset: true,
452|                sessionPreserved: true
453|            });
454|            
455|            // R√©initialiser les noms des tireurs
456|            app.data.fighters = { red: '', blue: '' };
457|            document.getElementById('fighterRedName').value = '';
458|            document.getElementById('fighterBlueName').value = '';
459|            
460|            // R√©initialiser les donn√©es de tous les juges (scores, warnings, comptes, etc.)
461|            Object.keys(app.data.judges).forEach(judgeKey => {
462|                const judge = app.data.judges[judgeKey];
463|                // Conserver les infos de connexion et personnelles
464|                const preservedData = {
465|                    id: judge.id,
466|                    name: judge.name,
467|                    number: judge.number,
468|                    connected: judge.connected,
469|                    peerId: judge.peerId,
470|                    connectionTime: judge.connectionTime
471|                };
472|                
473|                // R√©initialiser tout le reste
474|                app.data.judges[judgeKey] = {
475|                    ...preservedData,
476|                    scores: {},
477|                    warnings: { red: {}, blue: {} },
478|                    comptes: { red: {}, blue: {} },
479|                    abandons: { red: false, blue: false },
480|                    bonuses: { red: 0, blue: 0 },
481|                    totalRed: 0,
482|                    totalBlue: 0,
483|                    result: 'En attente...',
484|                    lastUpdate: Date.now()
485|                };
486|            });
487|
488|            // R√©initialiser les r√©sultats finaux
489|            app.data.results = null;
490|
491|            // Envoyer la commande de r√©initialisation partielle √† tous les juges
492|            sendToAll({
493|                type: 'partial_reset_command',
494|                data: {
495|                    fighters: app.data.fighters,
496|                    timestamp: Date.now()
497|                }
498|            }, 'high');
499|
500|            // Mettre √† jour l'interface d√©l√©gu√©
501|            updateJudgeMonitoring();
502|            updateRecapTable();
503|            updateFinalResult();
504|
505|            closeResetModal();
506|            showNotification('‚úÖ R√©initialisation partielle effectu√©e avec succ√®s!', 'success');
507|            
508|            console.log('‚úÖ R√©initialisation partielle termin√©e');
509|        }
510|
511|        function performCompleteReset() {
512|            if (!confirm('‚ö†Ô∏è ATTENTION: R√©initialisation compl√®te !\n\nToutes les connexions seront ferm√©es et une nouvelle session sera cr√©√©e.\nTous les juges devront se reconnecter.\n\n√ätes-vous certain ?')) {
513|                return;
514|            }
515|
516|            console.log('üî• R√©initialisation compl√®te en cours...');
517|            
518|            // Sauvegarder l'√©tat avant la r√©initialisation compl√®te
519|            saveDelegateState('R√âINITIALISATION COMPL√àTE', {
520|                fullReset: true,
521|                connectionsReset: true,
522|                newSessionRequired: true
523|            });
524|            
525|            // Envoyer notification de fermeture aux juges
526|            sendToAll({
527|                type: 'session_reset_complete',
528|                data: {
529|                    message: 'Session r√©initialis√©e par le d√©l√©gu√©',
530|                    timestamp: Date.now()
531|                }
532|            }, 'critical');
533|
534|            // Attendre un peu que le message soit envoy√©
535|            setTimeout(() => {
536|                resetApplication();
537|            }, 1000);
538|
539|            closeResetModal();
540|            showNotification('üî• R√©initialisation compl√®te en cours...', 'warning');
541|        }
542|
543|        // Fermer les modales en cliquant √† l'ext√©rieur
544|        document.addEventListener('click', function(event) {
545|            const resetModal = document.getElementById('resetModal');
546|            
547|            if (resetModal && event.target === resetModal) {
548|                closeResetModal();
549|            }
550|        });
551|
552|        // =====================
553|        // R√âINITIALISATION COMPL√àTE
554|        // =====================
555|        
556|        function resetApplication() {
557|            if (!confirm('‚ö†Ô∏è Voulez-vous vraiment r√©initialiser l\'application compl√®te ?')) {
558|                return;
559|            }
560|            
561|            // Fermer toutes les connexions WebRTC
562|            if (app.webrtc.peer) {
563|                app.webrtc.peer.destroy();
564|            }
565|            
566|            // R√©initialiser toutes les variables
567|            app = {
568|                version: '4.2.0',
569|                webrtc: {
570|                    peer: null,
571|                    connections: new Map(),
572|                    isHost: false,
573|                    peerId: null,
574|                    lastSyncTime: Date.now(),
575|                    syncCount: 0,
576|                    syncErrors: 0,
577|                    reconnectAttempts: 0,
578|                    maxReconnectAttempts: 5,
579|                    connectionQuality: 'excellent',
580|                    latency: 0
581|                },
582|                session: {
583|                    id: '',
584|                    code: '',
585|                    fightType: 'assaut',
586|                    judgeCount: 3,
587|                    rounds: 3,
588|                    initialized: false,
589|                    role: '',
590|                    judgeId: null,
591|                    judgeName: '',
592|                    judgeNumber: '',
593|                    deviceId: 'device_' + Math.random().toString(36).substr(2, 9),
594|                    startTime: null,
595|                    status: 'inactive'
596|                },
597|                data: {
598|                    judges: {},
599|                    fighters: { red: '', blue: '' },
600|                    connectedDevices: new Set(),
601|                    changeLog: [],
602|                    results: null
603|                },
604|                monitoring: {
605|                    syncMetrics: {
606|                        totalSync: 0,
607|                        syncErrors: 0,
608|                        uptimeStart: Date.now()
609|                    }
610|                }
611|            };
612|            
613|            // R√©initialiser les donn√©es CPTE
614|            Object.assign(warnings, { red: {}, blue: {} });
615|            Object.assign(comptes, { red: {}, blue: {} });
616|            Object.assign(abandons, { red: false, blue: false });
617|            actionHistory = [];
618|            delegateActionHistory = []; // R√©initialiser l'historique d√©l√©gu√©
619|            activeRounds = 3;
620|            
621|            // R√©initialiser l'interface
622|            document.querySelectorAll('.hidden').forEach(el => el.classList.add('hidden'));
623|            document.getElementById('roleSelector').classList.remove('hidden');
624|            document.getElementById('contentArea').style.display = 'block';
625|            document.getElementById('syncIndicator').classList.add('hidden');
626|            
627|            // Fermer les modales si ouvertes
628|            closeResetModal();
629|            document.body.style.overflow = 'auto';
630|            
631|            // D√©sactiver le bouton d'annulation du d√©l√©gu√©
632|            const delegateUndoButton = document.getElementById('delegateUndoButton');
633|            if (delegateUndoButton) {
634|                delegateUndoButton.disabled = true;
635|                delegateUndoButton.textContent = '‚Ü∂ ANNULER DERNI√àRE ACTION';
636|            }
637|            
638|            // Nettoyer les notifications
639|            document.querySelectorAll('.message').forEach(el => el.remove());
640|            
641|            showNotification('üîÑ Application r√©initialis√©e compl√®tement', 'success');
642|            
643|            console.log('üî• R√©initialisation compl√®te termin√©e');
644|        }
645|
646|        // =====================
647|        // INITIALISATION FINALE
648|        // =====================
649|
650|        // Initialisation au chargement de la page
651|        document.addEventListener('DOMContentLoaded', function() {
652|            console.log('üì± DOM charg√© - Interface CPTE pr√™te');
653|            
654|            // V√©rifier PeerJS
655|            waitForPeerJS().then(() => {
656|                console.log('‚úÖ PeerJS disponible');
657|            }).catch(error => {
658|                console.warn('‚ö†Ô∏è PeerJS non disponible:', error);
659|                showNotification('‚ö†Ô∏è Fonctions WebRTC limit√©es - PeerJS non charg√©', 'warning');
660|            });
661|        });
662|
663|        // Fallback si DOMContentLoaded ne fonctionne pas
664|        if (document.readyState === 'loading') {
665|            document.addEventListener('DOMContentLoaded', function() {
666|                console.log('üì± DOM charg√© (fallback) - Interface CPTE pr√™te');
667|            });
668|        } else {
669|            console.log('üì± DOM d√©j√† charg√© - Interface CPTE imm√©diatement disponible');
670|        }
671|
672|        console.log('‚úÖ SAVATE OFFICIALS - Interface CPTE Compl√®te Finalis√©e avec succ√®s');
673|        console.log('üéØ Toutes les fonctionnalit√©s CPTE sont op√©rationnelles');
674|        console.log('üåê Synchronisation WebRTC P2P activ√©e');
675|        console.log('üìä Monitoring d√©l√©gu√© temps r√©el disponible');
676|        console.log('üîß Onglets d√©l√©gu√© complets avec r√©capitulatif et r√©sultats');
677|        console.log('‚Ü∂ Fonction d\'annulation des actions d√©l√©gu√© int√©gr√©e');
678|    
679|    </script>
680|</body>
681|</html>
